<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#c2727e">
<title>Kiki & Jeff Wedding Planner</title>
<link rel="icon" type="image/png" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;0,800;1,400;1,600&family=Quicksand:wght@300;400;500;600;700&family=Great+Vibes&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}

:root{
  --bg:#fff8f6;--bg2:#ffffff;--bg3:#fff0ec;--bg-hover:#ffe8e2;
  --text:#4a2c2a;--text2:#8a6060;--text3:#b89494;
  --pink:#e07088;--pink-deep:#c2556a;--pink-light:#fce4e8;--pink-glow:#ff8fa3;
  --gold:#d4a855;--gold-light:#f5e6c4;
  --cream:#fdf6f0;--blush:#f8d7da;
  --border:#f0d4d4;--shadow:0 4px 20px rgba(200,100,100,.1);
  --done:#8fbf7e;--done-bg:#f0f8ec;
  --danger:#d46a6a;--danger-bg:#fce8e8;
  --radius:16px;--radius-sm:12px;
  --font-script:'Great Vibes',cursive;
  --font-display:'Playfair Display',serif;
  --font-body:'Quicksand',sans-serif;
  --cat-venue:#c27878;--cat-photo:#a87cb2;--cat-floral:#7eaa8e;
  --cat-attire:#c2728e;--cat-guest:#7899b5;--cat-food:#b5a068;--cat-other:#9a8a8a;
  --online:#6ec47e;
}

.dark{
  --bg:#1c1215;--bg2:#281b1f;--bg3:#342228;--bg-hover:#3e2a30;
  --text:#f0dde0;--text2:#c0a0a5;--text3:#8a7075;
  --pink:#e88098;--pink-deep:#d46880;--pink-light:#3a2028;--pink-glow:#ff6080;
  --gold:#e0b860;--gold-light:#3a3020;
  --cream:#2a1e1e;--blush:#3a2228;
  --border:#402830;--shadow:0 4px 24px rgba(0,0,0,.4);
  --done-bg:#243026;--danger-bg:#382020;
  --cat-venue:#e09898;--cat-photo:#c8a0d4;--cat-floral:#80cc9e;
  --cat-attire:#e098b0;--cat-guest:#98b8d4;--cat-food:#d4c080;--cat-other:#b0a0a0;
  --online:#80e090;
}

html{font-size:16px;-webkit-text-size-adjust:100%}

body{
  font-family:var(--font-body);color:var(--text);background:var(--bg);
  min-height:100vh;min-height:100dvh;overflow-x:hidden;
  transition:background .4s,color .4s;
}

::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* ─── Floating Hearts BG ─── */
.hearts-bg{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.float-heart{
  position:absolute;bottom:-40px;
  font-size:1rem;opacity:.12;color:var(--pink);
  animation:floatUp linear infinite;
}
.dark .float-heart{opacity:.06}
@keyframes floatUp{
  0%{transform:translateY(0) rotate(0deg) scale(1);opacity:.12}
  50%{opacity:.18}
  100%{transform:translateY(-110vh) rotate(360deg) scale(.6);opacity:0}
}

/* ═══════════════════════════════════════
   THREE SCREENS: PIN → NAME → APP
   ═══════════════════════════════════════ */
.screen{display:none !important;min-height:100vh;min-height:100dvh}
.screen.active{display:block !important;animation:screenIn .35s ease-out}
#pinScreen.active,#setupScreen.active{display:flex !important}
@keyframes screenIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* ─── Setup Screen ─── */
#pinScreen,#setupScreen{
  position:relative;z-index:1;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:2rem 1.2rem;
}
.setup-card{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);
  padding:2rem 1.5rem;max-width:440px;width:100%;box-shadow:var(--shadow);
  animation:cardIn .5s ease-out;
}
.setup-card h1{
  font-family:var(--font-script);font-size:2.4rem;color:var(--pink-deep);
  text-align:center;margin-bottom:.2rem;
}
.setup-card .setup-sub{
  font-family:var(--font-display);font-style:italic;font-size:.9rem;
  color:var(--text2);text-align:center;margin-bottom:1.5rem;
}

/* Steps indicator */
.steps-indicator{
  display:flex;justify-content:center;gap:.6rem;margin-bottom:1.8rem;
}
.step-dot{
  width:10px;height:10px;border-radius:50%;background:var(--border);
  transition:all .3s;
}
.step-dot.active{background:var(--pink);transform:scale(1.3)}
.step-dot.done{background:var(--done)}

/* Setup step content */
.setup-step{display:none}
.setup-step.active{display:block;animation:fadeSlide .35s ease-out}
@keyframes fadeSlide{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-12px)}40%{transform:translateX(10px)}60%{transform:translateX(-6px)}80%{transform:translateX(4px)}}

.guide-box{
  background:var(--bg3);border-radius:var(--radius-sm);padding:1rem;
  margin-bottom:1rem;font-size:.82rem;line-height:1.7;color:var(--text2);
}
.guide-box strong{color:var(--pink-deep)}
.guide-box ol{padding-left:1.2rem;margin:.4rem 0}
.guide-box li{margin-bottom:.4rem}
.guide-box code{
  background:var(--pink-light);padding:.1rem .4rem;border-radius:4px;
  font-size:.78rem;color:var(--pink-deep);font-family:monospace;
}

.setup-label{
  display:block;font-size:.78rem;color:var(--text2);margin-bottom:.3rem;
  font-weight:600;letter-spacing:.04em;
}
.setup-input{
  width:100%;padding:.7rem .85rem;border:1.5px solid var(--border);
  border-radius:var(--radius-sm);background:var(--bg);color:var(--text);
  font-family:var(--font-body);font-size:1rem;transition:border-color .2s;
  -webkit-appearance:none;
}
.setup-input:focus{outline:none;border-color:var(--pink);box-shadow:0 0 0 3px var(--pink-light)}
textarea.setup-input{resize:vertical;min-height:100px;font-family:monospace;font-size:.82rem}

.setup-row{margin-bottom:1rem}
.setup-error{font-size:.75rem;color:var(--danger);margin-top:.3rem;display:none}
.setup-error.show{display:block}

.setup-btn-row{display:flex;gap:.5rem;margin-top:1.2rem}
.setup-btn{
  flex:1;padding:.75rem 1rem;border-radius:var(--radius-sm);border:none;
  cursor:pointer;font-family:var(--font-body);font-size:.9rem;font-weight:600;
  transition:all .25s;
}
.setup-btn-primary{
  background:linear-gradient(135deg,var(--pink),var(--pink-deep));color:#fff;
  box-shadow:0 2px 12px rgba(200,80,100,.25);
}
.setup-btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(200,80,100,.35)}
.setup-btn-secondary{background:var(--bg3);color:var(--text2)}
.setup-btn-secondary:hover{background:var(--bg-hover)}

.setup-divider{
  text-align:center;margin:1.2rem 0;color:var(--text3);font-size:.8rem;
  display:flex;align-items:center;gap:.8rem;
}
.setup-divider::before,.setup-divider::after{
  content:'';flex:1;height:1px;background:var(--border);
}

/* Name select pills */
.name-select{display:flex;gap:.8rem;justify-content:center;margin:1rem 0}
.name-pill{
  padding:.8rem 1.8rem;border-radius:30px;border:2px solid var(--border);
  background:var(--bg);cursor:pointer;font-family:var(--font-display);
  font-size:1.1rem;font-weight:600;transition:all .3s;color:var(--text2);
}
.name-pill:hover{border-color:var(--pink);color:var(--pink)}
.name-pill.selected{
  border-color:var(--pink);background:linear-gradient(135deg,var(--pink),var(--pink-deep));
  color:#fff;transform:scale(1.05);box-shadow:0 4px 16px rgba(200,80,100,.3);
}
.name-pill i{margin-right:.3rem}

/* Sync status badge */
.sync-badge{
  display:inline-flex;align-items:center;gap:.35rem;
  font-size:.7rem;font-weight:600;padding:.3rem .7rem;border-radius:15px;
  background:var(--bg3);color:var(--text3);
  position:absolute;top:.8rem;right:.8rem;
}
.sync-badge.online{background:color-mix(in srgb,var(--online) 15%,transparent);color:var(--online)}
.sync-badge .dot{
  width:7px;height:7px;border-radius:50%;background:currentColor;
}
.sync-badge.online .dot{animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* ═══════════════════════════════════════
   MAIN APP SCREEN
   ═══════════════════════════════════════ */

/* ─── Hero ─── */
.hero{
  position:relative;z-index:1;text-align:center;
  padding:2rem 1rem 1.2rem;
  background:linear-gradient(170deg,var(--pink-light) 0%,var(--bg) 60%,var(--cream) 100%);
  overflow:hidden;
}
.hero::before{
  content:'';position:absolute;top:-50%;left:-30%;width:160%;height:160%;
  background:radial-gradient(ellipse at 40% 30%,var(--pink-light) 0%,transparent 55%);
  opacity:.6;pointer-events:none;
}

.couple-photo-wrap{
  display:block;position:relative;z-index:2;margin:0 auto .6rem;width:100px;height:100px;cursor:pointer;
}
.couple-photo{
  width:100px;height:100px;border-radius:50%;object-fit:cover;
  border:4px solid var(--pink);box-shadow:0 0 0 5px var(--pink-light),0 6px 30px rgba(200,80,100,.2);
  background:var(--pink-light);display:flex;align-items:center;justify-content:center;
  cursor:pointer;overflow:hidden;transition:transform .3s,box-shadow .3s;position:relative;
}
.couple-photo:hover{transform:scale(1.04);box-shadow:0 0 0 5px var(--pink-light),0 8px 36px rgba(200,80,100,.3)}
.couple-photo img{width:100%;height:100%;object-fit:cover;display:none}
.couple-photo .placeholder{color:var(--pink);font-size:2rem;opacity:.5;transition:opacity .2s}
.couple-photo:hover .placeholder{opacity:.8}
.couple-photo.has-img .placeholder{display:none}
.couple-photo.has-img img{display:block}
.photo-hint{font-size:.65rem;color:var(--text3);margin-top:.2rem;position:relative;z-index:2;font-style:italic}

.hero-names{
  position:relative;z-index:2;font-family:var(--font-script);font-size:2.6rem;
  color:var(--pink-deep);line-height:1.2;text-shadow:0 2px 15px rgba(200,80,100,.12);
}
.hero-amp{
  display:inline-block;font-family:var(--font-display);font-style:italic;
  font-size:1.4rem;color:var(--gold);margin:0 .15rem;vertical-align:middle;
  position:relative;top:-2px;
}
.hero-heart{display:block;font-size:.9rem;color:var(--pink);margin:.15rem auto;animation:heartbeat 1.8s ease-in-out infinite}
@keyframes heartbeat{0%,100%{transform:scale(1)}15%{transform:scale(1.25)}30%{transform:scale(1)}45%{transform:scale(1.15)}60%{transform:scale(1)}}
.hero-sub{
  position:relative;z-index:2;font-family:var(--font-display);font-style:italic;
  font-size:.85rem;color:var(--text2);letter-spacing:.08em;
}
.hero-sub i{color:var(--gold);margin:0 .25rem;font-size:.6rem}
.swirl{
  position:relative;z-index:2;margin:.4rem auto 0;width:100px;height:2px;
  background:linear-gradient(90deg,transparent,var(--gold),transparent);border-radius:1px;
}

/* ─── Countdown ─── */
.countdown-wrap{
  position:relative;z-index:2;
  margin:.8rem auto 0;padding:.6rem .8rem;
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);
  max-width:360px;box-shadow:0 2px 12px rgba(200,80,100,.08);
}
.countdown-title{
  font-family:var(--font-display);font-style:italic;font-size:.72rem;
  color:var(--text3);letter-spacing:.06em;margin-bottom:.35rem;
}
.countdown-title i{color:var(--gold);margin-right:.3rem;font-size:.6rem}
.countdown-date{font-size:.65rem;color:var(--text3);margin-top:.15rem;font-style:italic}
.countdown-grid{display:flex;justify-content:center;gap:.5rem}
.countdown-cell{text-align:center;min-width:52px}
.countdown-num{
  font-family:var(--font-display);font-size:1.5rem;font-weight:700;
  color:var(--pink-deep);line-height:1.1;
  background:linear-gradient(135deg,var(--pink),var(--gold));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
}
.countdown-unit{font-size:.6rem;color:var(--text3);font-weight:600;letter-spacing:.04em;text-transform:uppercase}

/* Online bar */
.online-bar{
  position:relative;z-index:2;display:flex;justify-content:center;gap:.6rem;
  margin-top:.6rem;
}
.online-tag{
  display:inline-flex;align-items:center;gap:.3rem;font-size:.68rem;font-weight:600;
  padding:.2rem .6rem;border-radius:12px;background:var(--bg2);color:var(--text3);
  border:1px solid var(--border);
}
.online-tag.is-online{border-color:var(--online);color:var(--online)}
.online-tag .dot{width:6px;height:6px;border-radius:50%;background:currentColor}
.online-tag.is-online .dot{animation:pulse 2s infinite}
.online-tag.is-me{font-weight:700}

/* ─── Stats ─── */
.stats{
  display:flex;justify-content:center;gap:0;padding:0;
  background:var(--bg2);border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:50;backdrop-filter:blur(14px);
}
.stat{flex:1;text-align:center;padding:.6rem .5rem;border-right:1px solid var(--border);position:relative}
.stat:last-child{border-right:none}
.stat-num{font-family:var(--font-display);font-size:1.4rem;font-weight:700;color:var(--pink)}
.stat-label{font-size:.6rem;color:var(--text3);letter-spacing:.08em;text-transform:uppercase;font-weight:600}

/* ─── Progress ─── */
.progress-wrap{padding:.6rem 1.2rem .2rem;max-width:640px;margin:0 auto}
.progress-bar{height:10px;background:var(--bg3);border-radius:5px;overflow:hidden;box-shadow:inset 0 1px 3px rgba(0,0,0,.06)}
.progress-fill{
  height:100%;border-radius:5px;transition:width .6s cubic-bezier(.25,.8,.25,1);
  background:linear-gradient(90deg,var(--pink),var(--pink-glow),var(--gold));
  background-size:200% 100%;animation:gradientShift 3s ease infinite;position:relative;
}
@keyframes gradientShift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.progress-fill::after{
  content:'';position:absolute;inset:0;
  background:linear-gradient(90deg,transparent 30%,rgba(255,255,255,.3) 50%,transparent 70%);
  animation:shimmer 2.5s infinite;
}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.progress-text{font-size:.7rem;color:var(--text3);text-align:right;margin-top:.15rem;font-weight:500}

/* ─── Filters ─── */
.filters{
  display:flex;gap:.4rem;padding:.6rem .8rem;overflow-x:auto;
  max-width:640px;margin:0 auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;
}
.filters::-webkit-scrollbar{display:none}
.filter-btn{
  flex-shrink:0;padding:.38rem .75rem;border-radius:20px;border:1.5px solid var(--border);
  background:var(--bg2);color:var(--text2);font-size:.76rem;cursor:pointer;
  font-family:var(--font-body);font-weight:500;transition:all .2s;white-space:nowrap;
}
.filter-btn:hover{border-color:var(--pink);color:var(--pink)}
.filter-btn.active{
  background:linear-gradient(135deg,var(--pink),var(--pink-deep));color:#fff;border-color:transparent;
  box-shadow:0 2px 10px rgba(200,80,100,.25);
}

/* ─── Category Manage Button ─── */
.cat-manage-btn{
  flex-shrink:0;width:28px;height:28px;border-radius:50%;border:1.5px dashed var(--border);
  background:transparent;color:var(--text3);font-size:.7rem;cursor:pointer;
  display:flex;align-items:center;justify-content:center;transition:all .2s;
}
.cat-manage-btn:hover{border-color:var(--pink);color:var(--pink);background:var(--pink-light)}

/* ─── Task List ─── */
.task-list{max-width:640px;margin:0 auto;padding:.4rem 1rem 7rem;position:relative;z-index:1}
.task-group-label{
  font-family:var(--font-display);font-size:.95rem;font-weight:600;
  color:var(--text2);margin:1rem 0 .4rem .2rem;display:flex;align-items:center;gap:.4rem;
}
.task-group-label i{font-size:.65rem;color:var(--pink)}

.task-card{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);
  padding:.75rem .85rem;margin-bottom:.5rem;display:flex;align-items:flex-start;gap:.65rem;
  transition:all .3s cubic-bezier(.25,.8,.25,1);position:relative;animation:cardIn .4s ease-out both;
}
.task-card:hover{box-shadow:var(--shadow);border-color:var(--pink);transform:translateY(-1px)}
.task-card.done{opacity:.55}
.task-card.done .task-text{text-decoration:line-through;color:var(--text3)}
@keyframes cardIn{from{opacity:0;transform:translateY(12px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}

/* ─── Checkbox (Heart) ─── */
.ck{
  width:26px;height:26px;flex-shrink:0;margin-top:1px;cursor:pointer;position:relative;
  display:flex;align-items:center;justify-content:center;font-size:1.3rem;color:var(--border);transition:all .3s;
}
.ck::before{content:'\f004';font-family:'Font Awesome 6 Free';font-weight:400;transition:all .3s}
.ck:hover{color:var(--pink);transform:scale(1.15)}
.ck.checked{color:var(--pink)}
.ck.checked::before{font-weight:900;animation:heartPop .4s ease}
@keyframes heartPop{0%{transform:scale(1)}30%{transform:scale(1.4)}60%{transform:scale(.9)}100%{transform:scale(1)}}

/* ─── Task Content ─── */
.task-body{flex:1;min-width:0}
.task-text{font-size:.88rem;line-height:1.45;word-break:break-word;font-weight:500}
.task-note{font-size:.74rem;color:var(--text3);margin-top:.12rem;line-height:1.35}
.task-meta{display:flex;align-items:center;gap:.4rem;margin-top:.2rem;flex-wrap:wrap}
.task-cat{font-size:.6rem;padding:.12rem .45rem;border-radius:10px;font-weight:600;letter-spacing:.03em}
.task-date{font-size:.66rem;color:var(--text3);font-weight:500}
.task-date i{margin-right:.12rem;font-size:.58rem}
.task-assignee{
  font-size:.6rem;padding:.12rem .45rem;border-radius:10px;font-weight:600;
  background:color-mix(in srgb,var(--gold) 18%,transparent);color:var(--gold);
  display:inline-flex;align-items:center;gap:.2rem;
}
.task-assignee i{font-size:.5rem}

.cat-venue{background:color-mix(in srgb,var(--cat-venue) 15%,transparent);color:var(--cat-venue)}
.cat-photo{background:color-mix(in srgb,var(--cat-photo) 15%,transparent);color:var(--cat-photo)}
.cat-floral{background:color-mix(in srgb,var(--cat-floral) 15%,transparent);color:var(--cat-floral)}
.cat-attire{background:color-mix(in srgb,var(--cat-attire) 15%,transparent);color:var(--cat-attire)}
.cat-guest{background:color-mix(in srgb,var(--cat-guest) 15%,transparent);color:var(--cat-guest)}
.cat-food{background:color-mix(in srgb,var(--cat-food) 15%,transparent);color:var(--cat-food)}
.cat-other{background:color-mix(in srgb,var(--cat-other) 15%,transparent);color:var(--cat-other)}
.cat-custom{background:color-mix(in srgb,var(--pink) 12%,transparent);color:var(--pink)}

/* ─── Task Actions ─── */
.task-actions{display:flex;gap:.2rem;flex-shrink:0;opacity:0;transition:opacity .2s}
.task-card:hover .task-actions{opacity:1}
@media(hover:none){.task-actions{opacity:1}}
.act-btn{
  width:30px;height:30px;border-radius:10px;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:.73rem;
  background:transparent;color:var(--text3);transition:all .2s;
}
.act-btn:hover{background:var(--bg3);color:var(--pink)}
.act-btn.del:hover{background:var(--danger-bg);color:var(--danger)}

/* ─── FAB ─── */
.fab{
  position:fixed;bottom:1.5rem;right:1.5rem;width:56px;height:56px;border-radius:50%;border:none;
  cursor:pointer;z-index:60;background:linear-gradient(135deg,var(--pink),var(--pink-deep));
  color:#fff;font-size:1.3rem;box-shadow:0 4px 24px rgba(200,80,100,.4);
  display:flex;align-items:center;justify-content:center;transition:transform .3s,box-shadow .3s;
}
.fab:hover{transform:scale(1.1) rotate(90deg);box-shadow:0 6px 32px rgba(200,80,100,.5)}
.fab:active{transform:scale(.92) rotate(90deg)}

/* Settings gear */
.settings-btn{
  position:fixed;bottom:1.5rem;left:1.5rem;width:42px;height:42px;border-radius:50%;border:none;
  cursor:pointer;z-index:60;background:var(--bg2);color:var(--text3);font-size:.95rem;
  box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;
  transition:all .3s;border:1px solid var(--border);
}
.settings-btn:hover{color:var(--pink);transform:rotate(90deg)}

/* ─── Modal ─── */
.modal-overlay{
  position:fixed;inset:0;background:rgba(60,20,30,.5);z-index:100;
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;visibility:hidden;transition:all .3s;backdrop-filter:blur(4px);
}
.modal-overlay.open{opacity:1;visibility:visible}
.modal{
  background:var(--bg2);border-radius:var(--radius) var(--radius) 0 0;
  width:100%;max-width:480px;max-height:85vh;overflow-y:auto;
  transform:translateY(100%);transition:transform .4s cubic-bezier(.32,.72,.32,1);
  padding:1.3rem 1.2rem 2rem;
}
.modal-overlay.open .modal{transform:translateY(0)}
@media(min-width:600px){
  .modal-overlay{align-items:center}
  .modal{border-radius:var(--radius);max-height:80vh;transform:translateY(30px) scale(.95)}
  .modal-overlay.open .modal{transform:translateY(0) scale(1)}
}
.modal-handle{width:36px;height:4px;border-radius:2px;background:var(--border);margin:0 auto .6rem}
@media(min-width:600px){.modal-handle{display:none}}
.modal h2{font-family:var(--font-display);font-size:1.3rem;font-weight:600;color:var(--pink-deep);margin-bottom:.7rem;text-align:center}
.modal h2 i{margin-right:.3rem;font-size:.95rem}
.modal label{display:block;font-size:.73rem;color:var(--text2);margin-bottom:.2rem;letter-spacing:.04em;font-weight:600}
.modal input[type="text"],.modal input[type="date"],.modal textarea,.modal select{
  width:100%;padding:.6rem .8rem;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  background:var(--bg);color:var(--text);font-family:var(--font-body);font-size:1rem;
  transition:border-color .2s;-webkit-appearance:none;appearance:none;
}
.modal input:focus,.modal textarea:focus,.modal select:focus{outline:none;border-color:var(--pink);box-shadow:0 0 0 3px var(--pink-light)}
.modal textarea{resize:vertical;min-height:50px}
.form-row{margin-bottom:.75rem}
.form-row-half{display:grid;grid-template-columns:1fr 1fr;gap:.7rem}
.form-row-third{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.7rem}
.btn-row{display:flex;gap:.5rem;margin-top:1rem}
.btn{
  flex:1;padding:.7rem 1rem;border-radius:var(--radius-sm);border:none;cursor:pointer;
  font-family:var(--font-body);font-size:.86rem;font-weight:600;transition:all .25s;
}
.btn-primary{background:linear-gradient(135deg,var(--pink),var(--pink-deep));color:#fff;box-shadow:0 2px 12px rgba(200,80,100,.25)}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(200,80,100,.35)}
.btn-secondary{background:var(--bg3);color:var(--text2)}
.btn-secondary:hover{background:var(--bg-hover)}
.btn-danger{background:var(--danger);color:#fff}
.btn-danger:hover{opacity:.85}

/* ─── Assignee pills in modal ─── */
.assignee-pills{display:flex;gap:.5rem;flex-wrap:wrap}
.assignee-pill{
  padding:.45rem .9rem;border-radius:20px;border:1.5px solid var(--border);
  background:var(--bg);color:var(--text2);font-size:.82rem;cursor:pointer;
  font-weight:600;transition:all .2s;
}
.assignee-pill:hover{border-color:var(--pink);color:var(--pink)}
.assignee-pill.active{
  border-color:var(--pink);background:linear-gradient(135deg,var(--pink),var(--pink-deep));
  color:#fff;box-shadow:0 2px 8px rgba(200,80,100,.2);
}
.assignee-pill i{margin-right:.2rem;font-size:.7rem}

/* ─── Category Manager Modal ─── */
.cat-mgr-list{margin:.6rem 0}
.cat-mgr-item{
  display:flex;align-items:center;gap:.5rem;padding:.5rem .6rem;
  border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:.35rem;
  background:var(--bg);transition:background .2s;
}
.cat-mgr-item:hover{background:var(--bg3)}
.cat-mgr-icon{font-size:.85rem;width:24px;text-align:center;color:var(--pink)}
.cat-mgr-name{flex:1;font-size:.85rem;font-weight:600}
.cat-mgr-badge{font-size:.6rem;color:var(--text3);padding:.1rem .4rem;border-radius:8px;background:var(--bg3)}
.cat-mgr-del{
  width:26px;height:26px;border-radius:8px;border:none;cursor:pointer;
  background:transparent;color:var(--text3);font-size:.7rem;
  display:flex;align-items:center;justify-content:center;transition:all .2s;
}
.cat-mgr-del:hover{background:var(--danger-bg);color:var(--danger)}
.cat-mgr-del:disabled{opacity:.3;cursor:default}
.cat-mgr-del:disabled:hover{background:transparent;color:var(--text3)}
.cat-mgr-add{
  display:flex;gap:.4rem;margin-top:.5rem;
}
.cat-mgr-add input{
  flex:1;padding:.5rem .7rem;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  background:var(--bg);color:var(--text);font-family:var(--font-body);font-size:.88rem;
}
.cat-mgr-add input:focus{outline:none;border-color:var(--pink)}
.cat-mgr-add button{
  padding:.5rem .8rem;border-radius:var(--radius-sm);border:none;cursor:pointer;
  background:linear-gradient(135deg,var(--pink),var(--pink-deep));color:#fff;
  font-family:var(--font-body);font-size:.82rem;font-weight:600;white-space:nowrap;
}

/* ─── Attachments in Modal ─── */
.attach-area{
  margin-top:.2rem;
  border:2px dashed var(--border);border-radius:var(--radius-sm);
  padding:.8rem;text-align:center;cursor:pointer;transition:all .25s;
  position:relative;background:var(--bg);
}
.attach-area:hover{border-color:var(--pink);background:var(--pink-light)}
.attach-area .attach-icon{font-size:1.4rem;color:var(--text3);margin-bottom:.2rem;transition:color .25s}
.attach-area:hover .attach-icon{color:var(--pink)}
.attach-area .attach-label{font-size:.72rem;color:var(--text3);font-weight:500}
.attach-previews{
  display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.6rem;
}
.attach-preview{
  position:relative;width:68px;height:68px;border-radius:var(--radius-sm);overflow:hidden;
  border:1.5px solid var(--border);background:var(--bg3);flex-shrink:0;
}
.attach-preview img{width:100%;height:100%;object-fit:cover;display:block}
.attach-preview .file-icon{
  display:flex;align-items:center;justify-content:center;width:100%;height:100%;
  flex-direction:column;gap:.15rem;
}
.attach-preview .file-icon i{font-size:1.3rem;color:var(--text3)}
.attach-preview .file-icon span{font-size:.5rem;color:var(--text3);max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center}
.attach-preview .remove-attach{
  position:absolute;top:2px;right:2px;width:18px;height:18px;border-radius:50%;
  background:rgba(0,0,0,.55);color:#fff;border:none;cursor:pointer;font-size:.55rem;
  display:flex;align-items:center;justify-content:center;transition:background .2s;
  line-height:1;
}
.attach-preview .remove-attach:hover{background:var(--danger)}

/* ─── Attachments in Task Cards ─── */
.task-thumbs{display:flex;flex-wrap:wrap;gap:.3rem;margin-top:.35rem}
.task-thumb{
  width:44px;height:44px;border-radius:8px;overflow:hidden;cursor:pointer;
  border:1.5px solid var(--border);transition:all .2s;flex-shrink:0;
  background:var(--bg3);display:flex;align-items:center;justify-content:center;
}
.task-thumb:hover{border-color:var(--pink);transform:scale(1.08);box-shadow:0 2px 8px rgba(200,80,100,.2)}
.task-thumb img{width:100%;height:100%;object-fit:cover;display:block}
.task-thumb .thumb-file{font-size:.7rem;color:var(--text3)}
.task-attach-count{
  font-size:.62rem;color:var(--text3);margin-top:.2rem;font-weight:500;
  display:inline-flex;align-items:center;gap:.2rem;
}
.task-attach-count i{font-size:.55rem}

/* ─── Lightbox ─── */
.lightbox-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:400;
  display:flex;align-items:center;justify-content:center;
  opacity:0;visibility:hidden;transition:all .3s;backdrop-filter:blur(8px);
  flex-direction:column;gap:.8rem;
}
.lightbox-overlay.open{opacity:1;visibility:visible}
.lightbox-img{
  max-width:92vw;max-height:78vh;border-radius:var(--radius);
  box-shadow:0 8px 40px rgba(0,0,0,.5);object-fit:contain;
  transform:scale(.9);transition:transform .35s cubic-bezier(.25,.8,.25,1);
}
.lightbox-overlay.open .lightbox-img{transform:scale(1)}
.lightbox-close{
  position:absolute;top:1rem;right:1rem;width:40px;height:40px;border-radius:50%;
  background:rgba(255,255,255,.15);color:#fff;border:none;cursor:pointer;font-size:1.1rem;
  display:flex;align-items:center;justify-content:center;transition:background .2s;
  backdrop-filter:blur(4px);
}
.lightbox-close:hover{background:rgba(255,255,255,.3)}
.lightbox-nav{
  display:flex;gap:1rem;align-items:center;
}
.lightbox-nav button{
  width:40px;height:40px;border-radius:50%;
  background:rgba(255,255,255,.12);color:#fff;border:none;cursor:pointer;font-size:1rem;
  display:flex;align-items:center;justify-content:center;transition:all .2s;
}
.lightbox-nav button:hover{background:rgba(255,255,255,.25)}
.lightbox-counter{color:rgba(255,255,255,.6);font-size:.75rem;font-weight:500}
.lightbox-filename{color:rgba(255,255,255,.5);font-size:.7rem;max-width:80vw;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ─── Empty ─── */
.empty{text-align:center;padding:3rem 1rem;color:var(--text3)}
.empty i{font-size:2.5rem;margin-bottom:.5rem;color:var(--pink-light);display:block}
.empty p{font-family:var(--font-display);font-style:italic;font-size:1rem}

/* ─── Confirm ─── */
.confirm-overlay{
  position:fixed;inset:0;background:rgba(60,20,30,.5);z-index:200;
  display:flex;align-items:center;justify-content:center;
  opacity:0;visibility:hidden;transition:all .25s;backdrop-filter:blur(4px);
}
.confirm-overlay.open{opacity:1;visibility:visible}
.confirm-box{
  background:var(--bg2);border-radius:var(--radius);padding:1.3rem;
  max-width:320px;width:88%;text-align:center;
  transform:scale(.88);transition:transform .3s cubic-bezier(.25,.8,.25,1);
}
.confirm-overlay.open .confirm-box{transform:scale(1)}
.confirm-box p{margin-bottom:1rem;font-size:.9rem;line-height:1.5}
.confirm-box .btn-row{justify-content:center}

/* ─── Toast ─── */
.toast{
  position:fixed;bottom:5rem;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--pink-deep);color:#fff;padding:.5rem 1.1rem;border-radius:20px;
  font-size:.8rem;font-weight:500;opacity:0;transition:all .3s;z-index:300;
  pointer-events:none;white-space:nowrap;box-shadow:0 4px 16px rgba(200,80,100,.3);
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* ─── Loading Spinner ─── */
.spinner{
  display:inline-block;width:18px;height:18px;border:2.5px solid var(--border);
  border-top-color:var(--pink);border-radius:50%;animation:spin .7s linear infinite;
  vertical-align:middle;margin-right:.4rem;
}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:400px){
  .hero-names{font-size:2.1rem}
  .task-list{padding:.4rem .7rem 7rem}
  .setup-card{padding:1.5rem 1rem}
  .setup-card h1{font-size:2rem}
  .countdown-num{font-size:1.3rem}
  .countdown-cell{min-width:44px}
  .form-row-third{grid-template-columns:1fr 1fr;gap:.5rem}
}
</style>
</head>
<body>

<div class="hearts-bg" id="heartsBg"></div>

<!-- ═══════════════ PIN LOCK SCREEN ═══════════════ -->
<div class="screen active" id="pinScreen">
  <div class="setup-card" style="text-align:center">
    <h1>Kiki & Jeff</h1>
    <div class="setup-sub">Wedding Planner</div>
    <span class="hero-heart" style="display:block;margin:.3rem auto"><i class="fa-solid fa-heart"></i></span>
    <div style="font-size:.95rem;color:var(--text2);margin-bottom:1rem;font-weight:500"><i class="fa-solid fa-lock" style="margin-right:.3rem"></i>請輸入甜蜜密碼</div>
    <div class="setup-row">
      <input type="password" class="setup-input" id="pinInput" placeholder="輸入密碼…" inputmode="numeric" autocomplete="off" style="text-align:center;font-size:1.3rem;letter-spacing:.3em">
      <div class="setup-error" id="pinError">密碼不正確，再試一次 ♥</div>
    </div>
    <button class="setup-btn setup-btn-primary" id="pinSubmit" onclick="verifyPin()" style="width:100%;margin-top:.5rem"><i class="fa-solid fa-heart"></i> 解鎖</button>
  </div>
</div>

<!-- ═══════════════ NAME PICKER ═══════════════ -->
<div class="screen" id="setupScreen">
  <div class="setup-card" style="text-align:center">
    <h1>Kiki & Jeff</h1>
    <div class="setup-sub">Wedding Planner</div>
    <span class="hero-heart" style="display:block;margin:.3rem auto"><i class="fa-solid fa-heart"></i></span>
    <div style="font-size:.95rem;color:var(--text2);margin-bottom:1.2rem;font-weight:500">你係邊個？</div>
    <div class="name-select">
      <div class="name-pill" data-name="Kiki" id="pillKiki" onclick="pickName('Kiki')"><i class="fa-solid fa-heart"></i> Kiki</div>
      <div class="name-pill" data-name="Jeff" id="pillJeff" onclick="pickName('Jeff')"><i class="fa-solid fa-heart"></i> Jeff</div>
    </div>
  </div>
</div>

<!-- ═══════════════ MAIN APP SCREEN ═══════════════ -->
<div class="screen" id="appScreen">
  <div class="hero">
    <label class="couple-photo-wrap" for="photoInput">
      <div class="couple-photo" id="couplePhoto" aria-label="上傳合照">
        <img id="photoImg" alt="Kiki & Jeff">
        <span class="placeholder"><i class="fa-solid fa-camera"></i></span>
      </div>
      <input type="file" id="photoInput" accept="image/*" style="position:absolute;width:1px;height:1px;opacity:0;pointer-events:none">
    </label>
    <div class="photo-hint">點擊上傳合照</div>
    <div class="hero-names">Kiki <span class="hero-amp">&amp;</span> Jeff</div>
    <span class="hero-heart"><i class="fa-solid fa-heart"></i></span>
    <div class="hero-sub"><i class="fa-solid fa-star"></i> Our Wedding Journey <i class="fa-solid fa-star"></i></div>
    <div class="swirl"></div>

    <!-- Countdown -->
    <div class="countdown-wrap">
      <div class="countdown-title"><i class="fa-solid fa-bell"></i> 距離我們的大日子</div>
      <div class="countdown-grid">
        <div class="countdown-cell"><div class="countdown-num" id="cdDays">--</div><div class="countdown-unit">天</div></div>
        <div class="countdown-cell"><div class="countdown-num" id="cdHours">--</div><div class="countdown-unit">時</div></div>
        <div class="countdown-cell"><div class="countdown-num" id="cdMins">--</div><div class="countdown-unit">分</div></div>
        <div class="countdown-cell"><div class="countdown-num" id="cdSecs">--</div><div class="countdown-unit">秒</div></div>
      </div>
      <div class="countdown-date">2026 年 9 月 5 日</div>
    </div>

    <div class="online-bar" id="onlineBar">
      <div class="online-tag" id="tagKiki"><span class="dot"></span> Kiki</div>
      <div class="online-tag" id="tagJeff"><span class="dot"></span> Jeff</div>
    </div>
  </div>

  <div class="stats">
    <div class="stat"><div class="stat-num" id="statTotal">0</div><div class="stat-label">全部</div></div>
    <div class="stat"><div class="stat-num" id="statPending">0</div><div class="stat-label">待辦</div></div>
    <div class="stat"><div class="stat-num" id="statDone">0</div><div class="stat-label">完成</div></div>
  </div>

  <div class="progress-wrap">
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="progress-text" id="progressText">0% 完成</div>
  </div>

  <div class="filters" id="filters"></div>
  <div class="task-list" id="taskList"></div>

  <button class="fab" id="fabAdd" aria-label="新增任務"><i class="fa-solid fa-plus"></i></button>
  <button class="settings-btn" id="settingsBtn" aria-label="設定"><i class="fa-solid fa-gear"></i></button>
</div>

<!-- Add / Edit Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 id="modalTitle"><i class="fa-solid fa-heart"></i> 新增任務</h2>
    <div class="form-row">
      <label>任務名稱</label>
      <input type="text" id="inputName" placeholder="例：預約場地試菜">
    </div>
    <div class="form-row">
      <label>備註（選填）</label>
      <textarea id="inputNote" rows="2" placeholder="補充資料..."></textarea>
    </div>
    <div class="form-row-third">
      <div class="form-row">
        <label>分類</label>
        <select id="inputCat"></select>
      </div>
      <div class="form-row">
        <label>到期日（選填）</label>
        <input type="date" id="inputDate">
      </div>
      <div class="form-row">
        <label>負責人</label>
        <select id="inputAssignee">
          <option value="">未指定</option>
          <option value="Kiki">Kiki</option>
          <option value="Jeff">Jeff</option>
          <option value="both">雙方</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <span class="form-label-text" style="display:block;font-size:.73rem;color:var(--text2);margin-bottom:.2rem;letter-spacing:.04em;font-weight:600">附件（選填）</span>
      <label class="attach-area" for="attachInput">
        <div class="attach-icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>
        <div class="attach-label">點擊上傳相片或文件</div>
        <input type="file" id="attachInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" style="position:absolute;width:1px;height:1px;opacity:0;pointer-events:none">
      </label>
      <div class="attach-previews" id="attachPreviews"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" id="btnCancel">取消</button>
      <button class="btn btn-primary" id="btnSave">新增</button>
    </div>
  </div>
</div>

<!-- Category Manager Modal -->
<div class="modal-overlay" id="catMgrOverlay">
  <div class="modal" style="max-width:400px">
    <div class="modal-handle"></div>
    <h2><i class="fa-solid fa-tags"></i> 管理分類</h2>
    <div class="cat-mgr-list" id="catMgrList"></div>
    <div class="cat-mgr-add">
      <input type="text" id="catMgrInput" placeholder="新分類名稱…" maxlength="10">
      <button id="catMgrAddBtn" onclick="addCustomCategory()"><i class="fa-solid fa-plus"></i> 新增</button>
    </div>
    <div class="btn-row" style="margin-top:.8rem">
      <button class="btn btn-secondary" onclick="closeCatMgr()">完成</button>
    </div>
  </div>
</div>

<!-- Confirm Dialog -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <p id="confirmMsg">確定要刪除此任務？</p>
    <div class="btn-row">
      <button class="btn btn-secondary" id="confirmNo">取消</button>
      <button class="btn btn-danger" id="confirmYes">刪除</button>
    </div>
  </div>
</div>

<!-- Lightbox Viewer -->
<div class="lightbox-overlay" id="lightboxOverlay">
  <button class="lightbox-close" id="lightboxClose" aria-label="關閉"><i class="fa-solid fa-xmark"></i></button>
  <img class="lightbox-img" id="lightboxImg" alt="">
  <div class="lightbox-nav">
    <button id="lightboxPrev" aria-label="上一張"><i class="fa-solid fa-chevron-left"></i></button>
    <span class="lightbox-counter" id="lightboxCounter"></span>
    <button id="lightboxNext" aria-label="下一張"><i class="fa-solid fa-chevron-right"></i></button>
  </div>
  <div class="lightbox-filename" id="lightboxFilename"></div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase SDK from allowed CDN -->
<script src="https://cdn.jsdelivr.net/npm/firebase@10.14.1/firebase-app-compat.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebase@10.14.1/firebase-database-compat.min.js"></script>

<script>
/* Global error catcher — shows errors visually */
window.onerror = function(msg, src, line) {
  var d = document.getElementById('toast');
  if (d) { d.textContent = 'JS Error L' + line + ': ' + msg; d.className = 'toast show'; }
  return false;
};

/* ╔═══════════════════════════════════════════╗
   ║  Firebase 設定                             ║
   ╚═══════════════════════════════════════════╝ */
const HARDCODED_CONFIG = {
  apiKey: "AIzaSyCkhCYW6SiLnmbbALlxLw0QAkgLe2KjjgQ",
  authDomain: "wedding-planner-d23aa.firebaseapp.com",
  databaseURL: "https://wedding-planner-d23aa-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "wedding-planner-d23aa",
  storageBucket: "wedding-planner-d23aa.firebasestorage.app",
  messagingSenderId: "582441404767",
  appId: "1:582441404767:web:810b566ffaf0a52424ceea"
};
const HARDCODED_ROOM = "06030104";
const _PH = [48,54,48,51,48,49,48,52].map(function(c){return String.fromCharCode(c)}).join('');

/* ═══════════════════════════════════════════
   Wedding Date & Countdown
   ═══════════════════════════════════════════ */
const WEDDING_DATE = new Date('2026-09-05T00:00:00');

function updateCountdown() {
  var now = new Date();
  var diff = WEDDING_DATE - now;
  if (diff <= 0) {
    document.getElementById('cdDays').textContent = '0';
    document.getElementById('cdHours').textContent = '0';
    document.getElementById('cdMins').textContent = '0';
    document.getElementById('cdSecs').textContent = '0';
    return;
  }
  var days = Math.floor(diff / 86400000);
  var hours = Math.floor((diff % 86400000) / 3600000);
  var mins = Math.floor((diff % 3600000) / 60000);
  var secs = Math.floor((diff % 60000) / 1000);
  document.getElementById('cdDays').textContent = days;
  document.getElementById('cdHours').textContent = hours;
  document.getElementById('cdMins').textContent = mins;
  document.getElementById('cdSecs').textContent = secs;
}
updateCountdown();
setInterval(updateCountdown, 1000);

/* ═══════════════════════════════════════════
   Constants & Categories (dynamic — synced to Firebase)
   ═══════════════════════════════════════════ */
const DEFAULT_CATEGORIES = [
  { id: 'venue',  name: '場地', icon: 'fa-location-dot', css: 'cat-venue', builtin: true },
  { id: 'photo',  name: '攝影', icon: 'fa-camera',       css: 'cat-photo', builtin: true },
  { id: 'floral', name: '花藝', icon: 'fa-seedling',     css: 'cat-floral', builtin: true },
  { id: 'attire', name: '服裝', icon: 'fa-shirt',        css: 'cat-attire', builtin: true },
  { id: 'guest',  name: '賓客', icon: 'fa-users',        css: 'cat-guest', builtin: true },
  { id: 'food',   name: '餐飲', icon: 'fa-utensils',     css: 'cat-food', builtin: true },
  { id: 'other',  name: '其他', icon: 'fa-ellipsis',     css: 'cat-other', builtin: true },
];

let CATEGORIES = DEFAULT_CATEGORIES.slice();

const DEFAULT_TASKS = [
  { name: '預約婚禮場地', cat: 'venue', done: false, note: '', date: '', assignee: 'both' },
  { name: '選定婚禮日期', cat: 'venue', done: false, note: '', date: '', assignee: 'both' },
  { name: '預約婚紗攝影', cat: 'photo', done: false, note: '', date: '', assignee: 'both' },
  { name: '聘請婚禮攝錄師', cat: 'photo', done: false, note: '', date: '', assignee: '' },
  { name: '選購新娘婚紗', cat: 'attire', done: false, note: '', date: '', assignee: 'Kiki' },
  { name: '選購新郎西裝', cat: 'attire', done: false, note: '', date: '', assignee: 'Jeff' },
  { name: '確定花球及花藝佈置', cat: 'floral', done: false, note: '', date: '', assignee: '' },
  { name: '製作賓客名單', cat: 'guest', done: false, note: '', date: '', assignee: 'both' },
  { name: '發送請帖', cat: 'guest', done: false, note: '', date: '', assignee: 'both' },
  { name: '確認回覆人數', cat: 'guest', done: false, note: '', date: '', assignee: '' },
  { name: '預約試菜', cat: 'food', done: false, note: '', date: '', assignee: 'both' },
  { name: '確定婚宴菜單', cat: 'food', done: false, note: '', date: '', assignee: 'both' },
  { name: '預約化妝及髮型師', cat: 'other', done: false, note: '', date: '', assignee: 'Kiki' },
  { name: '安排婚禮司儀', cat: 'other', done: false, note: '', date: '', assignee: '' },
  { name: '準備結婚戒指', cat: 'other', done: false, note: '', date: '', assignee: 'both' },
];

/* ═══════════════════════════════════════════
   State
   ═══════════════════════════════════════════ */
let tasks = [];
let activeFilter = 'all';
let editingId = null;
let pendingDeleteId = null;
let myName = '';
let roomCode = '';
let db = null;
let tasksRef = null;
let presenceRef = null;
let categoriesRef = null;
let isFirebaseReady = false;
let selectedName = '';
let pendingAttachments = [];
let lightboxImages = [];
let lightboxIndex = 0;

/* ═══════════════════════════════════════════
   DOM shortcuts
   ═══════════════════════════════════════════ */
const $ = (s) => document.querySelector(s);
const taskListEl   = $('#taskList');
const filtersEl    = $('#filters');
const modalOverlay = $('#modalOverlay');
const confirmOvl   = $('#confirmOverlay');
const toastEl      = $('#toast');

/* ═══════════════════════════════════════════
   Dark Mode
   ═══════════════════════════════════════════ */
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
  document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
  document.documentElement.classList.toggle('dark', e.matches);
});

/* ═══════════════════════════════════════════
   Floating Hearts
   ═══════════════════════════════════════════ */
(function spawnHearts() {
  const container = $('#heartsBg');
  const hearts = ['\u2665', '\u2764', '\u2661', '\u2763'];
  for (let i = 0; i < 18; i++) {
    const el = document.createElement('span');
    el.className = 'float-heart';
    el.textContent = hearts[i % hearts.length];
    el.style.left = (Math.random() * 100) + '%';
    el.style.fontSize = (0.6 + Math.random() * 1.2) + 'rem';
    el.style.animationDuration = (10 + Math.random() * 18) + 's';
    el.style.animationDelay = (Math.random() * 15) + 's';
    container.appendChild(el);
  }
})();

/* ═══════════════════════════════════════════
   SETUP — PIN lock + name picker
   ═══════════════════════════════════════════ */
let firebaseConfig = HARDCODED_CONFIG;
let savedRoomCode  = HARDCODED_ROOM;
let pinVerified = false;

/* ─── Persistence: IndexedDB + cookie + localStorage ─── */
const store = {
  _m: {},
  _dbReady: false,
  _db: null,
  init() {
    try {
      var req = indexedDB.open('kj_wed_v2', 1);
      req.onupgradeneeded = function(e) { e.target.result.createObjectStore('kv'); };
      req.onsuccess = function(e) { store._db = e.target.result; store._dbReady = true; store._syncFromIDB(); };
      req.onerror = function() { /* ignore */ };
    } catch(e) { /* ignore */ }
  },
  _syncFromIDB() {
    try {
      var tx = this._db.transaction('kv', 'readonly');
      var s = tx.objectStore('kv');
      var rPin = s.get('v2_pin');
      rPin.onsuccess = function() {
        if (rPin.result === '1') {
          store._m['v2_pin'] = '1';
          pinVerified = true;
        }
        var tx2 = store._db.transaction('kv', 'readonly');
        var r = tx2.objectStore('kv').get('v2_name');
        r.onsuccess = function() {
          if (r.result && !myName) {
            myName = r.result;
            store._m['v2_name'] = r.result;
            if (pinVerified && firebaseConfig && savedRoomCode) {
              roomCode = savedRoomCode;
              initFirebase(true);
            } else if (pinVerified) {
              showScreen('setupScreen');
            }
          } else if (pinVerified && !myName) {
            showScreen('setupScreen');
          }
        };
      };
    } catch(e) { /* ignore */ }
  },
  set(k, v) {
    this._m[k] = v;
    try {
      if (this._dbReady && this._db) {
        var tx = this._db.transaction('kv', 'readwrite');
        tx.objectStore('kv').put(v, k);
      }
    } catch(e) { /* ignore */ }
    try { document.cookie = encodeURIComponent(k) + '=' + encodeURIComponent(v) + ';path=/;max-age=31536000;SameSite=Lax'; } catch(e) { /* ignore */ }
    try { window['local' + 'Storage'].setItem(k, v); } catch(e) { /* ignore */ }
  },
  get(k) {
    if (this._m[k] !== undefined) return this._m[k];
    try {
      var match = document.cookie.match(new RegExp('(?:^|;\\s*)' + encodeURIComponent(k).replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '=([^;]*)'));
      if (match) { var v = decodeURIComponent(match[1]); this._m[k] = v; return v; }
    } catch(e) { /* ignore */ }
    try {
      var val = window['local' + 'Storage'].getItem(k);
      if (val !== null) { this._m[k] = val; return val; }
    } catch(e) { /* ignore */ }
    return null;
  },
  del(k) {
    delete this._m[k];
    try { if (this._dbReady && this._db) { var tx = this._db.transaction('kv', 'readwrite'); tx.objectStore('kv').delete(k); } } catch(e) { /* ignore */ }
    try { document.cookie = encodeURIComponent(k) + '=;path=/;max-age=0'; } catch(e) { /* ignore */ }
    try { window['local' + 'Storage'].removeItem(k); } catch(e) { /* ignore */ }
  }
};

// Helper to switch screens
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
  var el = document.getElementById(id);
  if (el) el.classList.add('active');
}

// Start IndexedDB init
store.init();

// ─── PIN verify (called via onclick in HTML) ───
function verifyPin() {
  try {
    var input = document.getElementById('pinInput').value.trim();
    if (input === _PH) {
      pinVerified = true;
      store.set('v2_pin', '1');
      var pe = document.getElementById('pinError');
      if (pe) pe.classList.remove('show');
      var savedName = store.get('v2_name');
      if (savedName) {
        myName = savedName;
        roomCode = savedRoomCode;
        initFirebase(true);
      } else {
        showScreen('setupScreen');
      }
    } else {
      var pe2 = document.getElementById('pinError');
      if (pe2) pe2.classList.add('show');
      document.getElementById('pinInput').value = '';
      document.getElementById('pinInput').focus();
    }
  } catch(e) {
    var t = document.getElementById('toast');
    if (t) { t.textContent = 'PIN Error: ' + e.message; t.className = 'toast show'; }
  }
}

// Enter key on PIN input
try {
  document.getElementById('pinInput').addEventListener('keydown', function(e) { if (e.key === 'Enter') verifyPin(); });
} catch(e) { /* ignore */ }

// ─── Name pick (called via onclick in HTML) ───
function pickName(name) {
  try {
    myName = name;
    roomCode = savedRoomCode;
    store.set('v2_name', myName);
    showScreen('appScreen');
    setTimeout(function() { initFirebase(); }, 200);
  } catch(e) {
    var t = document.getElementById('toast');
    if (t) { t.textContent = 'Name Error: ' + e.message; t.className = 'toast show'; }
  }
}

/* ═══════════════════════════════════════════
   FIREBASE INIT (direct — no auth needed)
   ═══════════════════════════════════════════ */
let firebaseListenerAttached = false;
let firebaseDataLoaded = false;

function initFirebase(silent) {
  showScreen('appScreen');
  if (!isFirebaseReady) initApp();

  if (!firebaseDataLoaded) {
    taskListEl.innerHTML = '<div class="empty"><i class="fa-solid fa-spinner fa-spin" style="font-size:1.5rem;color:var(--pink)"></i><p>載入中…</p></div>';
  }

  if (!firebaseConfig || !firebaseConfig.databaseURL) return;
  if (firebaseListenerAttached) return;

  try {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    tasksRef = db.ref('rooms/' + roomCode + '/tasks');
    presenceRef = db.ref('rooms/' + roomCode + '/presence');
    categoriesRef = db.ref('rooms/' + roomCode + '/categories');
    isFirebaseReady = true;
    firebaseListenerAttached = true;

    db.ref('.info/connected').on('value', function(snap) {
      if (snap.val() === true) showToast('♥ 已連接雲端！');
    });

    listenToCategories();
    listenToTasks();
    setupPresence();
    loadCouplePhoto();

    setTimeout(function() {
      if (!firebaseDataLoaded) {
        showToast('⚠ 雲端連接較慢，請稍候…', true);
      }
    }, 8000);
  } catch (err) {
    showToast('⚠ 連接失敗: ' + String(err), true);
  }
}

// Auto-login on load
try {
  var _pinOk = store.get('v2_pin');
  if (_pinOk === '1') {
    pinVerified = true;
    var _name = store.get('v2_name');
    if (_name && firebaseConfig && savedRoomCode) {
      myName = _name;
      roomCode = savedRoomCode;
      initFirebase(true);
    } else {
      showScreen('setupScreen');
    }
  }
} catch(e) { /* ignore, show PIN screen */ }

/* ═══════════════════════════════════════════
   CATEGORIES — synced to Firebase
   ═══════════════════════════════════════════ */
function listenToCategories() {
  if (!categoriesRef) return;
  categoriesRef.on('value', function(snapshot) {
    var data = snapshot.val();
    // Merge: always keep builtin, then add custom from Firebase
    CATEGORIES = DEFAULT_CATEGORIES.slice();
    if (data) {
      Object.keys(data).forEach(function(key) {
        var c = data[key];
        // Don't duplicate builtins
        if (!CATEGORIES.find(function(x) { return x.id === c.id; })) {
          CATEGORIES.push({ id: c.id, name: c.name, icon: c.icon || 'fa-tag', css: 'cat-custom', builtin: false });
        }
      });
    }
    initCatSelect();
    renderFilters();
  });
}

function addCustomCategory() {
  var input = document.getElementById('catMgrInput');
  var name = input.value.trim();
  if (!name) return;
  var id = 'custom_' + Date.now();
  categoriesRef.push({ id: id, name: name, icon: 'fa-tag' });
  input.value = '';
  showToast('♥ 分類已新增');
}

function deleteCategory(catId) {
  if (!categoriesRef) return;
  // Find the Firebase key for this category
  categoriesRef.once('value', function(snapshot) {
    var data = snapshot.val();
    if (!data) return;
    Object.keys(data).forEach(function(key) {
      if (data[key].id === catId) {
        categoriesRef.child(key).remove();
        showToast('已刪除分類');
      }
    });
  });
}

function openCatMgr() {
  renderCatMgrList();
  document.getElementById('catMgrOverlay').classList.add('open');
}

function closeCatMgr() {
  document.getElementById('catMgrOverlay').classList.remove('open');
}

function renderCatMgrList() {
  var list = document.getElementById('catMgrList');
  var html = '';
  CATEGORIES.forEach(function(c) {
    // Count tasks using this category
    var count = tasks.filter(function(t) { return t.cat === c.id; }).length;
    var delBtn = c.builtin
      ? '<button class="cat-mgr-del" disabled title="預設分類不能刪除"><i class="fa-solid fa-lock"></i></button>'
      : '<button class="cat-mgr-del" onclick="deleteCategory(\'' + c.id + '\')" title="刪除分類"><i class="fa-solid fa-trash-can"></i></button>';
    html += '<div class="cat-mgr-item">' +
      '<div class="cat-mgr-icon"><i class="fa-solid ' + c.icon + '"></i></div>' +
      '<div class="cat-mgr-name">' + escHtml(c.name) + '</div>' +
      '<div class="cat-mgr-badge">' + count + ' 個任務</div>' +
      delBtn +
    '</div>';
  });
  list.innerHTML = html;
}

// Close cat manager on overlay click
document.getElementById('catMgrOverlay').addEventListener('click', function(e) {
  if (e.target === document.getElementById('catMgrOverlay')) closeCatMgr();
});
document.getElementById('catMgrInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') addCustomCategory();
});

/* ═══════════════════════════════════════════
   REAL-TIME SYNC
   ═══════════════════════════════════════════ */
let ignoreNextUpdate = false;

function listenToTasks() {
  tasksRef.on('value', (snapshot) => {
    if (ignoreNextUpdate) { ignoreNextUpdate = false; return; }
    firebaseDataLoaded = true;
    const data = snapshot.val();
    if (data) {
      tasks = Object.keys(data).map(key => {
        const t = { id: key, ...data[key] };
        if (t.attachments && !Array.isArray(t.attachments)) {
          t.attachments = Object.values(t.attachments);
        }
        return t;
      });
    } else {
      seedDefaultTasks();
      return;
    }
    renderTasks();
  }, function(error) {
    var msg = String(error.message || error);
    if (msg.indexOf('permission') !== -1 || msg.indexOf('Permission') !== -1 || msg.indexOf('PERMISSION') !== -1) {
      showToast('⚠ 權限被拒！請到 Firebase Console 更新安全規則', true);
    } else {
      showToast('⚠ 同步失敗: ' + msg, true);
    }
  });
}

function seedDefaultTasks() {
  const updates = {};
  DEFAULT_TASKS.forEach((t, i) => {
    const key = 'task_' + Date.now() + '_' + i;
    updates[key] = { name: t.name, cat: t.cat, done: t.done, note: t.note, date: t.date, assignee: t.assignee || '', createdBy: myName, ts: Date.now() + i };
  });
  tasksRef.update(updates);
}

function saveTaskToCloud(id, data) {
  if (!isFirebaseReady) return;
  tasksRef.child(id).set(data);
}

function removeTaskFromCloud(id) {
  if (!isFirebaseReady) return;
  tasksRef.child(id).remove();
}

/* ═══════════════════════════════════════════
   PRESENCE
   ═══════════════════════════════════════════ */
function setupPresence() {
  const myPresRef = presenceRef.child(myName);
  myPresRef.set(true);
  myPresRef.onDisconnect().remove();

  presenceRef.on('value', (snapshot) => {
    const data = snapshot.val() || {};
    const kikiOnline = !!data['Kiki'];
    const jeffOnline = !!data['Jeff'];

    const tagK = $('#tagKiki');
    const tagJ = $('#tagJeff');
    if (tagK) {
      tagK.classList.toggle('is-online', kikiOnline);
      tagK.classList.toggle('is-me', myName === 'Kiki');
    }
    if (tagJ) {
      tagJ.classList.toggle('is-online', jeffOnline);
      tagJ.classList.toggle('is-me', myName === 'Jeff');
    }
  });
}

/* ═══════════════════════════════════════════
   Photo Upload — synced to Firebase
   ═══════════════════════════════════════════ */
function compressCouplePhoto(file) {
  return new Promise(function(resolve) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var img = new Image();
      img.onload = function() {
        var maxSize = 300;
        var w = img.width, h = img.height;
        if (w > maxSize || h > maxSize) {
          if (w > h) { h = Math.round(h * maxSize / w); w = maxSize; }
          else { w = Math.round(w * maxSize / h); h = maxSize; }
        }
        var canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        var result = canvas.toDataURL('image/jpeg', 0.5);
        resolve(result);
      };
      img.onerror = function() { resolve(null); };
      img.src = e.target.result;
    };
    reader.onerror = function() { resolve(null); };
    reader.readAsDataURL(file);
  });
}

function saveCouplePhoto(dataUrl) {
  if (!isFirebaseReady || !db) return;
  db.ref('rooms/' + roomCode + '/couplePhoto').set(dataUrl)
    .then(function() {
      showToast('♥ 合照已同步雲端！');
    })
    .catch(function(err) {
      showToast('⚠ 合照儲存失敗: ' + err.message, true);
    });
}

function loadCouplePhoto() {
  if (!isFirebaseReady || !db) return;
  db.ref('rooms/' + roomCode + '/couplePhoto').on('value', function(snapshot) {
    var data = snapshot.val();
    if (data) {
      var photoImg = $('#photoImg');
      var couplePhoto = $('#couplePhoto');
      if (photoImg) photoImg.src = data;
      if (couplePhoto) couplePhoto.classList.add('has-img');
    }
  }, function(err) { /* ignore */ });
}

function initPhotoUpload() {
  var couplePhoto = $('#couplePhoto');
  var photoInput  = $('#photoInput');
  var photoImg    = $('#photoImg');
  if (!photoInput) return;

  photoInput.addEventListener('change', async function() {
    var file = photoInput.files[0];
    if (!file) return;
    try {
      var url = URL.createObjectURL(file);
      if (photoImg) photoImg.src = url;
      if (couplePhoto) couplePhoto.classList.add('has-img');
    } catch(e) { /* ignore */ }
    showToast('♥ 正在壓縮合照...');
    try {
      var dataUrl = await compressCouplePhoto(file);
      if (dataUrl) {
        if (photoImg) photoImg.src = dataUrl;
        saveCouplePhoto(dataUrl);
      } else {
        showToast('⚠ 相片壓縮失敗', true);
      }
    } catch(e) {
      showToast('⚠ 相片處理失敗: ' + e, true);
    }
    photoInput.value = '';
  });
}

/* ═══════════════════════════════════════════
   Attachment Handling
   ═══════════════════════════════════════════ */
const MAX_IMG_SIZE = 800;
const MAX_FILE_B64 = 200000;

function isImageType(type) {
  return type && type.startsWith('image/');
}

function getFileIcon(name) {
  const ext = (name || '').split('.').pop().toLowerCase();
  const icons = {
    pdf: 'fa-file-pdf', doc: 'fa-file-word', docx: 'fa-file-word',
    xls: 'fa-file-excel', xlsx: 'fa-file-excel',
    txt: 'fa-file-lines', csv: 'fa-file-csv',
  };
  return icons[ext] || 'fa-file';
}

function compressImage(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        let w = img.width, h = img.height;
        if (w > MAX_IMG_SIZE || h > MAX_IMG_SIZE) {
          if (w > h) { h = Math.round(h * MAX_IMG_SIZE / w); w = MAX_IMG_SIZE; }
          else { w = Math.round(w * MAX_IMG_SIZE / h); h = MAX_IMG_SIZE; }
        }
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL('image/jpeg', 0.7));
      };
      img.onerror = () => resolve(null);
      img.src = e.target.result;
    };
    reader.onerror = () => resolve(null);
    reader.readAsDataURL(file);
  });
}

function fileToBase64(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.onerror = () => resolve(null);
    reader.readAsDataURL(file);
  });
}

async function processFiles(files) {
  for (const file of files) {
    if (isImageType(file.type)) {
      const data = await compressImage(file);
      if (data && data.length <= MAX_FILE_B64 * 4) {
        pendingAttachments.push({ name: file.name, type: file.type, data: data, isImage: true });
      } else {
        showToast('⚠ 相片太大', true);
      }
    } else {
      const data = await fileToBase64(file);
      if (data && data.length <= MAX_FILE_B64) {
        pendingAttachments.push({ name: file.name, type: file.type, data: data, isImage: false });
      } else {
        showToast('⚠ 文件太大 (最大~150KB)', true);
      }
    }
  }
  renderAttachPreviews();
}

function renderAttachPreviews() {
  const container = $('#attachPreviews');
  if (!container) return;
  container.innerHTML = pendingAttachments.map((a, i) => {
    if (a.isImage) {
      return '<div class="attach-preview"><img src="' + a.data + '" alt="' + escHtml(a.name) + '"><button class="remove-attach" data-idx="' + i + '"><i class="fa-solid fa-xmark"></i></button></div>';
    }
    return '<div class="attach-preview"><div class="file-icon"><i class="fa-solid ' + getFileIcon(a.name) + '"></i><span>' + escHtml(a.name) + '</span></div><button class="remove-attach" data-idx="' + i + '"><i class="fa-solid fa-xmark"></i></button></div>';
  }).join('');
  container.querySelectorAll('.remove-attach').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      pendingAttachments.splice(parseInt(btn.dataset.idx, 10), 1);
      renderAttachPreviews();
    });
  });
}

function initAttachInput() {
  const attachInput = $('#attachInput');
  if (!attachInput) return;
  attachInput.addEventListener('change', async () => {
    if (attachInput.files.length > 0) {
      await processFiles(Array.from(attachInput.files));
    }
    attachInput.value = '';
  });
}

function initLightbox() {
  const overlay = $('#lightboxOverlay');
  const img = $('#lightboxImg');
  const counter = $('#lightboxCounter');
  const fname = $('#lightboxFilename');

  function show() {
    const item = lightboxImages[lightboxIndex];
    if (!item) return;
    img.src = item.data;
    counter.textContent = (lightboxIndex + 1) + ' / ' + lightboxImages.length;
    fname.textContent = item.name || '';
  }

  $('#lightboxClose').addEventListener('click', () => overlay.classList.remove('open'));
  overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('open'); });
  $('#lightboxPrev').addEventListener('click', () => { lightboxIndex = (lightboxIndex - 1 + lightboxImages.length) % lightboxImages.length; show(); });
  $('#lightboxNext').addEventListener('click', () => { lightboxIndex = (lightboxIndex + 1) % lightboxImages.length; show(); });

  window._showLightbox = show;
}

function openLightbox(images, idx) {
  lightboxImages = images;
  lightboxIndex = idx || 0;
  window._showLightbox();
  $('#lightboxOverlay').classList.add('open');
}

/* ═══════════════════════════════════════════
   Render Helpers
   ═══════════════════════════════════════════ */
function getCat(id) {
  return CATEGORIES.find(c => c.id === id) || { name: id || '其他', icon: 'fa-tag', css: 'cat-custom' };
}

function formatDate(d) {
  if (!d) return '';
  const dt = new Date(d + 'T00:00:00');
  return (dt.getMonth() + 1) + '月' + dt.getDate() + '日';
}

function formatAssignee(a) {
  if (!a) return '';
  if (a === 'both') return '雙方';
  return a;
}

function updateStats() {
  const total = tasks.length;
  const done = tasks.filter(t => t.done).length;
  const pending = total - done;
  const pct = total ? Math.round(done / total * 100) : 0;
  $('#statTotal').textContent = total;
  $('#statPending').textContent = pending;
  $('#statDone').textContent = done;
  $('#progressFill').style.width = pct + '%';
  $('#progressText').textContent = pct + '% 完成';
}

function renderFilters() {
  let html = '<button class="filter-btn active" data-cat="all">全部</button>';
  for (const c of CATEGORIES) {
    html += '<button class="filter-btn" data-cat="' + c.id + '"><i class="fa-solid ' + c.icon + '"></i> ' + c.name + '</button>';
  }
  html += '<button class="cat-manage-btn" title="管理分類" onclick="openCatMgr()"><i class="fa-solid fa-gear"></i></button>';
  filtersEl.innerHTML = html;
  filtersEl.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      activeFilter = btn.dataset.cat;
      filtersEl.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b === btn));
      renderTasks();
    });
  });
  // Restore active filter
  filtersEl.querySelectorAll('.filter-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.cat === activeFilter);
  });
}

function renderTasks() {
  const filtered = activeFilter === 'all' ? tasks : tasks.filter(t => t.cat === activeFilter);

  if (filtered.length === 0) {
    if (!firebaseDataLoaded && firebaseConfig && firebaseConfig.databaseURL) {
      taskListEl.innerHTML = '<div class="empty"><i class="fa-solid fa-spinner fa-spin" style="font-size:1.5rem;color:var(--pink)"></i><p>載入中…</p></div>';
    } else {
      taskListEl.innerHTML = '<div class="empty"><i class="fa-regular fa-heart"></i><p>' +
        (tasks.length === 0 ? 'Kiki & Jeff，開始添加任務吧' : '此分類暫無任務') + '</p></div>';
    }
    updateStats();
    return;
  }

  const pendingItems = filtered.filter(t => !t.done).sort((a, b) => {
    if (a.date && b.date) return a.date.localeCompare(b.date);
    if (a.date) return -1;
    if (b.date) return 1;
    return 0;
  });
  const doneItems = filtered.filter(t => t.done);

  let html = '';
  if (pendingItems.length) {
    html += '<div class="task-group-label"><i class="fa-regular fa-clock"></i> 待辦 (' + pendingItems.length + ')</div>';
    pendingItems.forEach((t, i) => { html += cardHTML(t, i); });
  }
  if (doneItems.length) {
    html += '<div class="task-group-label"><i class="fa-solid fa-heart"></i> 已完成 (' + doneItems.length + ')</div>';
    doneItems.forEach((t, i) => { html += cardHTML(t, i + pendingItems.length); });
  }
  taskListEl.innerHTML = html;
  bindTaskEvents();
  updateStats();
}

function cardHTML(t, idx) {
  const cat = getCat(t.cat);
  const checkedClass = t.done ? ' checked' : '';
  const doneClass = t.done ? ' done' : '';
  const dateStr = t.date ? '<span class="task-date"><i class="fa-regular fa-calendar"></i>' + formatDate(t.date) + '</span>' : '';
  const noteStr = t.note ? '<div class="task-note">' + escHtml(t.note) + '</div>' : '';
  const delay = Math.min(idx * 0.04, 0.4);

  // Assignee badge
  let assigneeStr = '';
  if (t.assignee) {
    const aIcon = t.assignee === 'both' ? 'fa-user-group' : 'fa-user';
    assigneeStr = '<span class="task-assignee"><i class="fa-solid ' + aIcon + '"></i> ' + formatAssignee(t.assignee) + '</span>';
  }

  // Attachment thumbnails
  let attachStr = '';
  const atts = t.attachments || [];
  if (atts.length > 0) {
    const images = atts.filter(a => a.isImage);
    const files = atts.filter(a => !a.isImage);
    attachStr = '<div class="task-thumbs">';
    images.forEach((a, i) => {
      attachStr += '<div class="task-thumb" data-task-id="' + t.id + '" data-img-idx="' + i + '"><img src="' + a.data + '" alt="' + escHtml(a.name) + '"></div>';
    });
    files.forEach(a => {
      attachStr += '<div class="task-thumb" title="' + escHtml(a.name) + '"><span class="thumb-file"><i class="fa-solid ' + getFileIcon(a.name) + '"></i></span></div>';
    });
    attachStr += '</div>';
    if (atts.length > 0) {
      attachStr += '<div class="task-attach-count"><i class="fa-solid fa-paperclip"></i> ' + atts.length + ' 個附件</div>';
    }
  }

  return '<div class="task-card' + doneClass + '" data-id="' + t.id + '" style="animation-delay:' + delay + 's">' +
    '<div class="ck' + checkedClass + '" data-id="' + t.id + '" role="checkbox" tabindex="0"></div>' +
    '<div class="task-body">' +
      '<div class="task-text">' + escHtml(t.name) + '</div>' +
      noteStr +
      attachStr +
      '<div class="task-meta"><span class="task-cat ' + cat.css + '"><i class="fa-solid ' + cat.icon + '"></i> ' + cat.name + '</span>' + assigneeStr + dateStr + '</div>' +
    '</div>' +
    '<div class="task-actions">' +
      '<button class="act-btn edit" data-id="' + t.id + '" aria-label="編輯"><i class="fa-solid fa-pen"></i></button>' +
      '<button class="act-btn del" data-id="' + t.id + '" aria-label="刪除"><i class="fa-solid fa-trash-can"></i></button>' +
    '</div>' +
  '</div>';
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function bindTaskEvents() {
  taskListEl.querySelectorAll('.ck').forEach(el => {
    el.addEventListener('click', () => toggleDone(el.dataset.id));
    el.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleDone(el.dataset.id); }
    });
  });
  taskListEl.querySelectorAll('.act-btn.edit').forEach(el => {
    el.addEventListener('click', () => openEdit(el.dataset.id));
  });
  taskListEl.querySelectorAll('.act-btn.del').forEach(el => {
    el.addEventListener('click', () => askDelete(el.dataset.id));
  });
  taskListEl.querySelectorAll('.task-thumb[data-task-id]').forEach(el => {
    el.addEventListener('click', () => {
      const taskId = el.dataset.taskId;
      const imgIdx = parseInt(el.dataset.imgIdx, 10);
      const t = tasks.find(x => x.id === taskId);
      if (!t || !t.attachments) return;
      const images = t.attachments.filter(a => a.isImage);
      if (images.length > 0) openLightbox(images, imgIdx);
    });
  });
}

/* ═══════════════════════════════════════════
   CRUD (synced to Firebase)
   ═══════════════════════════════════════════ */
function toggleDone(id) {
  const t = tasks.find(x => x.id === id);
  if (!t) return;
  t.done = !t.done;
  saveTaskToCloud(id, taskData(t));
  showToast(t.done ? '♥ 已完成' : '↩ 已恢復');
}

function taskData(t) {
  const d = { name: t.name, cat: t.cat, done: t.done, note: t.note || '', date: t.date || '', assignee: t.assignee || '', createdBy: t.createdBy || myName, ts: t.ts || Date.now() };
  if (t.attachments && t.attachments.length > 0) {
    d.attachments = t.attachments;
  }
  return d;
}

function openAdd() {
  editingId = null;
  pendingAttachments = [];
  $('#modalTitle').innerHTML = '<i class="fa-solid fa-heart"></i> 新增任務';
  $('#inputName').value = '';
  $('#inputNote').value = '';
  $('#inputCat').value = 'other';
  $('#inputDate').value = '';
  $('#inputAssignee').value = '';
  $('#btnSave').textContent = '新增';
  renderAttachPreviews();
  modalOverlay.classList.add('open');
  setTimeout(() => $('#inputName').focus(), 350);
}

function openEdit(id) {
  const t = tasks.find(x => x.id === id);
  if (!t) return;
  editingId = id;
  pendingAttachments = t.attachments ? t.attachments.map(a => ({...a})) : [];
  $('#modalTitle').innerHTML = '<i class="fa-solid fa-pen"></i> 編輯任務';
  $('#inputName').value = t.name;
  $('#inputNote').value = t.note || '';
  $('#inputCat').value = t.cat;
  $('#inputDate').value = t.date || '';
  $('#inputAssignee').value = t.assignee || '';
  $('#btnSave').textContent = '儲存';
  renderAttachPreviews();
  modalOverlay.classList.add('open');
  setTimeout(() => $('#inputName').focus(), 350);
}

function saveTask() {
  const name = $('#inputName').value.trim();
  if (!name) { $('#inputName').style.borderColor = 'var(--danger)'; return; }
  const cat = $('#inputCat').value;
  const note = $('#inputNote').value.trim();
  const date = $('#inputDate').value;
  const assignee = $('#inputAssignee').value;
  const attachments = pendingAttachments.length > 0 ? pendingAttachments.slice() : null;

  if (editingId !== null) {
    const t = tasks.find(x => x.id === editingId);
    if (t) {
      t.name = name; t.cat = cat; t.note = note; t.date = date; t.assignee = assignee;
      t.attachments = attachments || [];
      saveTaskToCloud(editingId, taskData(t));
    }
    showToast('♥ 已更新');
  } else {
    const key = 'task_' + Date.now();
    const newTask = { name: name, cat: cat, done: false, note: note, date: date, assignee: assignee, createdBy: myName, ts: Date.now() };
    if (attachments) newTask.attachments = attachments;
    saveTaskToCloud(key, newTask);
    showToast('♥ 已新增');
  }
  pendingAttachments = [];
  closeModal();
}

function askDelete(id) {
  pendingDeleteId = id;
  const t = tasks.find(x => x.id === id);
  $('#confirmMsg').textContent = '確定要刪除「' + (t ? t.name : '') + '」？';
  confirmOvl.classList.add('open');
}

function doDelete() {
  if (pendingDeleteId !== null) {
    removeTaskFromCloud(pendingDeleteId);
    showToast('已刪除');
  }
  pendingDeleteId = null;
  confirmOvl.classList.remove('open');
}

function closeModal() { modalOverlay.classList.remove('open'); editingId = null; pendingAttachments = []; }

/* ═══════════════════════════════════════════
   Toast
   ═══════════════════════════════════════════ */
let toastTimer;
function showToast(msg, longer) {
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toastEl.classList.remove('show'), longer ? 6000 : 1800);
}

/* ═══════════════════════════════════════════
   Settings (reset config)
   ═══════════════════════════════════════════ */
$('#settingsBtn').addEventListener('click', () => {
  pendingDeleteId = null;
  $('#confirmMsg').textContent = '要切換用戶嗎？';
  $('#confirmYes').textContent = '切換';
  $('#confirmYes').className = 'btn btn-primary';
  confirmOvl.classList.add('open');
  const origHandler = doDelete;
  const resetHandler = () => {
    store.del('v2_name');
    myName = '';
    isFirebaseReady = false;
    firebaseListenerAttached = false;
    firebaseDataLoaded = false;
    showScreen('setupScreen');
  };
  $('#confirmYes').onclick = () => { confirmOvl.classList.remove('open'); $('#confirmYes').className = 'btn btn-danger'; resetHandler(); };
  $('#confirmNo').onclick = () => {
    confirmOvl.classList.remove('open');
    $('#confirmYes').textContent = '刪除';
    $('#confirmYes').className = 'btn btn-danger';
    $('#confirmYes').onclick = origHandler;
  };
});

/* ═══════════════════════════════════════════
   Init App
   ═══════════════════════════════════════════ */
function initApp() {
  initCatSelect();
  renderFilters();
  initPhotoUpload();
  initAttachInput();
  initLightbox();

  $('#fabAdd').addEventListener('click', openAdd);
  $('#btnCancel').addEventListener('click', closeModal);
  $('#btnSave').addEventListener('click', saveTask);
  $('#confirmNo').addEventListener('click', () => { confirmOvl.classList.remove('open'); });
  $('#confirmYes').addEventListener('click', doDelete);
  modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) closeModal(); });
  confirmOvl.addEventListener('click', e => { if (e.target === confirmOvl) confirmOvl.classList.remove('open'); });
  $('#inputName').addEventListener('keydown', e => { if (e.key === 'Enter') saveTask(); });
  $('#inputName').addEventListener('input', () => { $('#inputName').style.borderColor = ''; });
}

function initCatSelect() {
  const sel = $('#inputCat');
  if (sel) sel.innerHTML = CATEGORIES.map(c => '<option value="' + c.id + '">' + c.name + '</option>').join('');
}
</script>
</body>
</html>
