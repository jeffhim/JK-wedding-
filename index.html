<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#c2727e">
<title>Kiki & Jeff Wedding Planner</title>
<link rel="icon" type="image/png" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;0,800;1,400;1,600&family=Quicksand:wght@300;400;500;600;700&family=Great+Vibes&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}

:root{
  --bg:#fff8f6;--bg2:#ffffff;--bg3:#fff0ec;--bg-hover:#ffe8e2;
  --text:#4a2c2a;--text2:#8a6060;--text3:#b89494;
  --pink:#e07088;--pink-deep:#c2556a;--pink-light:#fce4e8;--pink-glow:#ff8fa3;
  --gold:#d4a855;--gold-light:#f5e6c4;
  --cream:#fdf6f0;--blush:#f8d7da;
  --border:#f0d4d4;--shadow:0 4px 20px rgba(200,100,100,.1);
  --done:#8fbf7e;--done-bg:#f0f8ec;
  --danger:#d46a6a;--danger-bg:#fce8e8;
  --radius:16px;--radius-sm:12px;
  --font-script:'Great Vibes',cursive;
  --font-display:'Playfair Display',serif;
  --font-body:'Quicksand',sans-serif;
  --cat-venue:#c27878;--cat-photo:#a87cb2;--cat-floral:#7eaa8e;
  --cat-attire:#c2728e;--cat-guest:#7899b5;--cat-food:#b5a068;--cat-other:#9a8a8a;
  --cat-orphan:#b07070;
  --online:#6ec47e;
}

.dark{
  --bg:#1c1215;--bg2:#281b1f;--bg3:#342228;--bg-hover:#3e2a30;
  --text:#f0dde0;--text2:#c0a0a5;--text3:#8a7075;
  --pink:#e88098;--pink-deep:#d46880;--pink-light:#3a2028;--pink-glow:#ff6080;
  --gold:#e0b860;--gold-light:#3a3020;
  --cream:#2a1e1e;--blush:#3a2228;
  --border:#402830;--shadow:0 4px 24px rgba(0,0,0,.4);
  --done-bg:#243026;--danger-bg:#382020;
  --cat-venue:#e09898;--cat-photo:#c8a0d4;--cat-floral:#80cc9e;
  --cat-attire:#e098b0;--cat-guest:#98b8d4;--cat-food:#d4c080;--cat-other:#b0a0a0;
  --cat-orphan:#d09090;
  --online:#80e090;
}

html{font-size:16px;-webkit-text-size-adjust:100%}

body{
  font-family:var(--font-body);color:var(--text);background:var(--bg);
  min-height:100vh;min-height:100dvh;overflow-x:hidden;
  transition:background .4s,color .4s;
}

::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* â”€â”€â”€ Floating Hearts BG â”€â”€â”€ */
.hearts-bg{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.float-heart{
  position:absolute;bottom:-40px;
  font-size:1rem;opacity:.12;color:var(--pink);
  animation:floatUp linear infinite;
}
.dark .float-heart{opacity:.06}
@keyframes floatUp{
  0%{transform:translateY(0) rotate(0deg) scale(1);opacity:.12}
  50%{opacity:.18}
  100%{transform:translateY(-110vh) rotate(360deg) scale(.6);opacity:0}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THREE SCREENS: PIN â†’ NAME â†’ APP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen{display:none !important;min-height:100vh;min-height:100dvh}
.screen.active{display:block !important;animation:screenIn .35s ease-out}
#pinScreen.active,#setupScreen.active{display:flex !important}
@keyframes screenIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€â”€ Setup Screen â”€â”€â”€ */
#pinScreen,#setupScreen{
  position:relative;z-index:1;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:2rem 1.2rem;
}
.setup-card{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);
  padding:2rem 1.5rem;max-width:440px;width:100%;box-shadow:var(--shadow);
  animation:cardIn .5s ease-out;
}
.setup-card h1{
  font-family:var(--font-script);font-size:2.4rem;color:var(--pink-deep);
  text-align:center;margin-bottom:.2rem;
}
.setup-card .setup-sub{
  font-family:var(--font-display);font-style:italic;font-size:.9rem;
  color:var(--text2);text-align:center;margin-bottom:1.5rem;
}

/* Steps indicator */
.steps-indicator{
  display:flex;justify-content:center;gap:.6rem;margin-bottom:1.8rem;
}
.step-dot{
  width:10px;height:10px;border-radius:50%;background:var(--border);
  transition:all .3s;
}
.step-dot.active{background:var(--pink);transform:scale(1.3)}
.step-dot.done{background:var(--done)}

/* Setup step content */
.setup-step{display:none}
.setup-step.active{display:block;animation:fadeSlide .35s ease-out}
@keyframes fadeSlide{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-12px)}40%{transform:translateX(10px)}60%{transform:translateX(-6px)}80%{transform:translateX(4px)}}

.guide-box{
  background:var(--bg3);border-radius:var(--radius-sm);padding:1rem;
  margin-bottom:1rem;font-size:.82rem;line-height:1.7;color:var(--text2);
}
.guide-box strong{color:var(--pink-deep)}
.guide-box ol{padding-left:1.2rem;margin:.4rem 0}
.guide-box li{margin-bottom:.4rem}
.guide-box code{
  background:var(--pink-light);padding:.1rem .4rem;border-radius:4px;
  font-size:.78rem;color:var(--pink-deep);font-family:monospace;
}

.setup-label{
  display:block;font-size:.78rem;color:var(--text2);margin-bottom:.3rem;
  font-weight:600;letter-spacing:.04em;
}
.setup-input{
  width:100%;padding:.7rem .85rem;border:1.5px solid var(--border);
  border-radius:var(--radius-sm);background:var(--bg);color:var(--text);
  font-family:var(--font-body);font-size:1rem;transition:border-color .2s;
  -webkit-appearance:none;
}
.setup-input:focus{outline:none;border-color:var(--pink);box-shadow:0 0 0 3px var(--pink-light)}
textarea.setup-input{resize:vertical;min-height:100px;font-family:monospace;font-size:.82rem}

.setup-row{margin-bottom:1rem}
.setup-error{font-size:.75rem;color:var(--danger);margin-top:.3rem;display:none}
.setup-error.show{display:block}

.setup-btn-row{display:flex;gap:.5rem;margin-top:1.2rem}
.setup-btn{
  flex:1;padding:.75rem 1rem;border-radius:var(--radius-sm);border:none;
  cursor:pointer;font-family:var(--font-body);font-size:.9rem;font-weight:600;
  transition:all .25s;
}
.setup-btn-primary{
  background:linear-gradient(135deg,var(--pink),var(--pink-deep));color:#fff;
  box-shadow:0 2px 12px rgba(200,80,100,.25);
}
.setup-btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(200,80,100,.35)}
.setup-btn-secondary{background:var(--bg3);color:var(--text2)}
.setup-btn-secondary:hover{background:var(--bg-hover)}

.setup-divider{
  text-align:center;margin:1.2rem 0;color:var(--text3);font-size:.8rem;
  display:flex;align-items:center;gap:.8rem;
}
.setup-divider::before,.setup-divider::after{
  content:'';flex:1;height:1px;background:var(--border);
}

/* Name select pills */
.name-select{display:flex;gap:.8rem;justify-content:center;margin:1rem 0}
.name-pill{
  padding:.8rem 1.8rem;border-radius:30px;border:2px solid var(--border);
  background:var(--bg);cursor:pointer;font-family:var(--font-display);
  font-size:1.1rem;font-weight:600;transition:all .3s;color:var(--text2);
}
.name-pill:hover{border-color:var(--pink);color:var(--pink)}
.name-pill.selected{
  border-color:var(--pink);background:linear-gradient(135deg,var(--pink),var(--pink-deep));
  color:#fff;transform:scale(1.05);box-shadow:0 4px 16px rgba(200,80,100,.3);
}
.name-pill i{margin-right:.3rem}

/* Sync status badge */
.sync-badge{
  display:inline-flex;align-items:center;gap:.35rem;
  font-size:.7rem;font-weight:600;padding:.3rem .7rem;border-radius:15px;
  background:var(--bg3);color:var(--text3);
  position:absolute;top:.8rem;right:.8rem;
}
.sync-badge.online{background:color-mix(in srgb,var(--online) 15%,transparent);color:var(--online)}
.sync-badge .dot{
  width:7px;height:7px;border-radius:50%;background:currentColor;
}
.sync-badge.online .dot{animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN APP SCREEN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€â”€ Hero â”€â”€â”€ */
.hero{
  position:relative;z-index:1;text-align:center;
  padding:2rem 1rem 1.2rem;
  background:linear-gradient(170deg,var(--pink-light) 0%,var(--bg) 60%,var(--cream) 100%);
  overflow:hidden;
}
.hero::before{
  content:'';position:absolute;top:-50%;left:-30%;width:160%;height:160%;
  background:radial-gradient(ellipse at 40% 30%,var(--pink-light) 0%,transparent 55%);
  opacity:.6;pointer-events:none;
}

.couple-photo-wrap{
  display:block;position:relative;z-index:2;margin:0 auto .6rem;width:100px;height:100px;cursor:pointer;
}
.couple-photo{
  width:100px;height:100px;border-radius:50%;object-fit:cover;
  border:4px solid var(--pink);box-shadow:0 0 0 5px var(--pink-light),0 6px 30px rgba(200,80,100,.2);
  background:var(--pink-light);display:flex;align-items:center;justify-content:center;
  cursor:pointer;overflow:hidden;transition:transform .3s,box-shadow .3s;position:relative;
}
.couple-photo:hover{transform:scale(1.04);box-shadow:0 0 0 5px var(--pink-light),0 8px 36px rgba(200,80,100,.3)}
.couple-photo img{width:100%;height:100%;object-fit:cover;display:none}
.couple-photo .placeholder{color:var(--pink);font-size:2rem;opacity:.5;transition:opacity .2s}
.couple-photo:hover .placeholder{opacity:.8}
.couple-photo.has-img .placeholder{display:none}
.couple-photo.has-img img{display:block}
.photo-hint{font-size:.65rem;color:var(--text3);margin-top:.2rem;position:relative;z-index:2;font-style:italic}

.hero-names{
  position:relative;z-index:2;font-family:var(--font-script);font-size:2.6rem;
  color:var(--pink-deep);line-height:1.2;text-shadow:0 2px 15px rgba(200,80,100,.12);
}
.hero-amp{
  display:inline-block;font-family:var(--font-display);font-style:italic;
  font-size:1.4rem;color:var(--gold);margin:0 .15rem;vertical-align:middle;
  position:relative;top:-2px;
}
.hero-heart{display:block;font-size:.9rem;color:var(--pink);margin:.15rem auto;animation:heartbeat 1.8s ease-in-out infinite}
@keyframes heartbeat{0%,100%{transform:scale(1)}15%{transform:scale(1.25)}30%{transform:scale(1)}45%{transform:scale(1.15)}60%{transform:scale(1)}}
.hero-sub{
  position:relative;z-index:2;font-family:var(--font-display);font-style:italic;
  font-size:.85rem;color:var(--text2);letter-spacing:.08em;
}
.hero-sub i{color:var(--gold);margin:0 .25rem;font-size:.6rem}
.swirl{
  position:relative;z-index:2;margin:.4rem auto 0;width:100px;height:2px;
  background:linear-gradient(90deg,transparent,var(--gold),transparent);border-radius:1px;
}

/* â”€â”€â”€ Countdown â”€â”€â”€ */
.countdown-wrap{
  position:relative;z-index:2;
  margin:.8rem auto 0;padding:.6rem .8rem;
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);
  max-width:360px;box-shadow:0 2px 12px rgba(200,80,100,.08);
}
.countdown-title{
  font-family:var(--font-display);font-style:italic;font-size:.72rem;
  color:var(--text3);letter-spacing:.06em;margin-bottom:.35rem;
}
.countdown-title i{color:var(--gold);margin-right:.3rem;font-size:.6rem}
.countdown-date{font-size:.65rem;color:var(--text3);margin-top:.15rem;font-style:italic}
.countdown-grid{display:flex;justify-content:center;gap:.5rem}
.countdown-cell{text-align:center;min-width:52px}
.countdown-num{
  font-family:var(--font-display);font-size:1.5rem;font-weight:700;
  color:var(--pink-deep);line-height:1.1;
  background:linear-gradient(135deg,var(--pink),var(--gold));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
}
.countdown-unit{font-size:.6rem;color:var(--text3);font-weight:600;letter-spacing:.04em;text-transform:uppercase}

/* Online bar */
.online-bar{
  position:relative;z-index:2;display:flex;justify-content:center;gap:.6rem;
  margin-top:.6rem;
}
.online-tag{
  display:inline-flex;align-items:center;gap:.3rem;font-size:.68rem;font-weight:600;
  padding:.2rem .6rem;border-radius:12px;background:var(--bg2);color:var(--text3);
  border:1px solid var(--border);
}
.online-tag.is-online{border-color:var(--online);color:var(--online)}
.online-tag .dot{width:6px;height:6px;border-radius:50%;background:currentColor}
.online-tag.is-online .dot{animation:pulse 2s infinite}
.online-tag.is-me{font-weight:700}

/* â”€â”€â”€ Stats â”€â”€â”€ */
.stats{
  display:flex;justify-content:center;gap:0;padding:0;
  background:var(--bg2);border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:50;backdrop-filter:blur(14px);
}
.stat{flex:1;text-align:center;padding:.6rem .5rem;border-right:1px solid var(--border);position:relative}
.stat:last-child{border-right:none}
.stat-num{font-family:var(--font-display);font-size:1.4rem;font-weight:700;color:var(--pink)}
.stat-label{font-size:.6rem;color:var(--text3);letter-spacing:.08em;text-transform:uppercase;font-weight:600}

/* â”€â”€â”€ Progress â”€â”€â”€ */
.progress-wrap{padding:.6rem 1.2rem .2rem;max-width:640px;margin:0 auto}
.progress-bar{height:10px;background:var(--bg3);border-radius:5px;overflow:hidden;box-shadow:inset 0 1px 3px rgba(0,0,0,.06)}
.progress-fill{
  height:100%;border-radius:5px;transition:width .6s cubic-bezier(.25,.8,.25,1);
  background:linear-gradient(90deg,var(--pink),var(--pink-glow),var(--gold));
  background-size:200% 100%;animation:gradientShift 3s ease infinite;position:relative;
}
@keyframes gradientShift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.progress-fill::after{
  content:'';position:absolute;inset:0;
  background:linear-gradient(90deg,transparent 30%,rgba(255,255,255,.3) 50%,transparent 70%);
  animation:shimmer 2.5s infinite;
}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.progress-text{font-size:.7rem;color:var(--text3);text-align:right;margin-top:.15rem;font-weight:500}

/* â”€â”€â”€ Filters â”€â”€â”€ */
.filters{
  display:flex;gap:.4rem;padding:.6rem .8rem;overflow-x:auto;
  max-width:640px;margin:0 auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;
}
.filters::-webkit-scrollbar{display:none}
.filter-btn{
  flex-shrink:0;padding:.38rem .75rem;border-radius:20px;border:1.5px solid var(--border);
  background:var(--bg2);color:var(--text2);font-size:.76rem;cursor:pointer;
  font-family:var(--font-body);font-weight:500;transition:all .2s;white-space:nowrap;
}
.filter-btn:hover{border-color:var(--pink);color:var(--pink)}
.filter-btn.active{
  background:linear-gradient(135deg,var(--pink),var(--pink-deep));color:#fff;border-color:transparent;
  box-shadow:0 2px 10px rgba(200,80,100,.25);
}
.filter-btn.orphan-filter{
  border-style:dashed;border-color:var(--cat-orphan);color:var(--cat-orphan);
}
.filter-btn.orphan-filter.active{
  background:var(--cat-orphan);color:#fff;border-color:transparent;
}

/* â”€â”€â”€ Category Manage Button â”€â”€â”€ */
.cat-manage-btn{
  flex-shrink:0;width:28px;height:28px;border-radius:50%;border:1.5px dashed var(--border);
  background:transparent;color:var(--text3);font-size:.7rem;cursor:pointer;
  display:flex;align-items:center;justify-content:center;transition:all .2s;
}
.cat-manage-btn:hover{border-color:var(--pink);color:var(--pink);background:var(--pink-light)}

/* â”€â”€â”€ Task List â”€â”€â”€ */
.task-list{max-width:640px;margin:0 auto;padding:.4rem 1rem 7rem;position:relative;z-index:1}
.task-group-label{
  font-family:var(--font-display);font-size:.95rem;font-weight:600;
  color:var(--text2);margin:1rem 0 .4rem .2rem;display:flex;align-items:center;gap:.4rem;
}
.task-group-label i{font-size:.65rem;color:var(--pink)}

.task-card{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);
  padding:.75rem .85rem;margin-bottom:.5rem;display:flex;align-items:flex-start;gap:.65rem;
  transition:all .3s cubic-bezier(.25,.8,.25,1);position:relative;animation:cardIn .4s ease-out both;
}
.task-card:hover{box-shadow:var(--shadow);border-color:var(--pink);transform:translateY(-1px)}
.task-card.done{opacity:.55}
.task-card.done .task-text{text-decoration:line-through;color:var(--text3)}
@keyframes cardIn{from{opacity:0;transform:translateY(12px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}

/* â”€â”€â”€ Checkbox (Heart) â”€â”€â”€ */
.ck{
  width:26px;height:26px;flex-shrink:0;margin-top:1px;cursor:pointer;position:relative;
  display:flex;align-items:center;justify-content:center;font-size:1.3rem;color:var(--border);transition:all .3s;
}
.ck::before{content:'\f004';font-family:'Font Awesome 6 Free';font-weight:400;transition:all .3s}
.ck:hover{color:var(--pink);transform:scale(1.15)}
.ck.checked{color:var(--pink)}
.ck.checked::before{font-weight:900;animation:heartPop .4s ease}
@keyframes heartPop{0%{transform:scale(1)}30%{transform:scale(1.4)}60%{transform:scale(.9)}100%{transform:scale(1)}}

/* â”€â”€â”€ Task Content â”€â”€â”€ */
.task-body{flex:1;min-width:0}
.task-text{font-size:.88rem;line-height:1.45;word-break:break-word;font-weight:500}
.task-note{font-size:.74rem;color:var(--text3);margin-top:.12rem;line-height:1.35}
.task-meta{display:flex;align-items:center;gap:.4rem;margin-top:.2rem;flex-wrap:wrap}
.task-cat{font-size:.6rem;padding:.12rem .45rem;border-radius:10px;font-weight:600;letter-spacing:.03em}
.task-date{font-size:.66rem;color:var(--text3);font-weight:500}
.task-date i{margin-right:.12rem;font-size:.58rem}
.task-assignee{
  font-size:.6rem;padding:.12rem .45rem;border-radius:10px;font-weight:600;
  background:color-mix(in srgb,var(--gold) 18%,transparent);color:var(--gold);
  display:inline-flex;align-items:center;gap:.2rem;
}
.task-assignee i{font-size:.5rem}

.cat-venue{background:color-mix(in srgb,var(--cat-venue) 15%,transparent);color:var(--cat-venue)}
.cat-photo{background:color-mix(in srgb,var(--cat-photo) 15%,transparent);color:var(--cat-photo)}
.cat-floral{background:color-mix(in srgb,var(--cat-floral) 15%,transparent);color:var(--cat-floral)}
.cat-attire{background:color-mix(in srgb,var(--cat-attire) 15%,transparent);color:var(--cat-attire)}
.cat-guest{background:color-mix(in srgb,var(--cat-guest) 15%,transparent);color:var(--cat-guest)}
.cat-food{background:color-mix(in srgb,var(--cat-food) 15%,transparent);color:var(--cat-food)}
.cat-other{background:color-mix(in srgb,var(--cat-other) 15%,transparent);color:var(--cat-other)}
.cat-custom{background:color-mix(in srgb,var(--pink) 12%,transparent);color:var(--pink)}
.cat-orphan{background:color-mix(in srgb,var(--cat-orphan) 15%,transparent);color:var(--cat-orphan);border:1px dashed var(--cat-orphan)}

/* â”€â”€â”€ Task Actions â”€â”€â”€ */
.task-actions{display:flex;gap:.2rem;flex-shrink:0;opacity:0;transition:opacity .2s}
.task-card:hover .task-actions{opacity:1}
@media(hover:none){.task-actions{opacity:1}}
.act-btn{
  width:30px;height:30px;border-radius:10px;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:.73rem;
  background:transparent;color:var(--text3);transition:all .2s;
}
.act-btn:hover{background:var(--bg3);color:var(--pink)}
.act-btn.del:hover{background:var(--danger-bg);color:var(--danger)}

/* â”€â”€â”€ FAB â”€â”€â”€ */
.fab{
  position:fixed;bottom:1.5rem;right:1.5rem;width:56px;height:56px;border-radius:50%;border:none;
  cursor:pointer;z-index:60;background:linear-gradient(135deg,var(--pink),var(--pink-deep));
  color:#fff;font-size:1.3rem;box-shadow:0 4px 24px rgba(200,80,100,.4);
  display:flex;align-items:center;justify-content:center;transition:transform .3s,box-shadow .3s;
}
.fab:hover{transform:scale(1.1) rotate(90deg);box-shadow:0 6px 32px rgba(200,80,100,.5)}
.fab:active{transform:scale(.92) rotate(90deg)}

/* Settings gear */
.settings-btn{
  position:fixed;bottom:1.5rem;left:1.5rem;width:42px;height:42px;border-radius:50%;border:none;
  cursor:pointer;z-index:60;background:var(--bg2);color:var(--text3);font-size:.95rem;
  box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;
  transition:all .3s;border:1px solid var(--border);
}
.settings-btn:hover{color:var(--pink);transform:rotate(90deg)}

/* â”€â”€â”€ Modal â”€â”€â”€ */
.modal-overlay{
  position:fixed;inset:0;background:rgba(60,20,30,.5);z-index:100;
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;visibility:hidden;transition:all .3s;backdrop-filter:blur(4px);
}
.modal-overlay.open{opacity:1;visibility:visible}
.modal{
  background:var(--bg2);border-radius:var(--radius) var(--radius) 0 0;
  width:100%;max-width:480px;max-height:85vh;overflow-y:auto;
  transform:translateY(100%);transition:transform .4s cubic-bezier(.32,.72,.32,1);
  padding:1.3rem 1.2rem 2rem;
}
.modal-overlay.open .modal{transform:translateY(0)}
@media(min-width:600px){
  .modal-overlay{align-items:center}
  .modal{border-radius:var(--radius);max-height:80vh;transform:translateY(30px) scale(.95)}
  .modal-overlay.open .modal{transform:translateY(0) scale(1)}
}
.modal-handle{width:36px;height:4px;border-radius:2px;background:var(--border);margin:0 auto .6rem}
@media(min-width:600px){.modal-handle{display:none}}
.modal h2{font-family:var(--font-display);font-size:1.3rem;font-weight:600;color:var(--pink-deep);margin-bottom:.7rem;text-align:center}
.modal h2 i{margin-right:.3rem;font-size:.95rem}
.modal label{display:block;font-size:.73rem;color:var(--text2);margin-bottom:.2rem;letter-spacing:.04em;font-weight:600}
.modal input[type="text"],.modal input[type="date"],.modal textarea,.modal select{
  width:100%;padding:.6rem .8rem;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  background:var(--bg);color:var(--text);font-family:var(--font-body);font-size:1rem;
  transition:border-color .2s;-webkit-appearance:none;appearance:none;
}
.modal input:focus,.modal textarea:focus,.modal select:focus{outline:none;border-color:var(--pink);box-shadow:0 0 0 3px var(--pink-light)}
.modal textarea{resize:vertical;min-height:50px}
.form-row{margin-bottom:.75rem}
.form-row-half{display:grid;grid-template-columns:1fr 1fr;gap:.7rem}
.form-row-third{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.7rem}
.btn-row{display:flex;gap:.5rem;margin-top:1rem}
.btn{
  flex:1;padding:.7rem 1rem;border-radius:var(--radius-sm);border:none;cursor:pointer;
  font-family:var(--font-body);font-size:.86rem;font-weight:600;transition:all .25s;
}
.btn-primary{background:linear-gradient(135deg,var(--pink),var(--pink-deep));color:#fff;box-shadow:0 2px 12px rgba(200,80,100,.25)}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(200,80,100,.35)}
.btn-secondary{background:var(--bg3);color:var(--text2)}
.btn-secondary:hover{background:var(--bg-hover)}
.btn-danger{background:var(--danger);color:#fff}
.btn-danger:hover{opacity:.85}

/* â”€â”€â”€ Assignee pills in modal â”€â”€â”€ */
.assignee-pills{display:flex;gap:.5rem;flex-wrap:wrap}
.assignee-pill{
  padding:.45rem .9rem;border-radius:20px;border:1.5px solid var(--border);
  background:var(--bg);color:var(--text2);font-size:.82rem;cursor:pointer;
  font-weight:600;transition:all .2s;
}
.assignee-pill:hover{border-color:var(--pink);color:var(--pink)}
.assignee-pill.active{
  border-color:var(--pink);background:linear-gradient(135deg,var(--pink),var(--pink-deep));
  color:#fff;box-shadow:0 2px 8px rgba(200,80,100,.2);
}
.assignee-pill i{margin-right:.2rem;font-size:.7rem}

/* â”€â”€â”€ Category Manager Modal â”€â”€â”€ */
.cat-mgr-list{margin:.6rem 0;max-height:50vh;overflow-y:auto}
.cat-mgr-item{
  display:flex;align-items:center;gap:.4rem;padding:.45rem .5rem;
  border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:.35rem;
  background:var(--bg);transition:background .2s;
}
.cat-mgr-item:hover{background:var(--bg3)}
.cat-mgr-item.dragging{opacity:.5;border-style:dashed}
.cat-mgr-icon{font-size:.8rem;width:22px;text-align:center;color:var(--pink);flex-shrink:0}
.cat-mgr-name{flex:1;font-size:.82rem;font-weight:600;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cat-mgr-name-input{
  flex:1;font-size:.82rem;font-weight:600;font-family:var(--font-body);
  border:1.5px solid var(--pink);border-radius:6px;padding:.2rem .4rem;
  background:var(--bg);color:var(--text);outline:none;min-width:0;
}
.cat-mgr-badge{font-size:.58rem;color:var(--text3);padding:.1rem .35rem;border-radius:8px;background:var(--bg3);white-space:nowrap;flex-shrink:0}
.cat-mgr-actions{display:flex;gap:.1rem;flex-shrink:0}
.cat-mgr-btn{
  width:26px;height:26px;border-radius:8px;border:none;cursor:pointer;
  background:transparent;color:var(--text3);font-size:.65rem;
  display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;
}
.cat-mgr-btn:hover{background:var(--bg3);color:var(--pink)}
.cat-mgr-btn.del:hover{background:var(--danger-bg);color:var(--danger)}
.cat-mgr-btn:disabled{opacity:.25;cursor:default;pointer-events:none}
.cat-mgr-add{
  display:flex;gap:.4rem;margin-top:.5rem;
}
.cat-mgr-add input{
  flex:1;padding:.5rem .7rem;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  background:var(--bg);color:var(--text);font-family:var(--font-body);font-size:.88rem;
}
.cat-mgr-add input:focus{outline:none;border-color:var(--pink)}
.cat-mgr-add button{
  padding:.5rem .8rem;border-radius:var(--radius-sm);border:none;cursor:pointer;
  background:linear-gradient(135deg,var(--pink),var(--pink-deep));color:#fff;
  font-family:var(--font-body);font-size:.82rem;font-weight:600;white-space:nowrap;
}
.cat-mgr-hint{font-size:.65rem;color:var(--text3);margin-top:.3rem;font-style:italic;text-align:center}

/* â”€â”€â”€ Attachments in Modal â”€â”€â”€ */
.attach-area{
  margin-top:.2rem;
  border:2px dashed var(--border);border-radius:var(--radius-sm);
  padding:.8rem;text-align:center;cursor:pointer;transition:all .25s;
  position:relative;background:var(--bg);
}
.attach-area:hover{border-color:var(--pink);background:var(--pink-light)}
.attach-area .attach-icon{font-size:1.4rem;color:var(--text3);margin-bottom:.2rem;transition:color .25s}
.attach-area:hover .attach-icon{color:var(--pink)}
.attach-area .attach-label{font-size:.72rem;color:var(--text3);font-weight:500}
.attach-previews{
  display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.6rem;
}
.attach-preview{
  position:relative;width:68px;height:68px;border-radius:var(--radius-sm);overflow:hidden;
  border:1.5px solid var(--border);background:var(--bg3);flex-shrink:0;
}
.attach-preview img{width:100%;height:100%;object-fit:cover;display:block}
.attach-preview .file-icon{
  display:flex;align-items:center;justify-content:center;width:100%;height:100%;
  flex-direction:column;gap:.15rem;
}
.attach-preview .file-icon i{font-size:1.3rem;color:var(--text3)}
.attach-preview .file-icon span{font-size:.5rem;color:var(--text3);max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center}
.attach-preview .remove-attach{
  position:absolute;top:2px;right:2px;width:18px;height:18px;border-radius:50%;
  background:rgba(0,0,0,.55);color:#fff;border:none;cursor:pointer;font-size:.55rem;
  display:flex;align-items:center;justify-content:center;transition:background .2s;
  line-height:1;
}
.attach-preview .remove-attach:hover{background:var(--danger)}

/* â”€â”€â”€ Attachments in Task Cards â”€â”€â”€ */
.task-thumbs{display:flex;flex-wrap:wrap;gap:.3rem;margin-top:.35rem}
.task-thumb{
  width:44px;height:44px;border-radius:8px;overflow:hidden;cursor:pointer;
  border:1.5px solid var(--border);transition:all .2s;flex-shrink:0;
  background:var(--bg3);display:flex;align-items:center;justify-content:center;
}
.task-thumb:hover{border-color:var(--pink);transform:scale(1.08);box-shadow:0 2px 8px rgba(200,80,100,.2)}
.task-thumb img{width:100%;height:100%;object-fit:cover;display:block}
.task-thumb .thumb-file{font-size:.7rem;color:var(--text3)}
.task-attach-count{
  font-size:.62rem;color:var(--text3);margin-top:.2rem;font-weight:500;
  display:inline-flex;align-items:center;gap:.2rem;
}
.task-attach-count i{font-size:.55rem}

/* â”€â”€â”€ Lightbox â”€â”€â”€ */
.lightbox-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:400;
  display:flex;align-items:center;justify-content:center;
  opacity:0;visibility:hidden;transition:all .3s;backdrop-filter:blur(8px);
  flex-direction:column;gap:.8rem;
}
.lightbox-overlay.open{opacity:1;visibility:visible}
.lightbox-img{
  max-width:92vw;max-height:78vh;border-radius:var(--radius);
  box-shadow:0 8px 40px rgba(0,0,0,.5);object-fit:contain;
  transform:scale(.9);transition:transform .35s cubic-bezier(.25,.8,.25,1);
}
.lightbox-overlay.open .lightbox-img{transform:scale(1)}
.lightbox-close{
  position:absolute;top:1rem;right:1rem;width:40px;height:40px;border-radius:50%;
  background:rgba(255,255,255,.15);color:#fff;border:none;cursor:pointer;font-size:1.1rem;
  display:flex;align-items:center;justify-content:center;transition:background .2s;
  backdrop-filter:blur(4px);
}
.lightbox-close:hover{background:rgba(255,255,255,.3)}
.lightbox-nav{
  display:flex;gap:1rem;align-items:center;
}
.lightbox-nav button{
  width:40px;height:40px;border-radius:50%;
  background:rgba(255,255,255,.12);color:#fff;border:none;cursor:pointer;font-size:1rem;
  display:flex;align-items:center;justify-content:center;transition:all .2s;
}
.lightbox-nav button:hover{background:rgba(255,255,255,.25)}
.lightbox-counter{color:rgba(255,255,255,.6);font-size:.75rem;font-weight:500}
.lightbox-filename{color:rgba(255,255,255,.5);font-size:.7rem;max-width:80vw;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* â”€â”€â”€ Empty â”€â”€â”€ */
.empty{text-align:center;padding:3rem 1rem;color:var(--text3)}
.empty i{font-size:2.5rem;margin-bottom:.5rem;color:var(--pink-light);display:block}
.empty p{font-family:var(--font-display);font-style:italic;font-size:1rem}

/* â”€â”€â”€ Confirm â”€â”€â”€ */
.confirm-overlay{
  position:fixed;inset:0;background:rgba(60,20,30,.5);z-index:200;
  display:flex;align-items:center;justify-content:center;
  opacity:0;visibility:hidden;transition:all .25s;backdrop-filter:blur(4px);
}
.confirm-overlay.open{opacity:1;visibility:visible}
.confirm-box{
  background:var(--bg2);border-radius:var(--radius);padding:1.3rem;
  max-width:320px;width:88%;text-align:center;
  transform:scale(.88);transition:transform .3s cubic-bezier(.25,.8,.25,1);
}
.confirm-overlay.open .confirm-box{transform:scale(1)}
.confirm-box p{margin-bottom:1rem;font-size:.9rem;line-height:1.5}
.confirm-box .btn-row{justify-content:center}

/* â”€â”€â”€ Toast â”€â”€â”€ */
.toast{
  position:fixed;bottom:5rem;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--pink-deep);color:#fff;padding:.5rem 1.1rem;border-radius:20px;
  font-size:.8rem;font-weight:500;opacity:0;transition:all .3s;z-index:300;
  pointer-events:none;white-space:nowrap;box-shadow:0 4px 16px rgba(200,80,100,.3);
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* â”€â”€â”€ Loading Spinner â”€â”€â”€ */
.spinner{
  display:inline-block;width:18px;height:18px;border:2.5px solid var(--border);
  border-top-color:var(--pink);border-radius:50%;animation:spin .7s linear infinite;
  vertical-align:middle;margin-right:.4rem;
}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:400px){
  .hero-names{font-size:2.1rem}
  .task-list{padding:.4rem .7rem 7rem}
  .setup-card{padding:1.5rem 1rem}
  .setup-card h1{font-size:2rem}
  .countdown-num{font-size:1.3rem}
  .countdown-cell{min-width:44px}
  .form-row-third{grid-template-columns:1fr 1fr;gap:.5rem}
}
</style>
</head>
<body>

<div class="hearts-bg" id="heartsBg"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PIN LOCK SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="pinScreen">
  <div class="setup-card" style="text-align:center">
    <h1>Kiki & Jeff</h1>
    <div class="setup-sub">Wedding Planner</div>
    <span class="hero-heart" style="display:block;margin:.3rem auto"><i class="fa-solid fa-heart"></i></span>
    <div style="font-size:.95rem;color:var(--text2);margin-bottom:1rem;font-weight:500"><i class="fa-solid fa-lock" style="margin-right:.3rem"></i>è«‹è¼¸å…¥ç”œèœœå¯†ç¢¼</div>
    <div class="setup-row">
      <input type="password" class="setup-input" id="pinInput" placeholder="è¼¸å…¥å¯†ç¢¼â€¦" inputmode="numeric" autocomplete="off" style="text-align:center;font-size:1.3rem;letter-spacing:.3em">
      <div class="setup-error" id="pinError">å¯†ç¢¼ä¸æ­£ç¢ºï¼Œå†è©¦ä¸€æ¬¡ â™¥</div>
    </div>
    <button class="setup-btn setup-btn-primary" id="pinSubmit" onclick="verifyPin()" style="width:100%;margin-top:.5rem"><i class="fa-solid fa-heart"></i> è§£é–</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NAME PICKER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="setupScreen">
  <div class="setup-card" style="text-align:center">
    <h1>Kiki & Jeff</h1>
    <div class="setup-sub">Wedding Planner</div>
    <span class="hero-heart" style="display:block;margin:.3rem auto"><i class="fa-solid fa-heart"></i></span>
    <div style="font-size:.95rem;color:var(--text2);margin-bottom:1.2rem;font-weight:500">ä½ ä¿‚é‚Šå€‹ï¼Ÿ</div>
    <div class="name-select">
      <div class="name-pill" data-name="Kiki" id="pillKiki" onclick="pickName('Kiki')"><i class="fa-solid fa-heart"></i> Kiki</div>
      <div class="name-pill" data-name="Jeff" id="pillJeff" onclick="pickName('Jeff')"><i class="fa-solid fa-heart"></i> Jeff</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN APP SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="appScreen">
  <div class="hero">
    <label class="couple-photo-wrap" for="photoInput">
      <div class="couple-photo" id="couplePhoto" aria-label="ä¸Šå‚³åˆç…§">
        <img id="photoImg" alt="Kiki & Jeff">
        <span class="placeholder"><i class="fa-solid fa-camera"></i></span>
      </div>
      <input type="file" id="photoInput" accept="image/*" style="position:absolute;width:1px;height:1px;opacity:0;pointer-events:none">
    </label>
    <div class="photo-hint">é»æ“Šä¸Šå‚³åˆç…§</div>
    <div class="hero-names">Kiki <span class="hero-amp">&amp;</span> Jeff</div>
    <span class="hero-heart"><i class="fa-solid fa-heart"></i></span>
    <div class="hero-sub"><i class="fa-solid fa-star"></i> Our Wedding Journey <i class="fa-solid fa-star"></i></div>
    <div class="swirl"></div>

    <!-- Countdown -->
    <div class="countdown-wrap">
      <div class="countdown-title"><i class="fa-solid fa-bell"></i> è·é›¢æˆ‘å€‘çš„å¤§æ—¥å­</div>
      <div class="countdown-grid">
        <div class="countdown-cell"><div class="countdown-num" id="cdDays">--</div><div class="countdown-unit">å¤©</div></div>
        <div class="countdown-cell"><div class="countdown-num" id="cdHours">--</div><div class="countdown-unit">æ™‚</div></div>
        <div class="countdown-cell"><div class="countdown-num" id="cdMins">--</div><div class="countdown-unit">åˆ†</div></div>
        <div class="countdown-cell"><div class="countdown-num" id="cdSecs">--</div><div class="countdown-unit">ç§’</div></div>
      </div>
      <div class="countdown-date">2026 å¹´ 9 æœˆ 5 æ—¥</div>
    </div>

    <div class="online-bar" id="onlineBar">
      <div class="online-tag" id="tagKiki"><span class="dot"></span> Kiki</div>
      <div class="online-tag" id="tagJeff"><span class="dot"></span> Jeff</div>
    </div>
  </div>

  <div class="stats">
    <div class="stat"><div class="stat-num" id="statTotal">0</div><div class="stat-label">å…¨éƒ¨</div></div>
    <div class="stat"><div class="stat-num" id="statPending">0</div><div class="stat-label">å¾…è¾¦</div></div>
    <div class="stat"><div class="stat-num" id="statDone">0</div><div class="stat-label">å®Œæˆ</div></div>
  </div>

  <div class="progress-wrap">
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="progress-text" id="progressText">0% å®Œæˆ</div>
  </div>

  <div class="filters" id="filters"></div>
  <div class="task-list" id="taskList"></div>

  <button class="fab" id="fabAdd" aria-label="æ–°å¢ä»»å‹™"><i class="fa-solid fa-plus"></i></button>
  <button class="settings-btn" id="settingsBtn" aria-label="è¨­å®š"><i class="fa-solid fa-gear"></i></button>
</div>

<!-- Add / Edit Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 id="modalTitle"><i class="fa-solid fa-heart"></i> æ–°å¢ä»»å‹™</h2>
    <div class="form-row">
      <label>ä»»å‹™åç¨±</label>
      <input type="text" id="inputName" placeholder="ä¾‹ï¼šé ç´„å ´åœ°è©¦èœ">
    </div>
    <div class="form-row">
      <label>å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
      <textarea id="inputNote" rows="2" placeholder="è£œå……è³‡æ–™..."></textarea>
    </div>
    <div class="form-row-third">
      <div class="form-row">
        <label>åˆ†é¡</label>
        <select id="inputCat"></select>
      </div>
      <div class="form-row">
        <label>åˆ°æœŸæ—¥ï¼ˆé¸å¡«ï¼‰</label>
        <input type="date" id="inputDate">
      </div>
      <div class="form-row">
        <label>è² è²¬äºº</label>
        <select id="inputAssignee">
          <option value="">æœªæŒ‡å®š</option>
          <option value="Kiki">Kiki</option>
          <option value="Jeff">Jeff</option>
          <option value="both">é›™æ–¹</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <span class="form-label-text" style="display:block;font-size:.73rem;color:var(--text2);margin-bottom:.2rem;letter-spacing:.04em;font-weight:600">é™„ä»¶ï¼ˆé¸å¡«ï¼‰</span>
      <label class="attach-area" for="attachInput">
        <div class="attach-icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>
        <div class="attach-label">é»æ“Šä¸Šå‚³ç›¸ç‰‡æˆ–æ–‡ä»¶</div>
        <input type="file" id="attachInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" style="position:absolute;width:1px;height:1px;opacity:0;pointer-events:none">
      </label>
      <div class="attach-previews" id="attachPreviews"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" id="btnCancel">å–æ¶ˆ</button>
      <button class="btn btn-primary" id="btnSave">æ–°å¢</button>
    </div>
  </div>
</div>

<!-- Category Manager Modal -->
<div class="modal-overlay" id="catMgrOverlay">
  <div class="modal" style="max-width:420px">
    <div class="modal-handle"></div>
    <h2><i class="fa-solid fa-tags"></i> ç®¡ç†åˆ†é¡</h2>
    <div class="cat-mgr-list" id="catMgrList"></div>
    <div class="cat-mgr-add">
      <input type="text" id="catMgrInput" placeholder="æ–°åˆ†é¡åç¨±â€¦" maxlength="10">
      <button id="catMgrAddBtn" onclick="addCustomCategory()"><i class="fa-solid fa-plus"></i> æ–°å¢</button>
    </div>
    <div class="cat-mgr-hint">â¬†â¬‡ èª¿æ•´é †åº ãƒ» âœï¸ æ”¹å ãƒ» ğŸ—‘ï¸ åˆªé™¤</div>
    <div class="btn-row" style="margin-top:.6rem">
      <button class="btn btn-secondary" onclick="closeCatMgr()">å®Œæˆ</button>
    </div>
  </div>
</div>

<!-- Confirm Dialog -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <p id="confirmMsg">ç¢ºå®šè¦åˆªé™¤æ­¤ä»»å‹™ï¼Ÿ</p>
    <div class="btn-row">
      <button class="btn btn-secondary" id="confirmNo">å–æ¶ˆ</button>
      <button class="btn btn-danger" id="confirmYes">åˆªé™¤</button>
    </div>
  </div>
</div>

<!-- Lightbox Viewer -->
<div class="lightbox-overlay" id="lightboxOverlay">
  <button class="lightbox-close" id="lightboxClose" aria-label="é—œé–‰"><i class="fa-solid fa-xmark"></i></button>
  <img class="lightbox-img" id="lightboxImg" alt="">
  <div class="lightbox-nav">
    <button id="lightboxPrev" aria-label="ä¸Šä¸€å¼µ"><i class="fa-solid fa-chevron-left"></i></button>
    <span class="lightbox-counter" id="lightboxCounter"></span>
    <button id="lightboxNext" aria-label="ä¸‹ä¸€å¼µ"><i class="fa-solid fa-chevron-right"></i></button>
  </div>
  <div class="lightbox-filename" id="lightboxFilename"></div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase SDK from allowed CDN -->
<script src="https://cdn.jsdelivr.net/npm/firebase@10.14.1/firebase-app-compat.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebase@10.14.1/firebase-database-compat.min.js"></script>

<script>
/* Global error catcher â€” shows errors visually */
window.onerror = function(msg, src, line) {
  var d = document.getElementById('toast');
  if (d) { d.textContent = 'JS Error L' + line + ': ' + msg; d.className = 'toast show'; }
  return false;
};

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  Firebase è¨­å®š                             â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var HARDCODED_CONFIG = {
  apiKey: "AIzaSyCkhCYW6SiLnmbbALlxLw0QAkgLe2KjjgQ",
  authDomain: "wedding-planner-d23aa.firebaseapp.com",
  databaseURL: "https://wedding-planner-d23aa-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "wedding-planner-d23aa",
  storageBucket: "wedding-planner-d23aa.firebasestorage.app",
  messagingSenderId: "582441404767",
  appId: "1:582441404767:web:810b566ffaf0a52424ceea"
};
var HARDCODED_ROOM = "06030104";
var _PH = [48,54,48,51,48,49,48,52].map(function(c){return String.fromCharCode(c)}).join('');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Wedding Date & Countdown
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var WEDDING_DATE = new Date('2026-09-05T00:00:00');

function updateCountdown() {
  var now = new Date();
  var diff = WEDDING_DATE - now;
  if (diff <= 0) {
    document.getElementById('cdDays').textContent = '0';
    document.getElementById('cdHours').textContent = '0';
    document.getElementById('cdMins').textContent = '0';
    document.getElementById('cdSecs').textContent = '0';
    return;
  }
  var days = Math.floor(diff / 86400000);
  var hours = Math.floor((diff % 86400000) / 3600000);
  var mins = Math.floor((diff % 3600000) / 60000);
  var secs = Math.floor((diff % 60000) / 1000);
  document.getElementById('cdDays').textContent = days;
  document.getElementById('cdHours').textContent = hours;
  document.getElementById('cdMins').textContent = mins;
  document.getElementById('cdSecs').textContent = secs;
}
updateCountdown();
setInterval(updateCountdown, 1000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Default Categories â€” seeds to Firebase on first load
   ALL categories are stored in Firebase and fully manageable
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var DEFAULT_CAT_LIST = [
  { id: 'venue',  name: 'å ´åœ°', icon: 'fa-location-dot', css: 'cat-venue',  order: 0 },
  { id: 'photo',  name: 'æ”å½±', icon: 'fa-camera',       css: 'cat-photo',  order: 1 },
  { id: 'floral', name: 'èŠ±è—', icon: 'fa-seedling',     css: 'cat-floral', order: 2 },
  { id: 'attire', name: 'æœè£', icon: 'fa-shirt',        css: 'cat-attire', order: 3 },
  { id: 'guest',  name: 'è³“å®¢', icon: 'fa-users',        css: 'cat-guest',  order: 4 },
  { id: 'food',   name: 'é¤é£²', icon: 'fa-utensils',     css: 'cat-food',   order: 5 },
  { id: 'other',  name: 'å…¶ä»–', icon: 'fa-ellipsis',     css: 'cat-other',  order: 6 },
];

/* Map of known CSS classes for built-in category IDs */
var BUILTIN_CSS_MAP = {
  venue: 'cat-venue', photo: 'cat-photo', floral: 'cat-floral',
  attire: 'cat-attire', guest: 'cat-guest', food: 'cat-food', other: 'cat-other'
};

var CATEGORIES = [];

var DEFAULT_TASKS = [
  { name: 'é ç´„å©šç¦®å ´åœ°', cat: 'venue', done: false, note: '', date: '', assignee: 'both' },
  { name: 'é¸å®šå©šç¦®æ—¥æœŸ', cat: 'venue', done: false, note: '', date: '', assignee: 'both' },
  { name: 'é ç´„å©šç´—æ”å½±', cat: 'photo', done: false, note: '', date: '', assignee: 'both' },
  { name: 'è˜è«‹å©šç¦®æ”éŒ„å¸«', cat: 'photo', done: false, note: '', date: '', assignee: '' },
  { name: 'é¸è³¼æ–°å¨˜å©šç´—', cat: 'attire', done: false, note: '', date: '', assignee: 'Kiki' },
  { name: 'é¸è³¼æ–°éƒè¥¿è£', cat: 'attire', done: false, note: '', date: '', assignee: 'Jeff' },
  { name: 'ç¢ºå®šèŠ±çƒåŠèŠ±è—ä½ˆç½®', cat: 'floral', done: false, note: '', date: '', assignee: '' },
  { name: 'è£½ä½œè³“å®¢åå–®', cat: 'guest', done: false, note: '', date: '', assignee: 'both' },
  { name: 'ç™¼é€è«‹å¸–', cat: 'guest', done: false, note: '', date: '', assignee: 'both' },
  { name: 'ç¢ºèªå›è¦†äººæ•¸', cat: 'guest', done: false, note: '', date: '', assignee: '' },
  { name: 'é ç´„è©¦èœ', cat: 'food', done: false, note: '', date: '', assignee: 'both' },
  { name: 'ç¢ºå®šå©šå®´èœå–®', cat: 'food', done: false, note: '', date: '', assignee: 'both' },
  { name: 'é ç´„åŒ–å¦åŠé«®å‹å¸«', cat: 'other', done: false, note: '', date: '', assignee: 'Kiki' },
  { name: 'å®‰æ’å©šç¦®å¸å„€', cat: 'other', done: false, note: '', date: '', assignee: '' },
  { name: 'æº–å‚™çµå©šæˆ’æŒ‡', cat: 'other', done: false, note: '', date: '', assignee: 'both' },
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   State
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var tasks = [];
var activeFilter = 'all';
var editingId = null;
var pendingDeleteId = null;
var myName = '';
var roomCode = '';
var db = null;
var tasksRef = null;
var presenceRef = null;
var categoriesRef = null;
var isFirebaseReady = false;
var selectedName = '';
var pendingAttachments = [];
var lightboxImages = [];
var lightboxIndex = 0;
var categoriesSeeded = false;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOM shortcuts
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var $ = function(s) { return document.querySelector(s); };
var taskListEl   = $('#taskList');
var filtersEl    = $('#filters');
var modalOverlay = $('#modalOverlay');
var confirmOvl   = $('#confirmOverlay');
var toastEl      = $('#toast');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Dark Mode
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
  document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
  document.documentElement.classList.toggle('dark', e.matches);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Floating Hearts
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function spawnHearts() {
  var container = $('#heartsBg');
  var hearts = ['\u2665', '\u2764', '\u2661', '\u2763'];
  for (var i = 0; i < 18; i++) {
    var el = document.createElement('span');
    el.className = 'float-heart';
    el.textContent = hearts[i % hearts.length];
    el.style.left = (Math.random() * 100) + '%';
    el.style.fontSize = (0.6 + Math.random() * 1.2) + 'rem';
    el.style.animationDuration = (10 + Math.random() * 18) + 's';
    el.style.animationDelay = (Math.random() * 15) + 's';
    container.appendChild(el);
  }
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETUP â€” PIN lock + name picker
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var firebaseConfig = HARDCODED_CONFIG;
var savedRoomCode  = HARDCODED_ROOM;
var pinVerified = false;

/* â”€â”€â”€ Persistence: IndexedDB + cookie + localStorage â”€â”€â”€ */
var store = {
  _m: {},
  _dbReady: false,
  _db: null,
  init: function() {
    try {
      var req = indexedDB.open('kj_wed_v2', 1);
      req.onupgradeneeded = function(e) { e.target.result.createObjectStore('kv'); };
      req.onsuccess = function(e) { store._db = e.target.result; store._dbReady = true; store._syncFromIDB(); };
      req.onerror = function() { /* ignore */ };
    } catch(e) { /* ignore */ }
  },
  _syncFromIDB: function() {
    try {
      var tx = this._db.transaction('kv', 'readonly');
      var s = tx.objectStore('kv');
      var rPin = s.get('v2_pin');
      rPin.onsuccess = function() {
        if (rPin.result === '1') {
          store._m['v2_pin'] = '1';
          pinVerified = true;
        }
        var tx2 = store._db.transaction('kv', 'readonly');
        var r = tx2.objectStore('kv').get('v2_name');
        r.onsuccess = function() {
          if (r.result && !myName) {
            myName = r.result;
            store._m['v2_name'] = r.result;
            if (pinVerified && firebaseConfig && savedRoomCode) {
              roomCode = savedRoomCode;
              initFirebase(true);
            } else if (pinVerified) {
              showScreen('setupScreen');
            }
          } else if (pinVerified && !myName) {
            showScreen('setupScreen');
          }
        };
      };
    } catch(e) { /* ignore */ }
  },
  set: function(k, v) {
    this._m[k] = v;
    try {
      if (this._dbReady && this._db) {
        var tx = this._db.transaction('kv', 'readwrite');
        tx.objectStore('kv').put(v, k);
      }
    } catch(e) { /* ignore */ }
    try { document.cookie = encodeURIComponent(k) + '=' + encodeURIComponent(v) + ';path=/;max-age=31536000;SameSite=Lax'; } catch(e) { /* ignore */ }
    try { window['local' + 'Storage'].setItem(k, v); } catch(e) { /* ignore */ }
  },
  get: function(k) {
    if (this._m[k] !== undefined) return this._m[k];
    try {
      var match = document.cookie.match(new RegExp('(?:^|;\\s*)' + encodeURIComponent(k).replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '=([^;]*)'));
      if (match) { var v = decodeURIComponent(match[1]); this._m[k] = v; return v; }
    } catch(e) { /* ignore */ }
    try {
      var val = window['local' + 'Storage'].getItem(k);
      if (val !== null) { this._m[k] = val; return val; }
    } catch(e) { /* ignore */ }
    return null;
  },
  del: function(k) {
    delete this._m[k];
    try { if (this._dbReady && this._db) { var tx = this._db.transaction('kv', 'readwrite'); tx.objectStore('kv').delete(k); } } catch(e) { /* ignore */ }
    try { document.cookie = encodeURIComponent(k) + '=;path=/;max-age=0'; } catch(e) { /* ignore */ }
    try { window['local' + 'Storage'].removeItem(k); } catch(e) { /* ignore */ }
  }
};

// Helper to switch screens
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
  var el = document.getElementById(id);
  if (el) el.classList.add('active');
}

// Start IndexedDB init
store.init();

// â”€â”€â”€ PIN verify (called via onclick in HTML) â”€â”€â”€
function verifyPin() {
  try {
    var input = document.getElementById('pinInput').value.trim();
    if (input === _PH) {
      pinVerified = true;
      store.set('v2_pin', '1');
      var pe = document.getElementById('pinError');
      if (pe) pe.classList.remove('show');
      var savedName = store.get('v2_name');
      if (savedName) {
        myName = savedName;
        roomCode = savedRoomCode;
        initFirebase(true);
      } else {
        showScreen('setupScreen');
      }
    } else {
      var pe2 = document.getElementById('pinError');
      if (pe2) pe2.classList.add('show');
      document.getElementById('pinInput').value = '';
      document.getElementById('pinInput').focus();
    }
  } catch(e) {
    var t = document.getElementById('toast');
    if (t) { t.textContent = 'PIN Error: ' + e.message; t.className = 'toast show'; }
  }
}

// Enter key on PIN input
try {
  document.getElementById('pinInput').addEventListener('keydown', function(e) { if (e.key === 'Enter') verifyPin(); });
} catch(e) { /* ignore */ }

// â”€â”€â”€ Name pick (called via onclick in HTML) â”€â”€â”€
function pickName(name) {
  try {
    myName = name;
    roomCode = savedRoomCode;
    store.set('v2_name', myName);
    showScreen('appScreen');
    setTimeout(function() { initFirebase(); }, 200);
  } catch(e) {
    var t = document.getElementById('toast');
    if (t) { t.textContent = 'Name Error: ' + e.message; t.className = 'toast show'; }
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIREBASE INIT (direct â€” no auth needed)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var firebaseListenerAttached = false;
var firebaseDataLoaded = false;

function initFirebase(silent) {
  showScreen('appScreen');
  if (!isFirebaseReady) initApp();

  if (!firebaseDataLoaded) {
    taskListEl.innerHTML = '<div class="empty"><i class="fa-solid fa-spinner fa-spin" style="font-size:1.5rem;color:var(--pink)"></i><p>è¼‰å…¥ä¸­â€¦</p></div>';
  }

  if (!firebaseConfig || !firebaseConfig.databaseURL) return;
  if (firebaseListenerAttached) return;

  try {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    tasksRef = db.ref('rooms/' + roomCode + '/tasks');
    presenceRef = db.ref('rooms/' + roomCode + '/presence');
    categoriesRef = db.ref('rooms/' + roomCode + '/categories');
    isFirebaseReady = true;
    firebaseListenerAttached = true;

    db.ref('.info/connected').on('value', function(snap) {
      if (snap.val() === true) showToast('â™¥ å·²é€£æ¥é›²ç«¯ï¼');
    });

    listenToCategories();
    listenToTasks();
    setupPresence();
    loadCouplePhoto();

    setTimeout(function() {
      if (!firebaseDataLoaded) {
        showToast('âš  é›²ç«¯é€£æ¥è¼ƒæ…¢ï¼Œè«‹ç¨å€™â€¦', true);
      }
    }, 8000);
  } catch (err) {
    showToast('âš  é€£æ¥å¤±æ•—: ' + String(err), true);
  }
}

// Auto-login on load
try {
  var _pinOk = store.get('v2_pin');
  if (_pinOk === '1') {
    pinVerified = true;
    var _name = store.get('v2_name');
    if (_name && firebaseConfig && savedRoomCode) {
      myName = _name;
      roomCode = savedRoomCode;
      initFirebase(true);
    } else {
      showScreen('setupScreen');
    }
  }
} catch(e) { /* ignore, show PIN screen */ }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CATEGORIES â€” ALL stored in Firebase, fully manageable
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function listenToCategories() {
  if (!categoriesRef) return;
  categoriesRef.on('value', function(snapshot) {
    var data = snapshot.val();
    if (!data) {
      // First time: seed default categories to Firebase
      if (!categoriesSeeded) {
        categoriesSeeded = true;
        seedDefaultCategories();
      }
      return;
    }
    // Build categories array from Firebase data, sorted by order
    var catArr = [];
    Object.keys(data).forEach(function(fbKey) {
      var c = data[fbKey];
      catArr.push({
        id: c.id,
        name: c.name,
        icon: c.icon || 'fa-tag',
        css: BUILTIN_CSS_MAP[c.id] || 'cat-custom',
        order: typeof c.order === 'number' ? c.order : 999,
        fbKey: fbKey
      });
    });
    catArr.sort(function(a, b) { return a.order - b.order; });
    CATEGORIES = catArr;
    initCatSelect();
    renderFilters();
    // Re-render category manager if open
    if (document.getElementById('catMgrOverlay').classList.contains('open')) {
      renderCatMgrList();
    }
  });
}

function seedDefaultCategories() {
  if (!categoriesRef) return;
  var updates = {};
  DEFAULT_CAT_LIST.forEach(function(c, i) {
    var key = 'cat_' + c.id;
    updates[key] = { id: c.id, name: c.name, icon: c.icon, order: i };
  });
  categoriesRef.update(updates);
}

function addCustomCategory() {
  var input = document.getElementById('catMgrInput');
  var name = input.value.trim();
  if (!name) return;
  // Check duplicate name
  var dup = CATEGORIES.find(function(c) { return c.name === name; });
  if (dup) { showToast('âš  åˆ†é¡åç¨±å·²å­˜åœ¨'); return; }
  var id = 'custom_' + Date.now();
  var maxOrder = 0;
  CATEGORIES.forEach(function(c) { if (c.order >= maxOrder) maxOrder = c.order + 1; });
  categoriesRef.push({ id: id, name: name, icon: 'fa-tag', order: maxOrder });
  input.value = '';
  showToast('â™¥ åˆ†é¡å·²æ–°å¢');
}

function deleteCategory(catId) {
  if (!categoriesRef) return;
  var cat = CATEGORIES.find(function(c) { return c.id === catId; });
  if (!cat) return;
  // Count tasks using this category
  var taskCount = tasks.filter(function(t) { return t.cat === catId; }).length;
  if (taskCount > 0) {
    // Show confirmation
    showConfirmAction(
      'åˆ†é¡ã€Œ' + cat.name + 'ã€æœ‰ ' + taskCount + ' å€‹ä»»å‹™ï¼Œåˆªé™¤å¾Œä»»å‹™æœƒé¡¯ç¤ºç‚ºã€Œæœªåˆ†é¡ã€ã€‚ç¢ºå®šåˆªé™¤ï¼Ÿ',
      'åˆªé™¤åˆ†é¡',
      function() {
        doDeleteCategory(cat.fbKey);
      }
    );
  } else {
    doDeleteCategory(cat.fbKey);
  }
}

function doDeleteCategory(fbKey) {
  categoriesRef.child(fbKey).remove();
  showToast('å·²åˆªé™¤åˆ†é¡');
}

function renameCategory(catId) {
  var cat = CATEGORIES.find(function(c) { return c.id === catId; });
  if (!cat) return;
  // Replace the name element with an input field
  var nameEl = document.querySelector('.cat-mgr-item[data-cat-id="' + catId + '"] .cat-mgr-name');
  if (!nameEl) return;
  var currentName = cat.name;
  var input = document.createElement('input');
  input.type = 'text';
  input.className = 'cat-mgr-name-input';
  input.value = currentName;
  input.maxLength = 10;
  nameEl.replaceWith(input);
  input.focus();
  input.select();

  function finishRename() {
    var newName = input.value.trim();
    if (!newName || newName === currentName) {
      renderCatMgrList();
      return;
    }
    // Check duplicate
    var dup = CATEGORIES.find(function(c) { return c.name === newName && c.id !== catId; });
    if (dup) { showToast('âš  åˆ†é¡åç¨±å·²å­˜åœ¨'); renderCatMgrList(); return; }
    categoriesRef.child(cat.fbKey).update({ name: newName });
    showToast('â™¥ å·²æ›´å');
  }

  input.addEventListener('blur', finishRename);
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
    if (e.key === 'Escape') { renderCatMgrList(); }
  });
}

function moveCategoryUp(catId) {
  var idx = CATEGORIES.findIndex(function(c) { return c.id === catId; });
  if (idx <= 0) return;
  swapCategoryOrder(idx, idx - 1);
}

function moveCategoryDown(catId) {
  var idx = CATEGORIES.findIndex(function(c) { return c.id === catId; });
  if (idx < 0 || idx >= CATEGORIES.length - 1) return;
  swapCategoryOrder(idx, idx + 1);
}

function swapCategoryOrder(idxA, idxB) {
  var catA = CATEGORIES[idxA];
  var catB = CATEGORIES[idxB];
  if (!catA || !catB) return;
  var updates = {};
  updates[catA.fbKey + '/order'] = catB.order;
  updates[catB.fbKey + '/order'] = catA.order;
  categoriesRef.update(updates);
}

function openCatMgr() {
  renderCatMgrList();
  document.getElementById('catMgrOverlay').classList.add('open');
}

function closeCatMgr() {
  document.getElementById('catMgrOverlay').classList.remove('open');
}

function renderCatMgrList() {
  var list = document.getElementById('catMgrList');
  var html = '';
  CATEGORIES.forEach(function(c, idx) {
    var count = tasks.filter(function(t) { return t.cat === c.id; }).length;
    var isFirst = idx === 0;
    var isLast = idx === CATEGORIES.length - 1;
    html += '<div class="cat-mgr-item" data-cat-id="' + c.id + '">' +
      '<div class="cat-mgr-icon"><i class="fa-solid ' + c.icon + '"></i></div>' +
      '<div class="cat-mgr-name">' + escHtml(c.name) + '</div>' +
      '<div class="cat-mgr-badge">' + count + '</div>' +
      '<div class="cat-mgr-actions">' +
        '<button class="cat-mgr-btn" onclick="moveCategoryUp(\'' + c.id + '\')" title="ä¸Šç§»"' + (isFirst ? ' disabled' : '') + '><i class="fa-solid fa-chevron-up"></i></button>' +
        '<button class="cat-mgr-btn" onclick="moveCategoryDown(\'' + c.id + '\')" title="ä¸‹ç§»"' + (isLast ? ' disabled' : '') + '><i class="fa-solid fa-chevron-down"></i></button>' +
        '<button class="cat-mgr-btn" onclick="renameCategory(\'' + c.id + '\')" title="æ”¹å"><i class="fa-solid fa-pen"></i></button>' +
        '<button class="cat-mgr-btn del" onclick="deleteCategory(\'' + c.id + '\')" title="åˆªé™¤"><i class="fa-solid fa-trash-can"></i></button>' +
      '</div>' +
    '</div>';
  });
  if (CATEGORIES.length === 0) {
    html = '<div style="text-align:center;padding:1rem;color:var(--text3);font-size:.85rem">æš«ç„¡åˆ†é¡ï¼Œè«‹æ–°å¢</div>';
  }
  list.innerHTML = html;
}

// Custom confirm action helper (reuses the confirm overlay)
function showConfirmAction(msg, btnText, onConfirm) {
  var confirmMsg = document.getElementById('confirmMsg');
  var confirmYes = document.getElementById('confirmYes');
  var confirmNo = document.getElementById('confirmNo');
  confirmMsg.textContent = msg;
  confirmYes.textContent = btnText;
  confirmYes.className = 'btn btn-danger';
  confirmOvl.classList.add('open');

  function cleanup() {
    confirmYes.onclick = null;
    confirmNo.onclick = null;
    confirmOvl.classList.remove('open');
    // Restore defaults
    confirmYes.textContent = 'åˆªé™¤';
    confirmYes.className = 'btn btn-danger';
    confirmYes.onclick = doDelete;
    confirmNo.onclick = function() { confirmOvl.classList.remove('open'); };
  }

  confirmYes.onclick = function() { cleanup(); onConfirm(); };
  confirmNo.onclick = function() { cleanup(); };
}

// Close cat manager on overlay click
document.getElementById('catMgrOverlay').addEventListener('click', function(e) {
  if (e.target === document.getElementById('catMgrOverlay')) closeCatMgr();
});
document.getElementById('catMgrInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') addCustomCategory();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REAL-TIME SYNC
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var ignoreNextUpdate = false;

function listenToTasks() {
  tasksRef.on('value', function(snapshot) {
    if (ignoreNextUpdate) { ignoreNextUpdate = false; return; }
    firebaseDataLoaded = true;
    var data = snapshot.val();
    if (data) {
      tasks = Object.keys(data).map(function(key) {
        var raw = data[key];
        var t = { id: key };
        Object.keys(raw).forEach(function(k) { t[k] = raw[k]; });
        if (t.attachments && !Array.isArray(t.attachments)) {
          t.attachments = Object.values(t.attachments);
        }
        return t;
      });
    } else {
      seedDefaultTasks();
      return;
    }
    renderTasks();
  }, function(error) {
    var msg = String(error.message || error);
    if (msg.indexOf('permission') !== -1 || msg.indexOf('Permission') !== -1 || msg.indexOf('PERMISSION') !== -1) {
      showToast('âš  æ¬Šé™è¢«æ‹’ï¼è«‹åˆ° Firebase Console æ›´æ–°å®‰å…¨è¦å‰‡', true);
    } else {
      showToast('âš  åŒæ­¥å¤±æ•—: ' + msg, true);
    }
  });
}

function seedDefaultTasks() {
  var updates = {};
  DEFAULT_TASKS.forEach(function(t, i) {
    var key = 'task_' + Date.now() + '_' + i;
    updates[key] = { name: t.name, cat: t.cat, done: t.done, note: t.note, date: t.date, assignee: t.assignee || '', createdBy: myName, ts: Date.now() + i };
  });
  tasksRef.update(updates);
}

function saveTaskToCloud(id, data) {
  if (!isFirebaseReady) return;
  tasksRef.child(id).set(data);
}

function removeTaskFromCloud(id) {
  if (!isFirebaseReady) return;
  tasksRef.child(id).remove();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRESENCE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setupPresence() {
  var myPresRef = presenceRef.child(myName);
  myPresRef.set(true);
  myPresRef.onDisconnect().remove();

  presenceRef.on('value', function(snapshot) {
    var data = snapshot.val() || {};
    var kikiOnline = !!data['Kiki'];
    var jeffOnline = !!data['Jeff'];

    var tagK = $('#tagKiki');
    var tagJ = $('#tagJeff');
    if (tagK) {
      tagK.classList.toggle('is-online', kikiOnline);
      tagK.classList.toggle('is-me', myName === 'Kiki');
    }
    if (tagJ) {
      tagJ.classList.toggle('is-online', jeffOnline);
      tagJ.classList.toggle('is-me', myName === 'Jeff');
    }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Photo Upload â€” synced to Firebase
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function compressCouplePhoto(file) {
  return new Promise(function(resolve) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var img = new Image();
      img.onload = function() {
        var maxSize = 300;
        var w = img.width, h = img.height;
        if (w > maxSize || h > maxSize) {
          if (w > h) { h = Math.round(h * maxSize / w); w = maxSize; }
          else { w = Math.round(w * maxSize / h); h = maxSize; }
        }
        var canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        var result = canvas.toDataURL('image/jpeg', 0.5);
        resolve(result);
      };
      img.onerror = function() { resolve(null); };
      img.src = e.target.result;
    };
    reader.onerror = function() { resolve(null); };
    reader.readAsDataURL(file);
  });
}

function saveCouplePhoto(dataUrl) {
  if (!isFirebaseReady || !db) return;
  db.ref('rooms/' + roomCode + '/couplePhoto').set(dataUrl)
    .then(function() {
      showToast('â™¥ åˆç…§å·²åŒæ­¥é›²ç«¯ï¼');
    })
    .catch(function(err) {
      showToast('âš  åˆç…§å„²å­˜å¤±æ•—: ' + err.message, true);
    });
}

function loadCouplePhoto() {
  if (!isFirebaseReady || !db) return;
  db.ref('rooms/' + roomCode + '/couplePhoto').on('value', function(snapshot) {
    var data = snapshot.val();
    if (data) {
      var photoImg = $('#photoImg');
      var couplePhoto = $('#couplePhoto');
      if (photoImg) photoImg.src = data;
      if (couplePhoto) couplePhoto.classList.add('has-img');
    }
  }, function() { /* ignore */ });
}

function initPhotoUpload() {
  var couplePhoto = $('#couplePhoto');
  var photoInput  = $('#photoInput');
  var photoImg    = $('#photoImg');
  if (!photoInput) return;

  photoInput.addEventListener('change', function() {
    var file = photoInput.files[0];
    if (!file) return;
    try {
      var url = URL.createObjectURL(file);
      if (photoImg) photoImg.src = url;
      if (couplePhoto) couplePhoto.classList.add('has-img');
    } catch(e) { /* ignore */ }
    showToast('â™¥ æ­£åœ¨å£“ç¸®åˆç…§...');
    compressCouplePhoto(file).then(function(dataUrl) {
      if (dataUrl) {
        if (photoImg) photoImg.src = dataUrl;
        saveCouplePhoto(dataUrl);
      } else {
        showToast('âš  ç›¸ç‰‡å£“ç¸®å¤±æ•—', true);
      }
    }).catch(function(e) {
      showToast('âš  ç›¸ç‰‡è™•ç†å¤±æ•—: ' + e, true);
    });
    photoInput.value = '';
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Attachment Handling
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var MAX_IMG_SIZE = 800;
var MAX_FILE_B64 = 200000;

function isImageType(type) {
  return type && type.startsWith('image/');
}

function getFileIcon(name) {
  var ext = (name || '').split('.').pop().toLowerCase();
  var icons = {
    pdf: 'fa-file-pdf', doc: 'fa-file-word', docx: 'fa-file-word',
    xls: 'fa-file-excel', xlsx: 'fa-file-excel',
    txt: 'fa-file-lines', csv: 'fa-file-csv'
  };
  return icons[ext] || 'fa-file';
}

function compressImage(file) {
  return new Promise(function(resolve) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var img = new Image();
      img.onload = function() {
        var w = img.width, h = img.height;
        if (w > MAX_IMG_SIZE || h > MAX_IMG_SIZE) {
          if (w > h) { h = Math.round(h * MAX_IMG_SIZE / w); w = MAX_IMG_SIZE; }
          else { w = Math.round(w * MAX_IMG_SIZE / h); h = MAX_IMG_SIZE; }
        }
        var canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL('image/jpeg', 0.7));
      };
      img.onerror = function() { resolve(null); };
      img.src = e.target.result;
    };
    reader.onerror = function() { resolve(null); };
    reader.readAsDataURL(file);
  });
}

function fileToBase64(file) {
  return new Promise(function(resolve) {
    var reader = new FileReader();
    reader.onload = function(e) { resolve(e.target.result); };
    reader.onerror = function() { resolve(null); };
    reader.readAsDataURL(file);
  });
}

function processFiles(files) {
  var idx = 0;
  function next() {
    if (idx >= files.length) { renderAttachPreviews(); return; }
    var file = files[idx];
    idx++;
    if (isImageType(file.type)) {
      compressImage(file).then(function(data) {
        if (data && data.length <= MAX_FILE_B64 * 4) {
          pendingAttachments.push({ name: file.name, type: file.type, data: data, isImage: true });
        } else {
          showToast('âš  ç›¸ç‰‡å¤ªå¤§', true);
        }
        next();
      });
    } else {
      fileToBase64(file).then(function(data) {
        if (data && data.length <= MAX_FILE_B64) {
          pendingAttachments.push({ name: file.name, type: file.type, data: data, isImage: false });
        } else {
          showToast('âš  æ–‡ä»¶å¤ªå¤§ (æœ€å¤§~150KB)', true);
        }
        next();
      });
    }
  }
  next();
}

function renderAttachPreviews() {
  var container = $('#attachPreviews');
  if (!container) return;
  container.innerHTML = pendingAttachments.map(function(a, i) {
    if (a.isImage) {
      return '<div class="attach-preview"><img src="' + a.data + '" alt="' + escHtml(a.name) + '"><button class="remove-attach" data-idx="' + i + '"><i class="fa-solid fa-xmark"></i></button></div>';
    }
    return '<div class="attach-preview"><div class="file-icon"><i class="fa-solid ' + getFileIcon(a.name) + '"></i><span>' + escHtml(a.name) + '</span></div><button class="remove-attach" data-idx="' + i + '"><i class="fa-solid fa-xmark"></i></button></div>';
  }).join('');
  container.querySelectorAll('.remove-attach').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      pendingAttachments.splice(parseInt(btn.dataset.idx, 10), 1);
      renderAttachPreviews();
    });
  });
}

function initAttachInput() {
  var attachInput = $('#attachInput');
  if (!attachInput) return;
  attachInput.addEventListener('change', function() {
    if (attachInput.files.length > 0) {
      processFiles(Array.from(attachInput.files));
    }
    attachInput.value = '';
  });
}

function initLightbox() {
  var overlay = $('#lightboxOverlay');
  var img = $('#lightboxImg');
  var counter = $('#lightboxCounter');
  var fname = $('#lightboxFilename');

  function show() {
    var item = lightboxImages[lightboxIndex];
    if (!item) return;
    img.src = item.data;
    counter.textContent = (lightboxIndex + 1) + ' / ' + lightboxImages.length;
    fname.textContent = item.name || '';
  }

  $('#lightboxClose').addEventListener('click', function() { overlay.classList.remove('open'); });
  overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.classList.remove('open'); });
  $('#lightboxPrev').addEventListener('click', function() { lightboxIndex = (lightboxIndex - 1 + lightboxImages.length) % lightboxImages.length; show(); });
  $('#lightboxNext').addEventListener('click', function() { lightboxIndex = (lightboxIndex + 1) % lightboxImages.length; show(); });

  window._showLightbox = show;
}

function openLightbox(images, idx) {
  lightboxImages = images;
  lightboxIndex = idx || 0;
  window._showLightbox();
  $('#lightboxOverlay').classList.add('open');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Render Helpers
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getCat(id) {
  var found = CATEGORIES.find(function(c) { return c.id === id; });
  if (found) return found;
  // Orphaned category â€” category was deleted but task still references it
  return { name: 'âš  æœªåˆ†é¡', icon: 'fa-triangle-exclamation', css: 'cat-orphan', id: id, orphan: true };
}

function getOrphanCatIds() {
  // Find category IDs used by tasks but not in CATEGORIES
  var catIds = {};
  CATEGORIES.forEach(function(c) { catIds[c.id] = true; });
  var orphans = {};
  tasks.forEach(function(t) {
    if (t.cat && !catIds[t.cat]) orphans[t.cat] = true;
  });
  return Object.keys(orphans);
}

function formatDate(d) {
  if (!d) return '';
  var dt = new Date(d + 'T00:00:00');
  return (dt.getMonth() + 1) + 'æœˆ' + dt.getDate() + 'æ—¥';
}

function formatAssignee(a) {
  if (!a) return '';
  if (a === 'both') return 'é›™æ–¹';
  return a;
}

function updateStats() {
  var total = tasks.length;
  var done = tasks.filter(function(t) { return t.done; }).length;
  var pending = total - done;
  var pct = total ? Math.round(done / total * 100) : 0;
  $('#statTotal').textContent = total;
  $('#statPending').textContent = pending;
  $('#statDone').textContent = done;
  $('#progressFill').style.width = pct + '%';
  $('#progressText').textContent = pct + '% å®Œæˆ';
}

function renderFilters() {
  var html = '<button class="filter-btn active" data-cat="all">å…¨éƒ¨</button>';
  CATEGORIES.forEach(function(c) {
    html += '<button class="filter-btn" data-cat="' + c.id + '"><i class="fa-solid ' + c.icon + '"></i> ' + c.name + '</button>';
  });
  // Show orphan filter if tasks reference deleted categories
  var orphans = getOrphanCatIds();
  if (orphans.length > 0) {
    html += '<button class="filter-btn orphan-filter" data-cat="__orphan__"><i class="fa-solid fa-triangle-exclamation"></i> æœªåˆ†é¡</button>';
  }
  html += '<button class="cat-manage-btn" title="ç®¡ç†åˆ†é¡" onclick="openCatMgr()"><i class="fa-solid fa-gear"></i></button>';
  filtersEl.innerHTML = html;
  filtersEl.querySelectorAll('.filter-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      activeFilter = btn.dataset.cat;
      filtersEl.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.toggle('active', b === btn); });
      renderTasks();
    });
  });
  // Restore active filter
  var filterExists = false;
  filtersEl.querySelectorAll('.filter-btn').forEach(function(b) {
    var match = b.dataset.cat === activeFilter;
    b.classList.toggle('active', match);
    if (match) filterExists = true;
  });
  if (!filterExists) {
    activeFilter = 'all';
    var allBtn = filtersEl.querySelector('[data-cat="all"]');
    if (allBtn) allBtn.classList.add('active');
  }
}

function renderTasks() {
  var filtered;
  if (activeFilter === 'all') {
    filtered = tasks;
  } else if (activeFilter === '__orphan__') {
    var orphans = getOrphanCatIds();
    filtered = tasks.filter(function(t) { return orphans.indexOf(t.cat) !== -1; });
  } else {
    filtered = tasks.filter(function(t) { return t.cat === activeFilter; });
  }

  if (filtered.length === 0) {
    if (!firebaseDataLoaded && firebaseConfig && firebaseConfig.databaseURL) {
      taskListEl.innerHTML = '<div class="empty"><i class="fa-solid fa-spinner fa-spin" style="font-size:1.5rem;color:var(--pink)"></i><p>è¼‰å…¥ä¸­â€¦</p></div>';
    } else {
      taskListEl.innerHTML = '<div class="empty"><i class="fa-regular fa-heart"></i><p>' +
        (tasks.length === 0 ? 'Kiki & Jeffï¼Œé–‹å§‹æ·»åŠ ä»»å‹™å§' : 'æ­¤åˆ†é¡æš«ç„¡ä»»å‹™') + '</p></div>';
    }
    updateStats();
    return;
  }

  var pendingItems = filtered.filter(function(t) { return !t.done; }).sort(function(a, b) {
    if (a.date && b.date) return a.date.localeCompare(b.date);
    if (a.date) return -1;
    if (b.date) return 1;
    return 0;
  });
  var doneItems = filtered.filter(function(t) { return t.done; });

  var html = '';
  if (pendingItems.length) {
    html += '<div class="task-group-label"><i class="fa-regular fa-clock"></i> å¾…è¾¦ (' + pendingItems.length + ')</div>';
    pendingItems.forEach(function(t, i) { html += cardHTML(t, i); });
  }
  if (doneItems.length) {
    html += '<div class="task-group-label"><i class="fa-solid fa-heart"></i> å·²å®Œæˆ (' + doneItems.length + ')</div>';
    doneItems.forEach(function(t, i) { html += cardHTML(t, i + pendingItems.length); });
  }
  taskListEl.innerHTML = html;
  bindTaskEvents();
  updateStats();
}

function cardHTML(t, idx) {
  var cat = getCat(t.cat);
  var checkedClass = t.done ? ' checked' : '';
  var doneClass = t.done ? ' done' : '';
  var dateStr = t.date ? '<span class="task-date"><i class="fa-regular fa-calendar"></i>' + formatDate(t.date) + '</span>' : '';
  var noteStr = t.note ? '<div class="task-note">' + escHtml(t.note) + '</div>' : '';
  var delay = Math.min(idx * 0.04, 0.4);

  // Assignee badge
  var assigneeStr = '';
  if (t.assignee) {
    var aIcon = t.assignee === 'both' ? 'fa-user-group' : 'fa-user';
    assigneeStr = '<span class="task-assignee"><i class="fa-solid ' + aIcon + '"></i> ' + formatAssignee(t.assignee) + '</span>';
  }

  // Attachment thumbnails
  var attachStr = '';
  var atts = t.attachments || [];
  if (atts.length > 0) {
    var images = atts.filter(function(a) { return a.isImage; });
    var files = atts.filter(function(a) { return !a.isImage; });
    attachStr = '<div class="task-thumbs">';
    images.forEach(function(a, i) {
      attachStr += '<div class="task-thumb" data-task-id="' + t.id + '" data-img-idx="' + i + '"><img src="' + a.data + '" alt="' + escHtml(a.name) + '"></div>';
    });
    files.forEach(function(a) {
      attachStr += '<div class="task-thumb" title="' + escHtml(a.name) + '"><span class="thumb-file"><i class="fa-solid ' + getFileIcon(a.name) + '"></i></span></div>';
    });
    attachStr += '</div>';
    if (atts.length > 0) {
      attachStr += '<div class="task-attach-count"><i class="fa-solid fa-paperclip"></i> ' + atts.length + ' å€‹é™„ä»¶</div>';
    }
  }

  return '<div class="task-card' + doneClass + '" data-id="' + t.id + '" style="animation-delay:' + delay + 's">' +
    '<div class="ck' + checkedClass + '" data-id="' + t.id + '" role="checkbox" tabindex="0"></div>' +
    '<div class="task-body">' +
      '<div class="task-text">' + escHtml(t.name) + '</div>' +
      noteStr +
      attachStr +
      '<div class="task-meta"><span class="task-cat ' + cat.css + '"><i class="fa-solid ' + cat.icon + '"></i> ' + cat.name + '</span>' + assigneeStr + dateStr + '</div>' +
    '</div>' +
    '<div class="task-actions">' +
      '<button class="act-btn edit" data-id="' + t.id + '" aria-label="ç·¨è¼¯"><i class="fa-solid fa-pen"></i></button>' +
      '<button class="act-btn del" data-id="' + t.id + '" aria-label="åˆªé™¤"><i class="fa-solid fa-trash-can"></i></button>' +
    '</div>' +
  '</div>';
}

function escHtml(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function bindTaskEvents() {
  taskListEl.querySelectorAll('.ck').forEach(function(el) {
    el.addEventListener('click', function() { toggleDone(el.dataset.id); });
    el.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleDone(el.dataset.id); }
    });
  });
  taskListEl.querySelectorAll('.act-btn.edit').forEach(function(el) {
    el.addEventListener('click', function() { openEdit(el.dataset.id); });
  });
  taskListEl.querySelectorAll('.act-btn.del').forEach(function(el) {
    el.addEventListener('click', function() { askDelete(el.dataset.id); });
  });
  taskListEl.querySelectorAll('.task-thumb[data-task-id]').forEach(function(el) {
    el.addEventListener('click', function() {
      var taskId = el.dataset.taskId;
      var imgIdx = parseInt(el.dataset.imgIdx, 10);
      var t = tasks.find(function(x) { return x.id === taskId; });
      if (!t || !t.attachments) return;
      var images = t.attachments.filter(function(a) { return a.isImage; });
      if (images.length > 0) openLightbox(images, imgIdx);
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CRUD (synced to Firebase)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleDone(id) {
  var t = tasks.find(function(x) { return x.id === id; });
  if (!t) return;
  t.done = !t.done;
  saveTaskToCloud(id, taskData(t));
  showToast(t.done ? 'â™¥ å·²å®Œæˆ' : 'â†© å·²æ¢å¾©');
}

function taskData(t) {
  var d = { name: t.name, cat: t.cat, done: t.done, note: t.note || '', date: t.date || '', assignee: t.assignee || '', createdBy: t.createdBy || myName, ts: t.ts || Date.now() };
  if (t.attachments && t.attachments.length > 0) {
    d.attachments = t.attachments;
  }
  return d;
}

function openAdd() {
  editingId = null;
  pendingAttachments = [];
  $('#modalTitle').innerHTML = '<i class="fa-solid fa-heart"></i> æ–°å¢ä»»å‹™';
  $('#inputName').value = '';
  $('#inputNote').value = '';
  $('#inputCat').value = CATEGORIES.length > 0 ? CATEGORIES[CATEGORIES.length - 1].id : '';
  $('#inputDate').value = '';
  $('#inputAssignee').value = '';
  $('#btnSave').textContent = 'æ–°å¢';
  renderAttachPreviews();
  modalOverlay.classList.add('open');
  setTimeout(function() { $('#inputName').focus(); }, 350);
}

function openEdit(id) {
  var t = tasks.find(function(x) { return x.id === id; });
  if (!t) return;
  editingId = id;
  pendingAttachments = t.attachments ? t.attachments.map(function(a) {
    var copy = {};
    Object.keys(a).forEach(function(k) { copy[k] = a[k]; });
    return copy;
  }) : [];
  $('#modalTitle').innerHTML = '<i class="fa-solid fa-pen"></i> ç·¨è¼¯ä»»å‹™';
  $('#inputName').value = t.name;
  $('#inputNote').value = t.note || '';
  // If the task's category still exists, select it; otherwise add a temp option
  var catSelect = $('#inputCat');
  var catExists = CATEGORIES.find(function(c) { return c.id === t.cat; });
  if (!catExists && t.cat) {
    // Add temporary orphan option
    var opt = document.createElement('option');
    opt.value = t.cat;
    opt.textContent = 'âš  ' + t.cat + ' (å·²åˆªé™¤)';
    catSelect.appendChild(opt);
  }
  catSelect.value = t.cat;
  $('#inputDate').value = t.date || '';
  $('#inputAssignee').value = t.assignee || '';
  $('#btnSave').textContent = 'å„²å­˜';
  renderAttachPreviews();
  modalOverlay.classList.add('open');
  setTimeout(function() { $('#inputName').focus(); }, 350);
}

function saveTask() {
  var name = $('#inputName').value.trim();
  if (!name) { $('#inputName').style.borderColor = 'var(--danger)'; return; }
  var cat = $('#inputCat').value;
  var note = $('#inputNote').value.trim();
  var date = $('#inputDate').value;
  var assignee = $('#inputAssignee').value;
  var attachments = pendingAttachments.length > 0 ? pendingAttachments.slice() : null;

  if (editingId !== null) {
    var t = tasks.find(function(x) { return x.id === editingId; });
    if (t) {
      t.name = name; t.cat = cat; t.note = note; t.date = date; t.assignee = assignee;
      t.attachments = attachments || [];
      saveTaskToCloud(editingId, taskData(t));
    }
    showToast('â™¥ å·²æ›´æ–°');
  } else {
    var key = 'task_' + Date.now();
    var newTask = { name: name, cat: cat, done: false, note: note, date: date, assignee: assignee, createdBy: myName, ts: Date.now() };
    if (attachments) newTask.attachments = attachments;
    saveTaskToCloud(key, newTask);
    showToast('â™¥ å·²æ–°å¢');
  }
  pendingAttachments = [];
  closeModal();
}

function askDelete(id) {
  pendingDeleteId = id;
  var t = tasks.find(function(x) { return x.id === id; });
  $('#confirmMsg').textContent = 'ç¢ºå®šè¦åˆªé™¤ã€Œ' + (t ? t.name : '') + 'ã€ï¼Ÿ';
  $('#confirmYes').textContent = 'åˆªé™¤';
  $('#confirmYes').className = 'btn btn-danger';
  confirmOvl.classList.add('open');
}

function doDelete() {
  if (pendingDeleteId !== null) {
    removeTaskFromCloud(pendingDeleteId);
    showToast('å·²åˆªé™¤');
  }
  pendingDeleteId = null;
  confirmOvl.classList.remove('open');
}

function closeModal() { modalOverlay.classList.remove('open'); editingId = null; pendingAttachments = []; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Toast
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var toastTimer;
function showToast(msg, longer) {
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function() { toastEl.classList.remove('show'); }, longer ? 6000 : 1800);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Settings (reset config)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
$('#settingsBtn').addEventListener('click', function() {
  pendingDeleteId = null;
  $('#confirmMsg').textContent = 'è¦åˆ‡æ›ç”¨æˆ¶å—ï¼Ÿ';
  $('#confirmYes').textContent = 'åˆ‡æ›';
  $('#confirmYes').className = 'btn btn-primary';
  confirmOvl.classList.add('open');
  var resetHandler = function() {
    store.del('v2_name');
    myName = '';
    isFirebaseReady = false;
    firebaseListenerAttached = false;
    firebaseDataLoaded = false;
    showScreen('setupScreen');
  };
  $('#confirmYes').onclick = function() { confirmOvl.classList.remove('open'); $('#confirmYes').className = 'btn btn-danger'; $('#confirmYes').textContent = 'åˆªé™¤'; resetHandler(); };
  $('#confirmNo').onclick = function() {
    confirmOvl.classList.remove('open');
    $('#confirmYes').textContent = 'åˆªé™¤';
    $('#confirmYes').className = 'btn btn-danger';
    $('#confirmYes').onclick = doDelete;
  };
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Init App
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initApp() {
  initCatSelect();
  renderFilters();
  initPhotoUpload();
  initAttachInput();
  initLightbox();

  $('#fabAdd').addEventListener('click', openAdd);
  $('#btnCancel').addEventListener('click', closeModal);
  $('#btnSave').addEventListener('click', saveTask);
  $('#confirmNo').addEventListener('click', function() { confirmOvl.classList.remove('open'); });
  $('#confirmYes').addEventListener('click', doDelete);
  modalOverlay.addEventListener('click', function(e) { if (e.target === modalOverlay) closeModal(); });
  confirmOvl.addEventListener('click', function(e) { if (e.target === confirmOvl) confirmOvl.classList.remove('open'); });
  $('#inputName').addEventListener('keydown', function(e) { if (e.key === 'Enter') saveTask(); });
  $('#inputName').addEventListener('input', function() { $('#inputName').style.borderColor = ''; });
}

function initCatSelect() {
  var sel = $('#inputCat');
  if (sel) sel.innerHTML = CATEGORIES.map(function(c) { return '<option value="' + c.id + '">' + c.name + '</option>'; }).join('');
}
</script>
</body>
</html>
