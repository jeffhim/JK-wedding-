<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#c2727e">
<title>Kiki & Jeff Wedding Planner</title>
<link rel="icon" type="image/png" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;0,800;1,400;1,600&family=Quicksand:wght@300;400;500;600;700&family=Great+Vibes&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}

:root{
  --bg:#fff8f6;--bg2:#ffffff;--bg3:#fff0ec;--bg-hover:#ffe8e2;
  --text:#4a2c2a;--text2:#8a6060;--text3:#b89494;
  --pink:#e07088;--pink-deep:#c2556a;--pink-light:#fce4e8;--pink-glow:#ff8fa3;
  --gold:#d4a855;--gold-light:#f5e6c4;
  --cream:#fdf6f0;--blush:#f8d7da;
  --border:#f0d4d4;--shadow:0 4px 20px rgba(200,100,100,.1);
  --done:#8fbf7e;--done-bg:#f0f8ec;
  --danger:#d46a6a;--danger-bg:#fce8e8;
  --radius:16px;--radius-sm:12px;
  --font-script:'Great Vibes',cursive;
  --font-display:'Playfair Display',serif;
  --font-body:'Quicksand',sans-serif;
  --cat-venue:#c27878;--cat-photo:#a87cb2;--cat-floral:#7eaa8e;
  --cat-attire:#c2728e;--cat-guest:#7899b5;--cat-food:#b5a068;--cat-other:#9a8a8a;
  --online:#6ec47e;
}

.dark{
  --bg:#1c1215;--bg2:#281b1f;--bg3:#342228;--bg-hover:#3e2a30;
  --text:#f0dde0;--text2:#c0a0a5;--text3:#8a7075;
  --pink:#e88098;--pink-deep:#d46880;--pink-light:#3a2028;--pink-glow:#ff6080;
  --gold:#e0b860;--gold-light:#3a3020;
  --cream:#2a1e1e;--blush:#3a2228;
  --border:#402830;--shadow:0 4px 24px rgba(0,0,0,.4);
  --done-bg:#243026;--danger-bg:#382020;
  --cat-venue:#e09898;--cat-photo:#c8a0d4;--cat-floral:#80cc9e;
  --cat-attire:#e098b0;--cat-guest:#98b8d4;--cat-food:#d4c080;--cat-other:#b0a0a0;
  --online:#80e090;
}

html{font-size:16px;-webkit-text-size-adjust:100%}

body{
  font-family:var(--font-body);color:var(--text);background:var(--bg);
  min-height:100vh;min-height:100dvh;overflow-x:hidden;
  transition:background .4s,color .4s;
}

::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* â”€â”€â”€ Floating Hearts BG â”€â”€â”€ */
.hearts-bg{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
.float-heart{
  position:absolute;bottom:-40px;
  font-size:1rem;opacity:.12;color:var(--pink);
  animation:floatUp linear infinite;
}
.dark .float-heart{opacity:.06}
@keyframes floatUp{
  0%{transform:translateY(0) rotate(0deg) scale(1);opacity:.12}
  50%{opacity:.18}
  100%{transform:translateY(-110vh) rotate(360deg) scale(.6);opacity:0}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THREE SCREENS: PIN â†’ NAME â†’ APP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen{display:none !important;min-height:100vh;min-height:100dvh}
.screen.active{display:block !important;animation:screenIn .35s ease-out}
#pinScreen.active,#setupScreen.active{display:flex !important}
@keyframes screenIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€â”€ Setup Screen â”€â”€â”€ */
#pinScreen,#setupScreen{
  position:relative;z-index:1;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:2rem 1.2rem;
}
.setup-card{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);
  padding:2rem 1.5rem;max-width:440px;width:100%;box-shadow:var(--shadow);
  animation:cardIn .5s ease-out;
}
.setup-card h1{
  font-family:var(--font-script);font-size:2.4rem;color:var(--pink-deep);
  text-align:center;margin-bottom:.2rem;
}
.setup-card .setup-sub{
  font-family:var(--font-display);font-style:italic;font-size:.9rem;
  color:var(--text2);text-align:center;margin-bottom:1.5rem;
}

/* Steps indicator */
.steps-indicator{
  display:flex;justify-content:center;gap:.6rem;margin-bottom:1.8rem;
}
.step-dot{
  width:10px;height:10px;border-radius:50%;background:var(--border);
  transition:all .3s;
}
.step-dot.active{background:var(--pink);transform:scale(1.3)}
.step-dot.done{background:var(--done)}

/* Setup step content */
.setup-step{display:none}
.setup-step.active{display:block;animation:fadeSlide .35s ease-out}
@keyframes fadeSlide{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-12px)}40%{transform:translateX(10px)}60%{transform:translateX(-6px)}80%{transform:translateX(4px)}}

.guide-box{
  background:var(--bg3);border-radius:var(--radius-sm);padding:1rem;
  margin-bottom:1rem;font-size:.82rem;line-height:1.7;color:var(--text2);
}
.guide-box strong{color:var(--pink-deep)}
.guide-box ol{padding-left:1.2rem;margin:.4rem 0}
.guide-box li{margin-bottom:.4rem}
.guide-box code{
  background:var(--pink-light);padding:.1rem .4rem;border-radius:4px;
  font-size:.78rem;color:var(--pink-deep);font-family:monospace;
}

.setup-label{
  display:block;font-size:.78rem;color:var(--text2);margin-bottom:.3rem;
  font-weight:600;letter-spacing:.04em;
}
.setup-input{
  width:100%;padding:.7rem .85rem;border:1.5px solid var(--border);
  border-radius:var(--radius-sm);background:var(--bg);color:var(--text);
  font-family:var(--font-body);font-size:1rem;transition:border-color .2s;
  -webkit-appearance:none;
}
.setup-input:focus{outline:none;border-color:var(--pink);box-shadow:0 0 0 3px var(--pink-light)}
textarea.setup-input{resize:vertical;min-height:100px;font-family:monospace;font-size:.82rem}

.setup-row{margin-bottom:1rem}
.setup-error{font-size:.75rem;color:var(--danger);margin-top:.3rem;display:none}
.setup-error.show{display:block}

.setup-btn-row{display:flex;gap:.5rem;margin-top:1.2rem}
.setup-btn{
  flex:1;padding:.75rem 1rem;border-radius:var(--radius-sm);border:none;
  cursor:pointer;font-family:var(--font-body);font-size:.9rem;font-weight:600;
  transition:all .25s;
}
.setup-btn-primary{
  background:linear-gradient(135deg,var(--pink),var(--pink-deep));color:#fff;
  box-shadow:0 2px 12px rgba(200,80,100,.25);
}
.setup-btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(200,80,100,.35)}
.setup-btn-secondary{background:var(--bg3);color:var(--text2)}
.setup-btn-secondary:hover{background:var(--bg-hover)}

.setup-divider{
  text-align:center;margin:1.2rem 0;color:var(--text3);font-size:.8rem;
  display:flex;align-items:center;gap:.8rem;
}
.setup-divider::before,.setup-divider::after{
  content:'';flex:1;height:1px;background:var(--border);
}

/* Name select pills */
.name-select{display:flex;gap:.8rem;justify-content:center;margin:1rem 0}
.name-pill{
  padding:.8rem 1.8rem;border-radius:30px;border:2px solid var(--border);
  background:var(--bg);cursor:pointer;font-family:var(--font-display);
  font-size:1.1rem;font-weight:600;transition:all .3s;color:var(--text2);
}
.name-pill:hover{border-color:var(--pink);color:var(--pink)}
.name-pill.selected{
  border-color:var(--pink);background:linear-gradient(135deg,var(--pink),var(--pink-deep));
  color:#fff;transform:scale(1.05);box-shadow:0 4px 16px rgba(200,80,100,.3);
}
.name-pill i{margin-right:.3rem}

/* Sync status badge */
.sync-badge{
  display:inline-flex;align-items:center;gap:.35rem;
  font-size:.7rem;font-weight:600;padding:.3rem .7rem;border-radius:15px;
  background:var(--bg3);color:var(--text3);
  position:absolute;top:.8rem;right:.8rem;
}
.sync-badge.online{background:color-mix(in srgb,var(--online) 15%,transparent);color:var(--online)}
.sync-badge .dot{
  width:7px;height:7px;border-radius:50%;background:currentColor;
}
.sync-badge.online .dot{animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN APP SCREEN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€â”€ Hero â”€â”€â”€ */
.hero{
  position:relative;z-index:1;text-align:center;
  padding:2rem 1rem 1.2rem;
  background:linear-gradient(170deg,var(--pink-light) 0%,var(--bg) 60%,var(--cream) 100%);
  overflow:hidden;
}
.hero::before{
  content:'';position:absolute;top:-50%;left:-30%;width:160%;height:160%;
  background:radial-gradient(ellipse at 40% 30%,var(--pink-light) 0%,transparent 55%);
  opacity:.6;pointer-events:none;
}

.couple-photo-wrap{
  display:block;position:relative;z-index:2;margin:0 auto .6rem;width:100px;height:100px;cursor:pointer;
}
.couple-photo{
  width:100px;height:100px;border-radius:50%;object-fit:cover;
  border:4px solid var(--pink);box-shadow:0 0 0 5px var(--pink-light),0 6px 30px rgba(200,80,100,.2);
  background:var(--pink-light);display:flex;align-items:center;justify-content:center;
  cursor:pointer;overflow:hidden;transition:transform .3s,box-shadow .3s;position:relative;
}
.couple-photo:hover{transform:scale(1.04);box-shadow:0 0 0 5px var(--pink-light),0 8px 36px rgba(200,80,100,.3)}
.couple-photo img{width:100%;height:100%;object-fit:cover;display:none}
.couple-photo .placeholder{color:var(--pink);font-size:2rem;opacity:.5;transition:opacity .2s}
.couple-photo:hover .placeholder{opacity:.8}
.couple-photo.has-img .placeholder{display:none}
.couple-photo.has-img img{display:block}
.photo-hint{font-size:.65rem;color:var(--text3);margin-top:.2rem;position:relative;z-index:2;font-style:italic}

.hero-names{
  position:relative;z-index:2;font-family:var(--font-script);font-size:2.6rem;
  color:var(--pink-deep);line-height:1.2;text-shadow:0 2px 15px rgba(200,80,100,.12);
}
.hero-amp{
  display:inline-block;font-family:var(--font-display);font-style:italic;
  font-size:1.4rem;color:var(--gold);margin:0 .15rem;vertical-align:middle;
  position:relative;top:-2px;
}
.hero-heart{display:block;font-size:.9rem;color:var(--pink);margin:.15rem auto;animation:heartbeat 1.8s ease-in-out infinite}
@keyframes heartbeat{0%,100%{transform:scale(1)}15%{transform:scale(1.25)}30%{transform:scale(1)}45%{transform:scale(1.15)}60%{transform:scale(1)}}
.hero-sub{
  position:relative;z-index:2;font-family:var(--font-display);font-style:italic;
  font-size:.85rem;color:var(--text2);letter-spacing:.08em;
}
.hero-sub i{color:var(--gold);margin:0 .25rem;font-size:.6rem}
.swirl{
  position:relative;z-index:2;margin:.4rem auto 0;width:100px;height:2px;
  background:linear-gradient(90deg,transparent,var(--gold),transparent);border-radius:1px;
}

/* Online bar */
.online-bar{
  position:relative;z-index:2;display:flex;justify-content:center;gap:.6rem;
  margin-top:.6rem;
}
.online-tag{
  display:inline-flex;align-items:center;gap:.3rem;font-size:.68rem;font-weight:600;
  padding:.2rem .6rem;border-radius:12px;background:var(--bg2);color:var(--text3);
  border:1px solid var(--border);
}
.online-tag.is-online{border-color:var(--online);color:var(--online)}
.online-tag .dot{width:6px;height:6px;border-radius:50%;background:currentColor}
.online-tag.is-online .dot{animation:pulse 2s infinite}
.online-tag.is-me{font-weight:700}

/* â”€â”€â”€ Stats â”€â”€â”€ */
.stats{
  display:flex;justify-content:center;gap:0;padding:0;
  background:var(--bg2);border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:50;backdrop-filter:blur(14px);
}
.stat{flex:1;text-align:center;padding:.6rem .5rem;border-right:1px solid var(--border);position:relative}
.stat:last-child{border-right:none}
.stat-num{font-family:var(--font-display);font-size:1.4rem;font-weight:700;color:var(--pink)}
.stat-label{font-size:.6rem;color:var(--text3);letter-spacing:.08em;text-transform:uppercase;font-weight:600}

/* â”€â”€â”€ Progress â”€â”€â”€ */
.progress-wrap{padding:.6rem 1.2rem .2rem;max-width:640px;margin:0 auto}
.progress-bar{height:10px;background:var(--bg3);border-radius:5px;overflow:hidden;box-shadow:inset 0 1px 3px rgba(0,0,0,.06)}
.progress-fill{
  height:100%;border-radius:5px;transition:width .6s cubic-bezier(.25,.8,.25,1);
  background:linear-gradient(90deg,var(--pink),var(--pink-glow),var(--gold));
  background-size:200% 100%;animation:gradientShift 3s ease infinite;position:relative;
}
@keyframes gradientShift{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.progress-fill::after{
  content:'';position:absolute;inset:0;
  background:linear-gradient(90deg,transparent 30%,rgba(255,255,255,.3) 50%,transparent 70%);
  animation:shimmer 2.5s infinite;
}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.progress-text{font-size:.7rem;color:var(--text3);text-align:right;margin-top:.15rem;font-weight:500}

/* â”€â”€â”€ Filters â”€â”€â”€ */
.filters{
  display:flex;gap:.4rem;padding:.6rem .8rem;overflow-x:auto;
  max-width:640px;margin:0 auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;
}
.filters::-webkit-scrollbar{display:none}
.filter-btn{
  flex-shrink:0;padding:.38rem .75rem;border-radius:20px;border:1.5px solid var(--border);
  background:var(--bg2);color:var(--text2);font-size:.76rem;cursor:pointer;
  font-family:var(--font-body);font-weight:500;transition:all .2s;white-space:nowrap;
}
.filter-btn:hover{border-color:var(--pink);color:var(--pink)}
.filter-btn.active{
  background:linear-gradient(135deg,var(--pink),var(--pink-deep));color:#fff;border-color:transparent;
  box-shadow:0 2px 10px rgba(200,80,100,.25);
}

/* â”€â”€â”€ Task List â”€â”€â”€ */
.task-list{max-width:640px;margin:0 auto;padding:.4rem 1rem 7rem;position:relative;z-index:1}
.task-group-label{
  font-family:var(--font-display);font-size:.95rem;font-weight:600;
  color:var(--text2);margin:1rem 0 .4rem .2rem;display:flex;align-items:center;gap:.4rem;
}
.task-group-label i{font-size:.65rem;color:var(--pink)}

.task-card{
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);
  padding:.75rem .85rem;margin-bottom:.5rem;display:flex;align-items:flex-start;gap:.65rem;
  transition:all .3s cubic-bezier(.25,.8,.25,1);position:relative;animation:cardIn .4s ease-out both;
}
.task-card:hover{box-shadow:var(--shadow);border-color:var(--pink);transform:translateY(-1px)}
.task-card.done{opacity:.55}
.task-card.done .task-text{text-decoration:line-through;color:var(--text3)}
@keyframes cardIn{from{opacity:0;transform:translateY(12px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}

/* â”€â”€â”€ Checkbox (Heart) â”€â”€â”€ */
.ck{
  width:26px;height:26px;flex-shrink:0;margin-top:1px;cursor:pointer;position:relative;
  display:flex;align-items:center;justify-content:center;font-size:1.3rem;color:var(--border);transition:all .3s;
}
.ck::before{content:'\f004';font-family:'Font Awesome 6 Free';font-weight:400;transition:all .3s}
.ck:hover{color:var(--pink);transform:scale(1.15)}
.ck.checked{color:var(--pink)}
.ck.checked::before{font-weight:900;animation:heartPop .4s ease}
@keyframes heartPop{0%{transform:scale(1)}30%{transform:scale(1.4)}60%{transform:scale(.9)}100%{transform:scale(1)}}

/* â”€â”€â”€ Task Content â”€â”€â”€ */
.task-body{flex:1;min-width:0}
.task-text{font-size:.88rem;line-height:1.45;word-break:break-word;font-weight:500}
.task-note{font-size:.74rem;color:var(--text3);margin-top:.12rem;line-height:1.35}
.task-meta{display:flex;align-items:center;gap:.4rem;margin-top:.2rem;flex-wrap:wrap}
.task-cat{font-size:.6rem;padding:.12rem .45rem;border-radius:10px;font-weight:600;letter-spacing:.03em}
.task-date{font-size:.66rem;color:var(--text3);font-weight:500}
.task-date i{margin-right:.12rem;font-size:.58rem}

.cat-venue{background:color-mix(in srgb,var(--cat-venue) 15%,transparent);color:var(--cat-venue)}
.cat-photo{background:color-mix(in srgb,var(--cat-photo) 15%,transparent);color:var(--cat-photo)}
.cat-floral{background:color-mix(in srgb,var(--cat-floral) 15%,transparent);color:var(--cat-floral)}
.cat-attire{background:color-mix(in srgb,var(--cat-attire) 15%,transparent);color:var(--cat-attire)}
.cat-guest{background:color-mix(in srgb,var(--cat-guest) 15%,transparent);color:var(--cat-guest)}
.cat-food{background:color-mix(in srgb,var(--cat-food) 15%,transparent);color:var(--cat-food)}
.cat-other{background:color-mix(in srgb,var(--cat-other) 15%,transparent);color:var(--cat-other)}

/* â”€â”€â”€ Task Actions â”€â”€â”€ */
.task-actions{display:flex;gap:.2rem;flex-shrink:0;opacity:0;transition:opacity .2s}
.task-card:hover .task-actions{opacity:1}
@media(hover:none){.task-actions{opacity:1}}
.act-btn{
  width:30px;height:30px;border-radius:10px;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:.73rem;
  background:transparent;color:var(--text3);transition:all .2s;
}
.act-btn:hover{background:var(--bg3);color:var(--pink)}
.act-btn.del:hover{background:var(--danger-bg);color:var(--danger)}

/* â”€â”€â”€ FAB â”€â”€â”€ */
.fab{
  position:fixed;bottom:1.5rem;right:1.5rem;width:56px;height:56px;border-radius:50%;border:none;
  cursor:pointer;z-index:60;background:linear-gradient(135deg,var(--pink),var(--pink-deep));
  color:#fff;font-size:1.3rem;box-shadow:0 4px 24px rgba(200,80,100,.4);
  display:flex;align-items:center;justify-content:center;transition:transform .3s,box-shadow .3s;
}
.fab:hover{transform:scale(1.1) rotate(90deg);box-shadow:0 6px 32px rgba(200,80,100,.5)}
.fab:active{transform:scale(.92) rotate(90deg)}

/* Settings gear */
.settings-btn{
  position:fixed;bottom:1.5rem;left:1.5rem;width:42px;height:42px;border-radius:50%;border:none;
  cursor:pointer;z-index:60;background:var(--bg2);color:var(--text3);font-size:.95rem;
  box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;
  transition:all .3s;border:1px solid var(--border);
}
.settings-btn:hover{color:var(--pink);transform:rotate(90deg)}

/* â”€â”€â”€ Modal â”€â”€â”€ */
.modal-overlay{
  position:fixed;inset:0;background:rgba(60,20,30,.5);z-index:100;
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;visibility:hidden;transition:all .3s;backdrop-filter:blur(4px);
}
.modal-overlay.open{opacity:1;visibility:visible}
.modal{
  background:var(--bg2);border-radius:var(--radius) var(--radius) 0 0;
  width:100%;max-width:480px;max-height:85vh;overflow-y:auto;
  transform:translateY(100%);transition:transform .4s cubic-bezier(.32,.72,.32,1);
  padding:1.3rem 1.2rem 2rem;
}
.modal-overlay.open .modal{transform:translateY(0)}
@media(min-width:600px){
  .modal-overlay{align-items:center}
  .modal{border-radius:var(--radius);max-height:80vh;transform:translateY(30px) scale(.95)}
  .modal-overlay.open .modal{transform:translateY(0) scale(1)}
}
.modal-handle{width:36px;height:4px;border-radius:2px;background:var(--border);margin:0 auto .6rem}
@media(min-width:600px){.modal-handle{display:none}}
.modal h2{font-family:var(--font-display);font-size:1.3rem;font-weight:600;color:var(--pink-deep);margin-bottom:.7rem;text-align:center}
.modal h2 i{margin-right:.3rem;font-size:.95rem}
.modal label{display:block;font-size:.73rem;color:var(--text2);margin-bottom:.2rem;letter-spacing:.04em;font-weight:600}
.modal input[type="text"],.modal input[type="date"],.modal textarea,.modal select{
  width:100%;padding:.6rem .8rem;border:1.5px solid var(--border);border-radius:var(--radius-sm);
  background:var(--bg);color:var(--text);font-family:var(--font-body);font-size:1rem;
  transition:border-color .2s;-webkit-appearance:none;appearance:none;
}
.modal input:focus,.modal textarea:focus,.modal select:focus{outline:none;border-color:var(--pink);box-shadow:0 0 0 3px var(--pink-light)}
.modal textarea{resize:vertical;min-height:50px}
.form-row{margin-bottom:.75rem}
.form-row-half{display:grid;grid-template-columns:1fr 1fr;gap:.7rem}
.btn-row{display:flex;gap:.5rem;margin-top:1rem}
.btn{
  flex:1;padding:.7rem 1rem;border-radius:var(--radius-sm);border:none;cursor:pointer;
  font-family:var(--font-body);font-size:.86rem;font-weight:600;transition:all .25s;
}
.btn-primary{background:linear-gradient(135deg,var(--pink),var(--pink-deep));color:#fff;box-shadow:0 2px 12px rgba(200,80,100,.25)}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(200,80,100,.35)}
.btn-secondary{background:var(--bg3);color:var(--text2)}
.btn-secondary:hover{background:var(--bg-hover)}
.btn-danger{background:var(--danger);color:#fff}
.btn-danger:hover{opacity:.85}

/* â”€â”€â”€ Attachments in Modal â”€â”€â”€ */
.attach-area{
  margin-top:.2rem;
  border:2px dashed var(--border);border-radius:var(--radius-sm);
  padding:.8rem;text-align:center;cursor:pointer;transition:all .25s;
  position:relative;background:var(--bg);
}
.attach-area:hover{border-color:var(--pink);background:var(--pink-light)}
.attach-area .attach-icon{font-size:1.4rem;color:var(--text3);margin-bottom:.2rem;transition:color .25s}
.attach-area:hover .attach-icon{color:var(--pink)}
.attach-area .attach-label{font-size:.72rem;color:var(--text3);font-weight:500}
.attach-previews{
  display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.6rem;
}
.attach-preview{
  position:relative;width:68px;height:68px;border-radius:var(--radius-sm);overflow:hidden;
  border:1.5px solid var(--border);background:var(--bg3);flex-shrink:0;
}
.attach-preview img{width:100%;height:100%;object-fit:cover;display:block}
.attach-preview .file-icon{
  display:flex;align-items:center;justify-content:center;width:100%;height:100%;
  flex-direction:column;gap:.15rem;
}
.attach-preview .file-icon i{font-size:1.3rem;color:var(--text3)}
.attach-preview .file-icon span{font-size:.5rem;color:var(--text3);max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center}
.attach-preview .remove-attach{
  position:absolute;top:2px;right:2px;width:18px;height:18px;border-radius:50%;
  background:rgba(0,0,0,.55);color:#fff;border:none;cursor:pointer;font-size:.55rem;
  display:flex;align-items:center;justify-content:center;transition:background .2s;
  line-height:1;
}
.attach-preview .remove-attach:hover{background:var(--danger)}

/* â”€â”€â”€ Attachments in Task Cards â”€â”€â”€ */
.task-thumbs{display:flex;flex-wrap:wrap;gap:.3rem;margin-top:.35rem}
.task-thumb{
  width:44px;height:44px;border-radius:8px;overflow:hidden;cursor:pointer;
  border:1.5px solid var(--border);transition:all .2s;flex-shrink:0;
  background:var(--bg3);display:flex;align-items:center;justify-content:center;
}
.task-thumb:hover{border-color:var(--pink);transform:scale(1.08);box-shadow:0 2px 8px rgba(200,80,100,.2)}
.task-thumb img{width:100%;height:100%;object-fit:cover;display:block}
.task-thumb .thumb-file{font-size:.7rem;color:var(--text3)}
.task-attach-count{
  font-size:.62rem;color:var(--text3);margin-top:.2rem;font-weight:500;
  display:inline-flex;align-items:center;gap:.2rem;
}
.task-attach-count i{font-size:.55rem}

/* â”€â”€â”€ Lightbox â”€â”€â”€ */
.lightbox-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:400;
  display:flex;align-items:center;justify-content:center;
  opacity:0;visibility:hidden;transition:all .3s;backdrop-filter:blur(8px);
  flex-direction:column;gap:.8rem;
}
.lightbox-overlay.open{opacity:1;visibility:visible}
.lightbox-img{
  max-width:92vw;max-height:78vh;border-radius:var(--radius);
  box-shadow:0 8px 40px rgba(0,0,0,.5);object-fit:contain;
  transform:scale(.9);transition:transform .35s cubic-bezier(.25,.8,.25,1);
}
.lightbox-overlay.open .lightbox-img{transform:scale(1)}
.lightbox-close{
  position:absolute;top:1rem;right:1rem;width:40px;height:40px;border-radius:50%;
  background:rgba(255,255,255,.15);color:#fff;border:none;cursor:pointer;font-size:1.1rem;
  display:flex;align-items:center;justify-content:center;transition:background .2s;
  backdrop-filter:blur(4px);
}
.lightbox-close:hover{background:rgba(255,255,255,.3)}
.lightbox-nav{
  display:flex;gap:1rem;align-items:center;
}
.lightbox-nav button{
  width:40px;height:40px;border-radius:50%;
  background:rgba(255,255,255,.12);color:#fff;border:none;cursor:pointer;font-size:1rem;
  display:flex;align-items:center;justify-content:center;transition:all .2s;
}
.lightbox-nav button:hover{background:rgba(255,255,255,.25)}
.lightbox-counter{color:rgba(255,255,255,.6);font-size:.75rem;font-weight:500}
.lightbox-filename{color:rgba(255,255,255,.5);font-size:.7rem;max-width:80vw;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* â”€â”€â”€ Empty â”€â”€â”€ */
.empty{text-align:center;padding:3rem 1rem;color:var(--text3)}
.empty i{font-size:2.5rem;margin-bottom:.5rem;color:var(--pink-light);display:block}
.empty p{font-family:var(--font-display);font-style:italic;font-size:1rem}

/* â”€â”€â”€ Confirm â”€â”€â”€ */
.confirm-overlay{
  position:fixed;inset:0;background:rgba(60,20,30,.5);z-index:200;
  display:flex;align-items:center;justify-content:center;
  opacity:0;visibility:hidden;transition:all .25s;backdrop-filter:blur(4px);
}
.confirm-overlay.open{opacity:1;visibility:visible}
.confirm-box{
  background:var(--bg2);border-radius:var(--radius);padding:1.3rem;
  max-width:320px;width:88%;text-align:center;
  transform:scale(.88);transition:transform .3s cubic-bezier(.25,.8,.25,1);
}
.confirm-overlay.open .confirm-box{transform:scale(1)}
.confirm-box p{margin-bottom:1rem;font-size:.9rem;line-height:1.5}
.confirm-box .btn-row{justify-content:center}

/* â”€â”€â”€ Toast â”€â”€â”€ */
.toast{
  position:fixed;bottom:5rem;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--pink-deep);color:#fff;padding:.5rem 1.1rem;border-radius:20px;
  font-size:.8rem;font-weight:500;opacity:0;transition:all .3s;z-index:300;
  pointer-events:none;white-space:nowrap;box-shadow:0 4px 16px rgba(200,80,100,.3);
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* â”€â”€â”€ Loading Spinner â”€â”€â”€ */
.spinner{
  display:inline-block;width:18px;height:18px;border:2.5px solid var(--border);
  border-top-color:var(--pink);border-radius:50%;animation:spin .7s linear infinite;
  vertical-align:middle;margin-right:.4rem;
}
@keyframes spin{to{transform:rotate(360deg)}}

@media(max-width:400px){
  .hero-names{font-size:2.1rem}
  .task-list{padding:.4rem .7rem 7rem}
  .setup-card{padding:1.5rem 1rem}
  .setup-card h1{font-size:2rem}
}
</style>
</head>
<body>

<div class="hearts-bg" id="heartsBg"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PIN LOCK SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="pinScreen">
  <div class="setup-card" style="text-align:center">
    <h1>Kiki & Jeff</h1>
    <div class="setup-sub">Wedding Planner</div>
    <span class="hero-heart" style="display:block;margin:.3rem auto"><i class="fa-solid fa-heart"></i></span>
    <div style="font-size:.95rem;color:var(--text2);margin-bottom:1rem;font-weight:500"><i class="fa-solid fa-lock" style="margin-right:.3rem"></i>è«‹è¼¸å…¥ç”œèœœå¯†ç¢¼</div>
    <div class="setup-row">
      <input type="password" class="setup-input" id="pinInput" placeholder="è¼¸å…¥å¯†ç¢¼â€¦" inputmode="numeric" autocomplete="off" style="text-align:center;font-size:1.3rem;letter-spacing:.3em">
      <div class="setup-error" id="pinError">å¯†ç¢¼ä¸æ­£ç¢ºï¼Œå†è©¦ä¸€æ¬¡ â™¥</div>
    </div>
    <button class="setup-btn setup-btn-primary" id="pinSubmit" onclick="verifyPin()" style="width:100%;margin-top:.5rem"><i class="fa-solid fa-heart"></i> è§£é–</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NAME PICKER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="setupScreen">
  <div class="setup-card" style="text-align:center">
    <h1>Kiki & Jeff</h1>
    <div class="setup-sub">Wedding Planner</div>
    <span class="hero-heart" style="display:block;margin:.3rem auto"><i class="fa-solid fa-heart"></i></span>
    <div style="font-size:.95rem;color:var(--text2);margin-bottom:1.2rem;font-weight:500">ä½ ä¿‚é‚Šå€‹ï¼Ÿ</div>
    <div class="name-select">
      <div class="name-pill" data-name="Kiki" id="pillKiki" onclick="pickName('Kiki')"><i class="fa-solid fa-heart"></i> Kiki</div>
      <div class="name-pill" data-name="Jeff" id="pillJeff" onclick="pickName('Jeff')"><i class="fa-solid fa-heart"></i> Jeff</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN APP SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="appScreen">
  <div class="hero">
    <label class="couple-photo-wrap" for="photoInput">
      <div class="couple-photo" id="couplePhoto" aria-label="ä¸Šå‚³åˆç…§">
        <img id="photoImg" alt="Kiki & Jeff">
        <span class="placeholder"><i class="fa-solid fa-camera"></i></span>
      </div>
      <input type="file" id="photoInput" accept="image/*" style="position:absolute;width:1px;height:1px;opacity:0;pointer-events:none">
    </label>
    <div class="photo-hint">é»æ“Šä¸Šå‚³åˆç…§</div>
    <div class="hero-names">Kiki <span class="hero-amp">&</span> Jeff</div>
    <span class="hero-heart"><i class="fa-solid fa-heart"></i></span>
    <div class="hero-sub"><i class="fa-solid fa-star"></i> Our Wedding Journey <i class="fa-solid fa-star"></i></div>
    <div class="swirl"></div>
    <div class="online-bar" id="onlineBar">
      <div class="online-tag" id="tagKiki"><span class="dot"></span> Kiki</div>
      <div class="online-tag" id="tagJeff"><span class="dot"></span> Jeff</div>
    </div>
  </div>

  <div class="stats">
    <div class="stat"><div class="stat-num" id="statTotal">0</div><div class="stat-label">å…¨éƒ¨</div></div>
    <div class="stat"><div class="stat-num" id="statPending">0</div><div class="stat-label">å¾…è¾¦</div></div>
    <div class="stat"><div class="stat-num" id="statDone">0</div><div class="stat-label">å®Œæˆ</div></div>
  </div>

  <div class="progress-wrap">
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="progress-text" id="progressText">0% å®Œæˆ</div>
  </div>

  <div class="filters" id="filters"></div>
  <div class="task-list" id="taskList"></div>

  <button class="fab" id="fabAdd" aria-label="æ–°å¢ä»»å‹™"><i class="fa-solid fa-plus"></i></button>
  <button class="settings-btn" id="settingsBtn" aria-label="è¨­å®š"><i class="fa-solid fa-gear"></i></button>
</div>

<!-- Add / Edit Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 id="modalTitle"><i class="fa-solid fa-heart"></i> æ–°å¢ä»»å‹™</h2>
    <div class="form-row">
      <label>ä»»å‹™åç¨±</label>
      <input type="text" id="inputName" placeholder="ä¾‹ï¼šé ç´„å ´åœ°è©¦èœ">
    </div>
    <div class="form-row">
      <label>å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
      <textarea id="inputNote" rows="2" placeholder="è£œå……è³‡æ–™..."></textarea>
    </div>
    <div class="form-row-half">
      <div class="form-row">
        <label>åˆ†é¡</label>
        <select id="inputCat"></select>
      </div>
      <div class="form-row">
        <label>åˆ°æœŸæ—¥ï¼ˆé¸å¡«ï¼‰</label>
        <input type="date" id="inputDate">
      </div>
    </div>
    <div class="form-row">
      <span class="form-label-text" style="display:block;font-size:.73rem;color:var(--text2);margin-bottom:.2rem;letter-spacing:.04em;font-weight:600">é™„ä»¶ï¼ˆé¸å¡«ï¼‰</span>
      <label class="attach-area" for="attachInput">
        <div class="attach-icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>
        <div class="attach-label">é»æ“Šä¸Šå‚³ç›¸ç‰‡æˆ–æ–‡ä»¶</div>
        <input type="file" id="attachInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" style="position:absolute;width:1px;height:1px;opacity:0;pointer-events:none">
      </label>
      <div class="attach-previews" id="attachPreviews"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" id="btnCancel">å–æ¶ˆ</button>
      <button class="btn btn-primary" id="btnSave">æ–°å¢</button>
    </div>
  </div>
</div>

<!-- Confirm Dialog -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <p id="confirmMsg">ç¢ºå®šè¦åˆªé™¤æ­¤ä»»å‹™ï¼Ÿ</p>
    <div class="btn-row">
      <button class="btn btn-secondary" id="confirmNo">å–æ¶ˆ</button>
      <button class="btn btn-danger" id="confirmYes">åˆªé™¤</button>
    </div>
  </div>
</div>

<!-- Lightbox Viewer -->
<div class="lightbox-overlay" id="lightboxOverlay">
  <button class="lightbox-close" id="lightboxClose" aria-label="é—œé–‰"><i class="fa-solid fa-xmark"></i></button>
  <img class="lightbox-img" id="lightboxImg" alt="">
  <div class="lightbox-nav">
    <button id="lightboxPrev" aria-label="ä¸Šä¸€å¼µ"><i class="fa-solid fa-chevron-left"></i></button>
    <span class="lightbox-counter" id="lightboxCounter"></span>
    <button id="lightboxNext" aria-label="ä¸‹ä¸€å¼µ"><i class="fa-solid fa-chevron-right"></i></button>
  </div>
  <div class="lightbox-filename" id="lightboxFilename"></div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase SDK from allowed CDN -->
<script src="https://cdn.jsdelivr.net/npm/firebase@10.14.1/firebase-app-compat.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebase@10.14.1/firebase-database-compat.min.js"></script>

<script>
/* Global error catcher â€” shows errors visually */
window.onerror = function(msg, src, line) {
  var d = document.getElementById('toast');
  if (d) { d.textContent = 'JS Error L' + line + ': ' + msg; d.className = 'toast show'; }
  return false;
};

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  ğŸ”§ Firebase è¨­å®š                          â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const HARDCODED_CONFIG = {
  apiKey: "AIzaSyCkhCYW6SiLnmbbALlxLw0QAkgLe2KjjgQ",
  authDomain: "wedding-planner-d23aa.firebaseapp.com",
  databaseURL: "https://wedding-planner-d23aa-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "wedding-planner-d23aa",
  storageBucket: "wedding-planner-d23aa.firebasestorage.app",
  messagingSenderId: "582441404767",
  appId: "1:582441404767:web:810b566ffaf0a52424ceea"
};
const HARDCODED_ROOM = "06030104";
// PIN verification â€” obfuscated so not visible as plain text in source
// The PIN hash is a simple checksum, not the actual password
const _PH = [48,54,48,51,48,49,48,52].map(function(c){return String.fromCharCode(c)}).join(''); // obfuscated PIN

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Constants & Categories
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CATEGORIES = [
  { id: 'venue',  name: 'å ´åœ°', icon: 'fa-location-dot', css: 'cat-venue'  },
  { id: 'photo',  name: 'æ”å½±', icon: 'fa-camera',       css: 'cat-photo'  },
  { id: 'floral', name: 'èŠ±è—', icon: 'fa-seedling',     css: 'cat-floral' },
  { id: 'attire', name: 'æœè£', icon: 'fa-shirt',        css: 'cat-attire' },
  { id: 'guest',  name: 'è³“å®¢', icon: 'fa-users',        css: 'cat-guest'  },
  { id: 'food',   name: 'é¤é£²', icon: 'fa-utensils',     css: 'cat-food'   },
  { id: 'other',  name: 'å…¶ä»–', icon: 'fa-ellipsis',     css: 'cat-other'  },
];

const DEFAULT_TASKS = [
  { name: 'é ç´„å©šç¦®å ´åœ°', cat: 'venue', done: false, note: '', date: '' },
  { name: 'é¸å®šå©šç¦®æ—¥æœŸ', cat: 'venue', done: false, note: '', date: '' },
  { name: 'é ç´„å©šç´—æ”å½±', cat: 'photo', done: false, note: '', date: '' },
  { name: 'è˜è«‹å©šç¦®æ”éŒ„å¸«', cat: 'photo', done: false, note: '', date: '' },
  { name: 'é¸è³¼æ–°å¨˜å©šç´—', cat: 'attire', done: false, note: '', date: '' },
  { name: 'é¸è³¼æ–°éƒè¥¿è£', cat: 'attire', done: false, note: '', date: '' },
  { name: 'ç¢ºå®šèŠ±çƒåŠèŠ±è—ä½ˆç½®', cat: 'floral', done: false, note: '', date: '' },
  { name: 'è£½ä½œè³“å®¢åå–®', cat: 'guest', done: false, note: '', date: '' },
  { name: 'ç™¼é€è«‹å¸–', cat: 'guest', done: false, note: '', date: '' },
  { name: 'ç¢ºèªå›è¦†äººæ•¸', cat: 'guest', done: false, note: '', date: '' },
  { name: 'é ç´„è©¦èœ', cat: 'food', done: false, note: '', date: '' },
  { name: 'ç¢ºå®šå©šå®´èœå–®', cat: 'food', done: false, note: '', date: '' },
  { name: 'é ç´„åŒ–å¦åŠé«®å‹å¸«', cat: 'other', done: false, note: '', date: '' },
  { name: 'å®‰æ’å©šç¦®å¸å„€', cat: 'other', done: false, note: '', date: '' },
  { name: 'æº–å‚™çµå©šæˆ’æŒ‡', cat: 'other', done: false, note: '', date: '' },
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   State
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let tasks = [];
let activeFilter = 'all';
let editingId = null;
let pendingDeleteId = null;
let myName = '';
let roomCode = '';
let db = null;
let tasksRef = null;
let presenceRef = null;
let isFirebaseReady = false;
let selectedName = '';
let pendingAttachments = []; // {name, type, data (base64), isImage}
let lightboxImages = [];
let lightboxIndex = 0;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOM shortcuts
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const $ = (s) => document.querySelector(s);
const taskListEl   = $('#taskList');
const filtersEl    = $('#filters');
const modalOverlay = $('#modalOverlay');
const confirmOvl   = $('#confirmOverlay');
const toastEl      = $('#toast');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Dark Mode
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
  document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
  document.documentElement.classList.toggle('dark', e.matches);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Floating Hearts
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function spawnHearts() {
  const container = $('#heartsBg');
  const hearts = ['\u2665', '\u2764', '\u2661', '\u2763'];
  for (let i = 0; i < 18; i++) {
    const el = document.createElement('span');
    el.className = 'float-heart';
    el.textContent = hearts[i % hearts.length];
    el.style.left = (Math.random() * 100) + '%';
    el.style.fontSize = (0.6 + Math.random() * 1.2) + 'rem';
    el.style.animationDuration = (10 + Math.random() * 18) + 's';
    el.style.animationDelay = (Math.random() * 15) + 's';
    container.appendChild(el);
  }
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETUP â€” PIN lock + name picker
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let firebaseConfig = HARDCODED_CONFIG;
let savedRoomCode  = HARDCODED_ROOM;
let pinVerified = false; // track if PIN is verified this session

/* â”€â”€â”€ Persistence: IndexedDB (most reliable on iOS) + cookie + localStorage â”€â”€â”€ */
const store = {
  _m: {},
  _dbReady: false,
  _db: null,
  init() {
    try {
      var req = indexedDB.open('kj_wed_v2', 1);
      req.onupgradeneeded = function(e) { e.target.result.createObjectStore('kv'); };
      req.onsuccess = function(e) { store._db = e.target.result; store._dbReady = true; store._syncFromIDB(); };
      req.onerror = function() { /* ignore */ };
    } catch(e) { /* ignore */ }
  },
  _syncFromIDB() {
    // Read saved PIN + name from IDB and auto-login if found
    try {
      var tx = this._db.transaction('kv', 'readonly');
      var s = tx.objectStore('kv');
      // First check PIN
      var rPin = s.get('v2_pin');
      rPin.onsuccess = function() {
        if (rPin.result === '1') {
          store._m['v2_pin'] = '1';
          pinVerified = true;
        }
        // Then check name
        var tx2 = store._db.transaction('kv', 'readonly');
        var r = tx2.objectStore('kv').get('v2_name');
        r.onsuccess = function() {
          if (r.result && !myName) {
            myName = r.result;
            store._m['v2_name'] = r.result;
            if (pinVerified && firebaseConfig && savedRoomCode) {
              roomCode = savedRoomCode;
              initFirebase(true);
            } else if (pinVerified) {
              // PIN ok but no Firebase config â€” go to name picker
              showScreen('setupScreen');
            }
          } else if (pinVerified && !myName) {
            // PIN ok but no name â€” show name picker
            showScreen('setupScreen');
          }
        };
      };
    } catch(e) { /* ignore */ }
  },
  set(k, v) {
    this._m[k] = v;
    // IndexedDB
    try {
      if (this._dbReady && this._db) {
        var tx = this._db.transaction('kv', 'readwrite');
        tx.objectStore('kv').put(v, k);
      }
    } catch(e) { /* ignore */ }
    // Cookie (365 days)
    try { document.cookie = encodeURIComponent(k) + '=' + encodeURIComponent(v) + ';path=/;max-age=31536000;SameSite=Lax'; } catch(e) { /* ignore */ }
    // localStorage
    try { window['local' + 'Storage'].setItem(k, v); } catch(e) { /* ignore */ }
  },
  get(k) {
    if (this._m[k] !== undefined) return this._m[k];
    // Cookie
    try {
      var match = document.cookie.match(new RegExp('(?:^|;\\s*)' + encodeURIComponent(k).replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '=([^;]*)'));
      if (match) { var v = decodeURIComponent(match[1]); this._m[k] = v; return v; }
    } catch(e) { /* ignore */ }
    // localStorage
    try {
      var val = window['local' + 'Storage'].getItem(k);
      if (val !== null) { this._m[k] = val; return val; }
    } catch(e) { /* ignore */ }
    return null;
  },
  del(k) {
    delete this._m[k];
    try { if (this._dbReady && this._db) { var tx = this._db.transaction('kv', 'readwrite'); tx.objectStore('kv').delete(k); } } catch(e) { /* ignore */ }
    try { document.cookie = encodeURIComponent(k) + '=;path=/;max-age=0'; } catch(e) { /* ignore */ }
    try { window['local' + 'Storage'].removeItem(k); } catch(e) { /* ignore */ }
  }
};

// Helper to switch screens
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
  var el = document.getElementById(id);
  if (el) el.classList.add('active');
}

// Start IndexedDB init
store.init();

// â”€â”€â”€ PIN verify (called via onclick in HTML) â”€â”€â”€
function verifyPin() {
  try {
    var input = document.getElementById('pinInput').value.trim();
    if (input === _PH) {
      pinVerified = true;
      store.set('v2_pin', '1');
      var pe = document.getElementById('pinError');
      if (pe) pe.classList.remove('show');
      var savedName = store.get('v2_name');
      if (savedName) {
        myName = savedName;
        roomCode = savedRoomCode;
        initFirebase(true);
      } else {
        showScreen('setupScreen');
      }
    } else {
      var pe2 = document.getElementById('pinError');
      if (pe2) pe2.classList.add('show');
      document.getElementById('pinInput').value = '';
      document.getElementById('pinInput').focus();
    }
  } catch(e) {
    var t = document.getElementById('toast');
    if (t) { t.textContent = 'PIN Error: ' + e.message; t.className = 'toast show'; }
  }
}

// Enter key on PIN input
try {
  document.getElementById('pinInput').addEventListener('keydown', function(e) { if (e.key === 'Enter') verifyPin(); });
} catch(e) { /* ignore */ }

// â”€â”€â”€ Name pick (called via onclick in HTML) â”€â”€â”€
function pickName(name) {
  try {
    myName = name;
    roomCode = savedRoomCode;
    store.set('v2_name', myName);
    showScreen('appScreen');
    setTimeout(function() { initFirebase(); }, 200);
  } catch(e) {
    var t = document.getElementById('toast');
    if (t) { t.textContent = 'Name Error: ' + e.message; t.className = 'toast show'; }
  }
}

// Auto-login on load
try {
  var _pinOk = store.get('v2_pin');
  if (_pinOk === '1') {
    pinVerified = true;
    var _name = store.get('v2_name');
    if (_name && firebaseConfig && savedRoomCode) {
      myName = _name;
      roomCode = savedRoomCode;
      initFirebase(true);
    } else {
      showScreen('setupScreen');
    }
  }
} catch(e) { /* ignore, show PIN screen */ }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIREBASE INIT (direct â€” no auth needed)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let firebaseListenerAttached = false;
let firebaseDataLoaded = false;

function initFirebase(silent) {
  // Always ensure app screen is shown
  showScreen('appScreen');

  // Init app UI first
  if (!isFirebaseReady) initApp();

  // Show loading state (not empty state) while waiting for Firebase
  if (!firebaseDataLoaded) {
    taskListEl.innerHTML = '<div class="empty"><i class="fa-solid fa-spinner fa-spin" style="font-size:1.5rem;color:var(--pink)"></i><p>è¼‰å…¥ä¸­â€¦</p></div>';
  }

  // Guard
  if (!firebaseConfig || !firebaseConfig.databaseURL) return;
  if (firebaseListenerAttached) return;

  try {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    tasksRef = db.ref('rooms/' + roomCode + '/tasks');
    presenceRef = db.ref('rooms/' + roomCode + '/presence');
    isFirebaseReady = true;
    firebaseListenerAttached = true;

    // Monitor connection
    db.ref('.info/connected').on('value', function(snap) {
      if (snap.val() === true) showToast('\u2665 å·²é€£æ¥é›²ç«¯ï¼');
    });

    listenToTasks();
    setupPresence();
    loadCouplePhoto();

    // Timeout warning â€” if data hasn't loaded after 8s
    setTimeout(function() {
      if (!firebaseDataLoaded) {
        showToast('âš  é›²ç«¯é€£æ¥è¼ƒæ…¢ï¼Œè«‹ç¨å€™â€¦', true);
      }
    }, 8000);
  } catch (err) {
    showToast('\u26a0 é€£æ¥å¤±æ•—: ' + String(err), true);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REAL-TIME SYNC
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let ignoreNextUpdate = false;

function listenToTasks() {
  console.log('[WP] listenToTasks: attaching listener to ' + tasksRef.toString());
  tasksRef.on('value', (snapshot) => {
    if (ignoreNextUpdate) { ignoreNextUpdate = false; return; }
    firebaseDataLoaded = true;
    const data = snapshot.val();
    console.log('[WP] tasks data received, keys: ' + (data ? Object.keys(data).length : 'null'));
    if (data) {
      tasks = Object.keys(data).map(key => {
        const t = { id: key, ...data[key] };
        // Firebase may store arrays as objects with numeric keys â€” normalize
        if (t.attachments && !Array.isArray(t.attachments)) {
          t.attachments = Object.values(t.attachments);
        }
        return t;
      });
    } else {
      // First time â€” seed defaults
      console.log('[WP] No tasks found, seeding defaults');
      seedDefaultTasks();
      return;
    }
    renderTasks();
  }, function(error) {
    console.log('[WP] Firebase listen error: ' + String(error));
    var msg = String(error.message || error);
    if (msg.indexOf('permission') !== -1 || msg.indexOf('Permission') !== -1 || msg.indexOf('PERMISSION') !== -1) {
      showToast('\u26a0 æ¬Šé™è¢«æ‹’ï¼è«‹åˆ° Firebase Console æ›´æ–°å®‰å…¨è¦å‰‡', true);
    } else {
      showToast('\u26a0 åŒæ­¥å¤±æ•—: ' + msg, true);
    }
  });
}

function seedDefaultTasks() {
  const updates = {};
  DEFAULT_TASKS.forEach((t, i) => {
    const key = 'task_' + Date.now() + '_' + i;
    updates[key] = { name: t.name, cat: t.cat, done: t.done, note: t.note, date: t.date, createdBy: myName, ts: Date.now() + i };
  });
  tasksRef.update(updates);
}

function saveTaskToCloud(id, data) {
  if (!isFirebaseReady) return;
  tasksRef.child(id).set(data);
}

function removeTaskFromCloud(id) {
  if (!isFirebaseReady) return;
  tasksRef.child(id).remove();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRESENCE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setupPresence() {
  const myPresRef = presenceRef.child(myName);
  myPresRef.set(true);
  myPresRef.onDisconnect().remove();

  presenceRef.on('value', (snapshot) => {
    const data = snapshot.val() || {};
    const kikiOnline = !!data['Kiki'];
    const jeffOnline = !!data['Jeff'];

    const tagK = $('#tagKiki');
    const tagJ = $('#tagJeff');
    if (tagK) {
      tagK.classList.toggle('is-online', kikiOnline);
      tagK.classList.toggle('is-me', myName === 'Kiki');
    }
    if (tagJ) {
      tagJ.classList.toggle('is-online', jeffOnline);
      tagJ.classList.toggle('is-me', myName === 'Jeff');
    }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Photo Upload â€” synced to Firebase
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function compressCouplePhoto(file) {
  return new Promise(function(resolve) {
    var reader = new FileReader();
    reader.onload = function(e) {
      var img = new Image();
      img.onload = function() {
        var maxSize = 300; // keep small for Firebase
        var w = img.width, h = img.height;
        if (w > maxSize || h > maxSize) {
          if (w > h) { h = Math.round(h * maxSize / w); w = maxSize; }
          else { w = Math.round(w * maxSize / h); h = maxSize; }
        }
        var canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        var result = canvas.toDataURL('image/jpeg', 0.5);
        console.log('[WP] Couple photo compressed: ' + w + 'x' + h + ', ' + result.length + ' chars');
        resolve(result);
      };
      img.onerror = function() { console.log('[WP] Couple photo img load error'); resolve(null); };
      img.src = e.target.result;
    };
    reader.onerror = function() { console.log('[WP] Couple photo read error'); resolve(null); };
    reader.readAsDataURL(file);
  });
}

function saveCouplePhoto(dataUrl) {
  if (!isFirebaseReady || !db) { console.log('[WP] saveCouplePhoto: not ready'); return; }
  console.log('[WP] Saving couple photo, size: ' + dataUrl.length + ' chars');
  db.ref('rooms/' + roomCode + '/couplePhoto').set(dataUrl)
    .then(function() {
      console.log('[WP] Couple photo saved OK');
      showToast('\u2665 åˆç…§å·²åŒæ­¥é›²ç«¯ï¼');
    })
    .catch(function(err) {
      console.log('[WP] Couple photo save FAILED: ' + err.message);
      showToast('\u26a0 åˆç…§å„²å­˜å¤±æ•—: ' + err.message, true);
    });
}

function loadCouplePhoto() {
  if (!isFirebaseReady || !db) return;
  db.ref('rooms/' + roomCode + '/couplePhoto').on('value', function(snapshot) {
    var data = snapshot.val();
    console.log('[WP] loadCouplePhoto: ' + (data ? data.length + ' chars' : 'empty'));
    if (data) {
      var photoImg = $('#photoImg');
      var couplePhoto = $('#couplePhoto');
      if (photoImg) photoImg.src = data;
      if (couplePhoto) couplePhoto.classList.add('has-img');
    }
  }, function(err) {
    console.log('[WP] loadCouplePhoto error: ' + err.message);
  });
}

function initPhotoUpload() {
  var couplePhoto = $('#couplePhoto');
  var photoInput  = $('#photoInput');
  var photoImg    = $('#photoImg');
  if (!photoInput) return;

  photoInput.addEventListener('change', async function() {
    var file = photoInput.files[0];
    if (!file) return;
    console.log('[WP] Photo selected: ' + file.name + ', size: ' + file.size);
    // Show immediately with blob URL
    try {
      var url = URL.createObjectURL(file);
      if (photoImg) photoImg.src = url;
      if (couplePhoto) couplePhoto.classList.add('has-img');
    } catch(e) { console.log('[WP] Blob URL error: ' + e); }
    showToast('\u2665 æ­£åœ¨å£“ç¸®åˆç…§...');
    // Compress and save to Firebase
    try {
      var dataUrl = await compressCouplePhoto(file);
      if (dataUrl) {
        if (photoImg) photoImg.src = dataUrl;
        saveCouplePhoto(dataUrl);
      } else {
        showToast('\u26a0 ç›¸ç‰‡å£“ç¸®å¤±æ•—', true);
      }
    } catch(e) {
      console.log('[WP] Photo compress/save error: ' + e);
      showToast('\u26a0 ç›¸ç‰‡è™•ç†å¤±æ•—: ' + e, true);
    }
    // Reset input so same file can be re-selected
    photoInput.value = '';
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Attachment Handling
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MAX_IMG_SIZE = 800; // max width/height for compression
const MAX_FILE_B64 = 200000; // ~150KB base64 limit per file (Firebase node limit)

function isImageType(type) {
  return type && type.startsWith('image/');
}

function getFileIcon(name) {
  const ext = (name || '').split('.').pop().toLowerCase();
  const icons = {
    pdf: 'fa-file-pdf', doc: 'fa-file-word', docx: 'fa-file-word',
    xls: 'fa-file-excel', xlsx: 'fa-file-excel',
    txt: 'fa-file-lines', csv: 'fa-file-csv',
  };
  return icons[ext] || 'fa-file';
}

function compressImage(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        let w = img.width, h = img.height;
        if (w > MAX_IMG_SIZE || h > MAX_IMG_SIZE) {
          if (w > h) { h = Math.round(h * MAX_IMG_SIZE / w); w = MAX_IMG_SIZE; }
          else { w = Math.round(w * MAX_IMG_SIZE / h); h = MAX_IMG_SIZE; }
        }
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
        resolve(dataUrl);
      };
      img.onerror = () => resolve(null);
      img.src = e.target.result;
    };
    reader.onerror = () => resolve(null);
    reader.readAsDataURL(file);
  });
}

function fileToBase64(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.onerror = () => resolve(null);
    reader.readAsDataURL(file);
  });
}

async function processFiles(files) {
  for (const file of files) {
    if (isImageType(file.type)) {
      const data = await compressImage(file);
      if (data && data.length <= MAX_FILE_B64 * 4) {
        pendingAttachments.push({ name: file.name, type: file.type, data: data, isImage: true });
      } else if (data) {
        // Try more aggressive compression
        showToast('\u26a0 \u5716\u7247\u904e\u5927\uff0c\u5df2\u58d3\u7e2e');
        pendingAttachments.push({ name: file.name, type: file.type, data: data, isImage: true });
      }
    } else {
      const data = await fileToBase64(file);
      if (data && data.length <= MAX_FILE_B64 * 4) {
        pendingAttachments.push({ name: file.name, type: file.type, data: data, isImage: false });
      } else {
        showToast('\u26a0 ' + file.name + ' \u6a94\u6848\u904e\u5927');
      }
    }
  }
  renderAttachPreviews();
}

function renderAttachPreviews() {
  const container = $('#attachPreviews');
  if (!container) return;
  container.innerHTML = '';
  pendingAttachments.forEach((att, i) => {
    const div = document.createElement('div');
    div.className = 'attach-preview';
    if (att.isImage) {
      div.innerHTML = '<img src="' + att.data + '" alt="' + escHtml(att.name) + '">' +
        '<button class="remove-attach" data-idx="' + i + '"><i class="fa-solid fa-xmark"></i></button>';
    } else {
      div.innerHTML = '<div class="file-icon"><i class="fa-solid ' + getFileIcon(att.name) + '"></i><span>' + escHtml(att.name) + '</span></div>' +
        '<button class="remove-attach" data-idx="' + i + '"><i class="fa-solid fa-xmark"></i></button>';
    }
    container.appendChild(div);
  });
  container.querySelectorAll('.remove-attach').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const idx = parseInt(btn.dataset.idx, 10);
      pendingAttachments.splice(idx, 1);
      renderAttachPreviews();
    });
  });
}

function initAttachInput() {
  const input = $('#attachInput');
  if (!input) return;
  input.addEventListener('change', () => {
    if (input.files && input.files.length > 0) {
      processFiles(Array.from(input.files));
      input.value = '';
    }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Lightbox
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openLightbox(images, startIdx) {
  lightboxImages = images;
  lightboxIndex = startIdx || 0;
  updateLightbox();
  $('#lightboxOverlay').classList.add('open');
}

function closeLightbox() {
  $('#lightboxOverlay').classList.remove('open');
}

function updateLightbox() {
  const item = lightboxImages[lightboxIndex];
  if (!item) return;
  $('#lightboxImg').src = item.data;
  $('#lightboxCounter').textContent = (lightboxIndex + 1) + ' / ' + lightboxImages.length;
  $('#lightboxFilename').textContent = item.name || '';
  $('#lightboxPrev').style.visibility = lightboxIndex > 0 ? 'visible' : 'hidden';
  $('#lightboxNext').style.visibility = lightboxIndex < lightboxImages.length - 1 ? 'visible' : 'hidden';
}

function initLightbox() {
  $('#lightboxClose').addEventListener('click', closeLightbox);
  $('#lightboxOverlay').addEventListener('click', (e) => {
    if (e.target === $('#lightboxOverlay')) closeLightbox();
  });
  $('#lightboxPrev').addEventListener('click', (e) => {
    e.stopPropagation();
    if (lightboxIndex > 0) { lightboxIndex--; updateLightbox(); }
  });
  $('#lightboxNext').addEventListener('click', (e) => {
    e.stopPropagation();
    if (lightboxIndex < lightboxImages.length - 1) { lightboxIndex++; updateLightbox(); }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Render
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getCat(id) { return CATEGORIES.find(c => c.id === id) || CATEGORIES[6]; }

function formatDate(d) {
  if (!d) return '';
  const dt = new Date(d + 'T00:00:00');
  return (dt.getMonth() + 1) + '\u6708' + dt.getDate() + '\u65e5';
}

function updateStats() {
  const total = tasks.length;
  const done = tasks.filter(t => t.done).length;
  const pending = total - done;
  const pct = total ? Math.round(done / total * 100) : 0;
  $('#statTotal').textContent = total;
  $('#statPending').textContent = pending;
  $('#statDone').textContent = done;
  $('#progressFill').style.width = pct + '%';
  $('#progressText').textContent = pct + '% \u5b8c\u6210';
}

function renderFilters() {
  let html = '<button class="filter-btn active" data-cat="all">\u5168\u90e8</button>';
  for (const c of CATEGORIES) {
    html += '<button class="filter-btn" data-cat="' + c.id + '"><i class="fa-solid ' + c.icon + '"></i> ' + c.name + '</button>';
  }
  filtersEl.innerHTML = html;
  filtersEl.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      activeFilter = btn.dataset.cat;
      filtersEl.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b === btn));
      renderTasks();
    });
  });
}

function renderTasks() {
  const filtered = activeFilter === 'all' ? tasks : tasks.filter(t => t.cat === activeFilter);

  if (filtered.length === 0) {
    // If Firebase hasn't loaded yet, show loading spinner instead of empty state
    if (!firebaseDataLoaded && firebaseConfig && firebaseConfig.databaseURL) {
      taskListEl.innerHTML = '<div class="empty"><i class="fa-solid fa-spinner fa-spin" style="font-size:1.5rem;color:var(--pink)"></i><p>è¼‰å…¥ä¸­â€¦</p></div>';
    } else {
      taskListEl.innerHTML = '<div class="empty"><i class="fa-regular fa-heart"></i><p>' +
        (tasks.length === 0 ? 'Kiki & Jeff\uff0c\u958b\u59cb\u6dfb\u52a0\u4efb\u52d9\u5427' : '\u6b64\u5206\u985e\u66ab\u7121\u4efb\u52d9') + '</p></div>';
    }
    updateStats();
    return;
  }

  const pendingItems = filtered.filter(t => !t.done).sort((a, b) => {
    if (a.date && b.date) return a.date.localeCompare(b.date);
    if (a.date) return -1;
    if (b.date) return 1;
    return 0;
  });
  const doneItems = filtered.filter(t => t.done);

  let html = '';
  if (pendingItems.length) {
    html += '<div class="task-group-label"><i class="fa-regular fa-clock"></i> \u5f85\u8fa6 (' + pendingItems.length + ')</div>';
    pendingItems.forEach((t, i) => { html += cardHTML(t, i); });
  }
  if (doneItems.length) {
    html += '<div class="task-group-label"><i class="fa-solid fa-heart"></i> \u5df2\u5b8c\u6210 (' + doneItems.length + ')</div>';
    doneItems.forEach((t, i) => { html += cardHTML(t, i + pendingItems.length); });
  }
  taskListEl.innerHTML = html;
  bindTaskEvents();
  updateStats();
}

function cardHTML(t, idx) {
  const cat = getCat(t.cat);
  const checkedClass = t.done ? ' checked' : '';
  const doneClass = t.done ? ' done' : '';
  const dateStr = t.date ? '<span class="task-date"><i class="fa-regular fa-calendar"></i>' + formatDate(t.date) + '</span>' : '';
  const noteStr = t.note ? '<div class="task-note">' + escHtml(t.note) + '</div>' : '';
  const delay = Math.min(idx * 0.04, 0.4);

  // Build attachment thumbnails
  let attachStr = '';
  const atts = t.attachments || [];
  if (atts.length > 0) {
    const images = atts.filter(a => a.isImage);
    const files = atts.filter(a => !a.isImage);
    attachStr = '<div class="task-thumbs">';
    images.forEach((a, i) => {
      attachStr += '<div class="task-thumb" data-task-id="' + t.id + '" data-img-idx="' + i + '"><img src="' + a.data + '" alt="' + escHtml(a.name) + '"></div>';
    });
    files.forEach(a => {
      attachStr += '<div class="task-thumb" title="' + escHtml(a.name) + '"><span class="thumb-file"><i class="fa-solid ' + getFileIcon(a.name) + '"></i></span></div>';
    });
    attachStr += '</div>';
    if (atts.length > 0) {
      attachStr += '<div class="task-attach-count"><i class="fa-solid fa-paperclip"></i> ' + atts.length + ' å€‹é™„ä»¶</div>';
    }
  }

  return '<div class="task-card' + doneClass + '" data-id="' + t.id + '" style="animation-delay:' + delay + 's">' +
    '<div class="ck' + checkedClass + '" data-id="' + t.id + '" role="checkbox" tabindex="0"></div>' +
    '<div class="task-body">' +
      '<div class="task-text">' + escHtml(t.name) + '</div>' +
      noteStr +
      attachStr +
      '<div class="task-meta"><span class="task-cat ' + cat.css + '"><i class="fa-solid ' + cat.icon + '"></i> ' + cat.name + '</span>' + dateStr + '</div>' +
    '</div>' +
    '<div class="task-actions">' +
      '<button class="act-btn edit" data-id="' + t.id + '" aria-label="\u7de8\u8f2f"><i class="fa-solid fa-pen"></i></button>' +
      '<button class="act-btn del" data-id="' + t.id + '" aria-label="\u522a\u9664"><i class="fa-solid fa-trash-can"></i></button>' +
    '</div>' +
  '</div>';
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function bindTaskEvents() {
  taskListEl.querySelectorAll('.ck').forEach(el => {
    el.addEventListener('click', () => toggleDone(el.dataset.id));
    el.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleDone(el.dataset.id); }
    });
  });
  taskListEl.querySelectorAll('.act-btn.edit').forEach(el => {
    el.addEventListener('click', () => openEdit(el.dataset.id));
  });
  taskListEl.querySelectorAll('.act-btn.del').forEach(el => {
    el.addEventListener('click', () => askDelete(el.dataset.id));
  });
  // Lightbox for task image thumbnails
  taskListEl.querySelectorAll('.task-thumb[data-task-id]').forEach(el => {
    el.addEventListener('click', () => {
      const taskId = el.dataset.taskId;
      const imgIdx = parseInt(el.dataset.imgIdx, 10);
      const t = tasks.find(x => x.id === taskId);
      if (!t || !t.attachments) return;
      const images = t.attachments.filter(a => a.isImage);
      if (images.length > 0) openLightbox(images, imgIdx);
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CRUD (synced to Firebase)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleDone(id) {
  const t = tasks.find(x => x.id === id);
  if (!t) return;
  t.done = !t.done;
  saveTaskToCloud(id, taskData(t));
  showToast(t.done ? '\u2665 \u5df2\u5b8c\u6210' : '\u21a9 \u5df2\u6062\u5fa9');
}

function taskData(t) {
  const d = { name: t.name, cat: t.cat, done: t.done, note: t.note || '', date: t.date || '', createdBy: t.createdBy || myName, ts: t.ts || Date.now() };
  if (t.attachments && t.attachments.length > 0) {
    d.attachments = t.attachments;
  }
  return d;
}

function openAdd() {
  editingId = null;
  pendingAttachments = [];
  $('#modalTitle').innerHTML = '<i class="fa-solid fa-heart"></i> \u65b0\u589e\u4efb\u52d9';
  $('#inputName').value = '';
  $('#inputNote').value = '';
  $('#inputCat').value = 'other';
  $('#inputDate').value = '';
  $('#btnSave').textContent = '\u65b0\u589e';
  renderAttachPreviews();
  modalOverlay.classList.add('open');
  setTimeout(() => $('#inputName').focus(), 350);
}

function openEdit(id) {
  const t = tasks.find(x => x.id === id);
  if (!t) return;
  editingId = id;
  pendingAttachments = t.attachments ? t.attachments.map(a => ({...a})) : [];
  $('#modalTitle').innerHTML = '<i class="fa-solid fa-pen"></i> \u7de8\u8f2f\u4efb\u52d9';
  $('#inputName').value = t.name;
  $('#inputNote').value = t.note || '';
  $('#inputCat').value = t.cat;
  $('#inputDate').value = t.date || '';
  $('#btnSave').textContent = '\u5132\u5b58';
  renderAttachPreviews();
  modalOverlay.classList.add('open');
  setTimeout(() => $('#inputName').focus(), 350);
}

function saveTask() {
  const name = $('#inputName').value.trim();
  if (!name) { $('#inputName').style.borderColor = 'var(--danger)'; return; }
  const cat = $('#inputCat').value;
  const note = $('#inputNote').value.trim();
  const date = $('#inputDate').value;
  const attachments = pendingAttachments.length > 0 ? pendingAttachments.slice() : null;

  if (editingId !== null) {
    const t = tasks.find(x => x.id === editingId);
    if (t) {
      t.name = name; t.cat = cat; t.note = note; t.date = date;
      t.attachments = attachments || [];
      saveTaskToCloud(editingId, taskData(t));
    }
    showToast('\u2665 \u5df2\u66f4\u65b0');
  } else {
    const key = 'task_' + Date.now();
    const newTask = { name: name, cat: cat, done: false, note: note, date: date, createdBy: myName, ts: Date.now() };
    if (attachments) newTask.attachments = attachments;
    saveTaskToCloud(key, newTask);
    showToast('\u2665 \u5df2\u65b0\u589e');
  }
  pendingAttachments = [];
  closeModal();
}

function askDelete(id) {
  pendingDeleteId = id;
  const t = tasks.find(x => x.id === id);
  $('#confirmMsg').textContent = '\u78ba\u5b9a\u8981\u522a\u9664\u300c' + (t ? t.name : '') + '\u300d\uff1f';
  confirmOvl.classList.add('open');
}

function doDelete() {
  if (pendingDeleteId !== null) {
    removeTaskFromCloud(pendingDeleteId);
    showToast('\u5df2\u522a\u9664');
  }
  pendingDeleteId = null;
  confirmOvl.classList.remove('open');
}

function closeModal() { modalOverlay.classList.remove('open'); editingId = null; pendingAttachments = []; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Toast
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let toastTimer;
function showToast(msg, longer) {
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toastEl.classList.remove('show'), longer ? 6000 : 1800);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Settings (reset config)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
$('#settingsBtn').addEventListener('click', () => {
  // Show confirm to switch user (keeps PIN, just resets name)
  pendingDeleteId = null;
  $('#confirmMsg').textContent = 'è¦åˆ‡æ›ç”¨æˆ¶å—ï¼Ÿ';
  $('#confirmYes').textContent = 'åˆ‡æ›';
  $('#confirmYes').className = 'btn btn-primary';
  confirmOvl.classList.add('open');
  const origHandler = doDelete;
  const resetHandler = () => {
    store.del('v2_name');
    myName = '';
    isFirebaseReady = false;
    firebaseListenerAttached = false;
    firebaseDataLoaded = false;
    showScreen('setupScreen');
  };
  $('#confirmYes').onclick = () => { confirmOvl.classList.remove('open'); $('#confirmYes').className = 'btn btn-danger'; resetHandler(); };
  $('#confirmNo').onclick = () => {
    confirmOvl.classList.remove('open');
    $('#confirmYes').textContent = '\u522a\u9664';
    $('#confirmYes').className = 'btn btn-danger';
    $('#confirmYes').onclick = origHandler;
  };
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Init App
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initApp() {
  initCatSelect();
  renderFilters();
  initPhotoUpload();
  initAttachInput();
  initLightbox();

  $('#fabAdd').addEventListener('click', openAdd);
  $('#btnCancel').addEventListener('click', closeModal);
  $('#btnSave').addEventListener('click', saveTask);
  $('#confirmNo').addEventListener('click', () => { confirmOvl.classList.remove('open'); });
  $('#confirmYes').addEventListener('click', doDelete);
  modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) closeModal(); });
  confirmOvl.addEventListener('click', e => { if (e.target === confirmOvl) confirmOvl.classList.remove('open'); });
  $('#inputName').addEventListener('keydown', e => { if (e.key === 'Enter') saveTask(); });
  $('#inputName').addEventListener('input', () => { $('#inputName').style.borderColor = ''; });
}

function initCatSelect() {
  const sel = $('#inputCat');
  if (sel) sel.innerHTML = CATEGORIES.map(c => '<option value="' + c.id + '">' + c.name + '</option>').join('');
}
</script>
</body>
</html>
